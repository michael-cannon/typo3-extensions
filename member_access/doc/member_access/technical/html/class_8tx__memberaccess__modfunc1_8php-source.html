<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>BPM Membership Access: My Documents/bus/proj/cannonbose/bpm/membershipaccess/docs/member_access/technical/code/class.tx_memberaccess_modfunc1.php Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">technical</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_000001.html">code</a></div>
<h1>class.tx_memberaccess_modfunc1.php</h1><a href="class_8tx__memberaccess__modfunc1_8php.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00002"></a>00002 <span class="comment">/***************************************************************</span>
<a name="l00003"></a>00003 <span class="comment">*  Copyright notice</span>
<a name="l00004"></a>00004 <span class="comment">*  </span>
<a name="l00005"></a>00005 <span class="comment">*  (c) 2004  ()</span>
<a name="l00006"></a>00006 <span class="comment">*  All rights reserved</span>
<a name="l00007"></a>00007 <span class="comment">*</span>
<a name="l00008"></a>00008 <span class="comment">*  This script is part of the TYPO3 project. The TYPO3 project is </span>
<a name="l00009"></a>00009 <span class="comment">*  free software; you can redistribute it and/or modify</span>
<a name="l00010"></a>00010 <span class="comment">*  it under the terms of the GNU General Public License as published by</span>
<a name="l00011"></a>00011 <span class="comment">*  the Free Software Foundation; either version 2 of the License, or</span>
<a name="l00012"></a>00012 <span class="comment">*  (at your option) any later version.</span>
<a name="l00013"></a>00013 <span class="comment">* </span>
<a name="l00014"></a>00014 <span class="comment">*  The GNU General Public License can be found at</span>
<a name="l00015"></a>00015 <span class="comment">*  http://www.gnu.org/copyleft/gpl.html.</span>
<a name="l00016"></a>00016 <span class="comment">* </span>
<a name="l00017"></a>00017 <span class="comment">*  This script is distributed in the hope that it will be useful,</span>
<a name="l00018"></a>00018 <span class="comment">*  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00019"></a>00019 <span class="comment">*  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00020"></a>00020 <span class="comment">*  GNU General Public License for more details.</span>
<a name="l00021"></a>00021 <span class="comment">*</span>
<a name="l00022"></a>00022 <span class="comment">*  This copyright notice MUST APPEAR in all copies of the script!</span>
<a name="l00023"></a>00023 <span class="comment">***************************************************************/</span>
<a name="l00033"></a>00033 require_once(PATH_t3lib.<span class="stringliteral">"class.t3lib_extobjbase.php"</span>);
<a name="l00034"></a>00034 
<a name="l00035"></a>00035 <span class="comment">// download helper</span>
<a name="l00036"></a>00036 require_once( CB_COGS_DIR . 'cb_html.php' );
<a name="l00037"></a>00037 
<a name="l00067"></a><a class="code" href="classtx__memberaccess__modfunc1.html">00067</a> <span class="keyword">class </span><a class="code" href="classtx__memberaccess__modfunc1.html">tx_memberaccess_modfunc1</a> <span class="keyword">extends</span> t3lib_extobjbase {
<a name="l00068"></a>00068 
<a name="l00069"></a>00069         <span class="comment">//global database pointer</span>
<a name="l00070"></a><a class="code" href="classtx__memberaccess__modfunc1.html#o1">00070</a>         var <a class="code" href="classtx__memberaccess__modfunc1.html#o1">$db</a>;
<a name="l00071"></a>00071         
<a name="l00072"></a><a class="code" href="classtx__memberaccess__modfunc1.html#o2">00072</a>         var <a class="code" href="classtx__memberaccess__modfunc1.html#o2">$debug</a> = <span class="keyword">false</span>; <span class="comment">//turn on/off debug output</span>
<a name="l00073"></a>00073         
<a name="l00074"></a>00074         <span class="comment">// default size for HTML form element input box</span>
<a name="l00075"></a><a class="code" href="classtx__memberaccess__modfunc1.html#o4">00075</a>         var <a class="code" href="classtx__memberaccess__modfunc1.html#o4">$inputSize</a> = 20;
<a name="l00076"></a>00076         
<a name="l00077"></a>00077         <span class="comment">//aliases for fields E.g., "endtime AS expiredate"</span>
<a name="l00078"></a><a class="code" href="classtx__memberaccess__modfunc1.html#o3">00078</a>         var <a class="code" href="classtx__memberaccess__modfunc1.html#o3">$fieldAlias_usergroup</a> = 'accesslevel';
<a name="l00079"></a>00079         
<a name="l00080"></a>00080         <span class="comment">//name of the table containing the access control entries</span>
<a name="l00081"></a><a class="code" href="classtx__memberaccess__modfunc1.html#o5">00081</a>         var <a class="code" href="classtx__memberaccess__modfunc1.html#o5">$table_member_acl</a> = 'tx_memberaccess_acl';
<a name="l00082"></a>00082         
<a name="l00083"></a>00083         <span class="comment">//The position of the email field in the uploaded data rows.</span>
<a name="l00084"></a>00084         <span class="comment">//starting with first index==0</span>
<a name="l00085"></a><a class="code" href="classtx__memberaccess__modfunc1.html#o9">00085</a>         var <a class="code" href="classtx__memberaccess__modfunc1.html#o9">$uploadedDataFieldPositionName</a> = 0;
<a name="l00086"></a><a class="code" href="classtx__memberaccess__modfunc1.html#o7">00086</a>         var <a class="code" href="classtx__memberaccess__modfunc1.html#o7">$uploadedDataFieldPositionCompany</a> = 1;
<a name="l00087"></a><a class="code" href="classtx__memberaccess__modfunc1.html#o8">00087</a>         var <a class="code" href="classtx__memberaccess__modfunc1.html#o8">$uploadedDataFieldPositionEmail</a> = 2;
<a name="l00088"></a><a class="code" href="classtx__memberaccess__modfunc1.html#o6">00088</a>         var <a class="code" href="classtx__memberaccess__modfunc1.html#o6">$uploadedDataFieldPositionAccessLevel</a> = 3;
<a name="l00089"></a>00089         
<a name="l00090"></a>00090         <span class="comment">//access list is cached here after reading it from the table identified in</span>
<a name="l00091"></a>00091         <span class="comment">// $table_member_acl </span>
<a name="l00092"></a><a class="code" href="classtx__memberaccess__modfunc1.html#o0">00092</a>         var <a class="code" href="classtx__memberaccess__modfunc1.html#o0">$accessListCache</a>;
<a name="l00093"></a>00093         
<a name="l00094"></a><a class="code" href="classtx__memberaccess__modfunc1.html#a18">00094</a>         function <a class="code" href="classtx__memberaccess__modfunc1.html#a18">modMenu</a>()      {
<a name="l00095"></a>00095                 global $LANG;
<a name="l00096"></a>00096                 
<a name="l00097"></a>00097                 <span class="keywordflow">return</span> Array (
<a name="l00098"></a>00098                         <span class="stringliteral">"tx_memberaccess_modfunc1_check"</span> =&gt; <span class="stringliteral">""</span>,
<a name="l00099"></a>00099                 );              
<a name="l00100"></a>00100         }
<a name="l00101"></a>00101 
<a name="l00107"></a><a class="code" href="classtx__memberaccess__modfunc1.html#a17">00107</a>         function <a class="code" href="classtx__memberaccess__modfunc1.html#a17">main</a>() {
<a name="l00108"></a>00108                 <span class="comment">// Initializes the module. Done in this function because we may need to re-initialize if data is submitted!</span>
<a name="l00109"></a>00109                 global $SOBE,$BE_USER,$LANG,$BACK_PATH,$TCA_DESCR,$TCA,$CLIENT,$TYPO3_CONF_VARS;
<a name="l00110"></a>00110                 
<a name="l00111"></a>00111                 $this-&gt;db                = $GLOBALS['TYPO3_DB'];
<a name="l00112"></a>00112                 $theOutput.=$this-&gt;pObj-&gt;doc-&gt;spacer(5);
<a name="l00113"></a>00113                 $theOutput.=$this-&gt;pObj-&gt;doc-&gt;section($LANG-&gt;getLL(<span class="stringliteral">"title"</span>),$LANG-&gt;getLL('description'),0,1);
<a name="l00114"></a>00114                 
<a name="l00115"></a>00115                 
<a name="l00116"></a>00116                 <span class="comment">//Otherwise, display the upload/download form.</span>
<a name="l00117"></a>00117                 <span class="comment">//This is displayed regardless of whether anything else is currently displaying or not.</span>
<a name="l00118"></a>00118                 <span class="comment">//If this is the first go-around, this is the only thing that will be displayed.</span>
<a name="l00119"></a>00119                 $theOutput .= $this-&gt;<a class="code" href="classtx__memberaccess__modfunc1.html#a20">showForm</a>();
<a name="l00120"></a>00120                 
<a name="l00121"></a>00121                 <span class="comment">// If this is the 2nd go-around and the user has clicked a button, a GET or POST</span>
<a name="l00122"></a>00122                 <span class="comment">// variable will be set telling us what to do.  Here we check for these variables</span>
<a name="l00123"></a>00123                 <span class="comment">// and act accordingly.</span>
<a name="l00124"></a>00124                 
<a name="l00125"></a>00125                 <span class="comment">// first, cache the GET/POST option value variables</span>
<a name="l00126"></a>00126                 $this-&gt;<a class="code" href="classtx__memberaccess__modfunc1.html#a19">setValues</a>();
<a name="l00127"></a>00127                 
<a name="l00128"></a>00128                 <span class="comment">// check for update/display command for access list</span>
<a name="l00129"></a>00129                 <span class="keywordflow">if</span> ( t3lib_div::_GP( 'tx_memberaccess_modfunc1_accesstool_command_updatedisplay' ) )
<a name="l00130"></a>00130                 {
<a name="l00131"></a>00131                         <span class="keywordflow">if</span> ($this-&gt;debug) echo 'tx_memberaccess_modfunc1_accesstool_command_updatedisplay&lt;br&gt;';
<a name="l00132"></a>00132                         $theOutput .= $this-&gt;<a class="code" href="classtx__memberaccess__modfunc1.html#a5">doUpdateDisplay</a>( 'tx_memberaccess_modfunc1_accesstool_command_updatedisplay' );
<a name="l00133"></a>00133                 }
<a name="l00134"></a>00134                 
<a name="l00135"></a>00135                 <span class="comment">// check for download command(s) (download current access list)</span>
<a name="l00136"></a>00136                 <span class="keywordflow">if</span> ( t3lib_div::_GP( 'tx_memberaccess_modfunc1_accesstool_command_download_reporting' ) ) {
<a name="l00137"></a>00137                         $theOutput .= $this-&gt;<a class="code" href="classtx__memberaccess__modfunc1.html#a4">doDownload</a>( 'tx_memberaccess_modfunc1_accesstool_command_download_reporting' );
<a name="l00138"></a>00138                 }
<a name="l00139"></a>00139                 <span class="keywordflow">if</span> ( t3lib_div::_GP( 'tx_memberaccess_modfunc1_accesstool_command_download_aclmodification' ) ) {
<a name="l00140"></a>00140                         $theOutput .= $this-&gt;<a class="code" href="classtx__memberaccess__modfunc1.html#a4">doDownload</a>( 'tx_memberaccess_modfunc1_accesstool_command_download_aclmodification' );
<a name="l00141"></a>00141                 }
<a name="l00142"></a>00142                 
<a name="l00143"></a>00143                 <span class="keywordflow">return</span> $theOutput;
<a name="l00144"></a>00144         }
<a name="l00145"></a>00145         
<a name="l00146"></a>00146 
<a name="l00152"></a><a class="code" href="classtx__memberaccess__modfunc1.html#a20">00152</a>         function <a class="code" href="classtx__memberaccess__modfunc1.html#a20">showForm</a>()
<a name="l00153"></a>00153         {
<a name="l00154"></a>00154                 $output = '';
<a name="l00155"></a>00155                 
<a name="l00156"></a>00156                 $output .= $this-&gt;<a class="code" href="classtx__memberaccess__modfunc1.html#a22">showFormUpload</a>();
<a name="l00157"></a>00157                 $output .= $this-&gt;<a class="code" href="classtx__memberaccess__modfunc1.html#a21">showFormDownload</a>();
<a name="l00158"></a>00158                 
<a name="l00159"></a>00159                 <span class="keywordflow">return</span> $output;
<a name="l00160"></a>00160         }
<a name="l00161"></a>00161 
<a name="l00166"></a><a class="code" href="classtx__memberaccess__modfunc1.html#a22">00166</a>         function <a class="code" href="classtx__memberaccess__modfunc1.html#a22">showFormUpload</a>()
<a name="l00167"></a>00167         {
<a name="l00168"></a>00168                 global $LANG;
<a name="l00169"></a>00169                 $output = '';
<a name="l00170"></a>00170                 
<a name="l00171"></a>00171                 $break                                          = '&lt;br /&gt;';
<a name="l00172"></a>00172                 
<a name="l00173"></a>00173                 $title                                          = $this-&gt;pObj-&gt;doc-&gt;section( 
<a name="l00174"></a>00174                                                                                 $LANG-&gt;getLL('form.upload.sectiontitle')
<a name="l00175"></a>00175                                                                                 , $LANG-&gt;getLL('form.upload.helptext')
<a name="l00176"></a>00176                                                                                 , 0
<a name="l00177"></a>00177                                                                                 , 1
<a name="l00178"></a>00178                                                                                 );
<a name="l00179"></a>00179                                                                                 
<a name="l00180"></a>00180                 <span class="comment">//The access list text input box. Show blank (i.e. don't show prev. data if user already pushed Submit)</span>
<a name="l00181"></a>00181                 $accesslist                                     = $this-&gt;pObj-&gt;doc-&gt;section(
<a name="l00182"></a>00182                                                                                 $LANG-&gt;getLL('form.upload.accesslist.caption')
<a name="l00183"></a>00183                                                                                 , $this-&gt;getFormElementAccesslist('tx_memberaccess_modfunc1_accesstool_form_accesslist', '')
<a name="l00184"></a>00184                                                                                 , 1
<a name="l00185"></a>00185                                                                                 );
<a name="l00186"></a>00186 
<a name="l00187"></a>00187                 <span class="comment">//This is a static table of the most relevant user groups/codes to assist people in entering accesslevel codes </span>
<a name="l00188"></a>00188                 $helperTable                            = $this-&gt;<a class="code" href="classtx__memberaccess__modfunc1.html#a13">getFormElementUserGroupHelperTable</a>('tx_memberaccess_modfunc1_accesstool_form_usergrouphelpertable');                                                                           
<a name="l00189"></a>00189                                                                                 
<a name="l00190"></a>00190                 <span class="comment">//Upload button</span>
<a name="l00191"></a>00191                 $submit                    = '&lt;input type=<span class="stringliteral">"submit"</span>
<a name="l00192"></a>00192                                                                                 name=<span class="stringliteral">"tx_memberaccess_modfunc1_accesstool_command_updatedisplay"</span>
<a name="l00193"></a>00193                                                                                 value=<span class="stringliteral">"'</span>
<a name="l00194"></a>00194 <span class="stringliteral">                                                                        . $LANG-&gt;getLL( 'form.upload.options.display.buttontext' )</span>
<a name="l00195"></a>00195 <span class="stringliteral">                                                                        . '"</span> /&gt;';
<a name="l00196"></a>00196 
<a name="l00197"></a>00197                 <span class="comment">//assemble the form elements in order</span>
<a name="l00198"></a>00198                 $output .= $title
<a name="l00199"></a>00199                                         . $this-&gt;pObj-&gt;doc-&gt;spacer(5)
<a name="l00200"></a>00200                                         . $accesslist
<a name="l00201"></a>00201                                         . $this-&gt;pObj-&gt;doc-&gt;spacer(5)
<a name="l00202"></a>00202                                         . $helperTable
<a name="l00203"></a>00203                                         . $this-&gt;pObj-&gt;doc-&gt;spacer(5)
<a name="l00204"></a>00204                                         . $submit;
<a name="l00205"></a>00205                 <span class="keywordflow">return</span> $output;
<a name="l00206"></a>00206                 
<a name="l00207"></a>00207         }
<a name="l00208"></a>00208 
<a name="l00216"></a><a class="code" href="classtx__memberaccess__modfunc1.html#a12">00216</a>         function <a class="code" href="classtx__memberaccess__modfunc1.html#a12">getFormElementAccessList</a> ( $fieldname, $value='' )
<a name="l00217"></a>00217         {
<a name="l00218"></a>00218                 $rows = 20;
<a name="l00219"></a>00219                 $columns = 85;
<a name="l00220"></a>00220                 
<a name="l00221"></a>00221                 $string                    = 
<a name="l00222"></a>00222                         '&lt;textarea '
<a name="l00223"></a>00223                                 .' name=<span class="stringliteral">"' . $fieldname . '"</span>'
<a name="l00224"></a>00224                                 .' rows=<span class="stringliteral">"' . $rows .'"</span>' 
<a name="l00225"></a>00225                                 .' cols=<span class="stringliteral">"' . $columns .'"</span>' 
<a name="l00226"></a>00226                                 .' &gt;' . $value   
<a name="l00227"></a>00227                                 .'&lt;/textarea&gt;'
<a name="l00228"></a>00228                 ;
<a name="l00229"></a>00229 
<a name="l00230"></a>00230                 <span class="keywordflow">return</span> $string;
<a name="l00231"></a>00231         }
<a name="l00232"></a>00232         
<a name="l00233"></a>00233 
<a name="l00241"></a><a class="code" href="classtx__memberaccess__modfunc1.html#a13">00241</a>         function <a class="code" href="classtx__memberaccess__modfunc1.html#a13">getFormElementUserGroupHelperTable</a> ( $elementName )
<a name="l00242"></a>00242         {
<a name="l00243"></a>00243                 $rows = 20;
<a name="l00244"></a>00244                 $columns = 85;
<a name="l00245"></a>00245                 global $LANG;
<a name="l00246"></a>00246                 
<a name="l00247"></a>00247                 $string                    = $LANG-&gt;getLL('form.upload.helptext2');
<a name="l00248"></a>00248 
<a name="l00249"></a>00249                 <span class="keywordflow">return</span> $string;
<a name="l00250"></a>00250         }
<a name="l00251"></a>00251         
<a name="l00252"></a>00252 
<a name="l00257"></a><a class="code" href="classtx__memberaccess__modfunc1.html#a21">00257</a>         function <a class="code" href="classtx__memberaccess__modfunc1.html#a21">showFormDownload</a>()
<a name="l00258"></a>00258         {
<a name="l00259"></a>00259                 global $LANG;
<a name="l00260"></a>00260                 $output = '';
<a name="l00261"></a>00261                 
<a name="l00262"></a>00262                 $break                                          = '&lt;br /&gt;';
<a name="l00263"></a>00263                 
<a name="l00264"></a>00264                 $title                                          = $this-&gt;pObj-&gt;doc-&gt;section( 
<a name="l00265"></a>00265                                                                                 $LANG-&gt;getLL('form.download.sectiontitle')
<a name="l00266"></a>00266                                                                                 , $LANG-&gt;getLL('form.download.helptext')
<a name="l00267"></a>00267                                                                                 , 0
<a name="l00268"></a>00268                                                                                 , 1
<a name="l00269"></a>00269                                                                                 );
<a name="l00270"></a>00270                                                                                 
<a name="l00271"></a>00271                                                                                 
<a name="l00272"></a>00272                 <span class="comment">//Download buttons</span>
<a name="l00273"></a>00273                 $buttonDownloadForReporting = '&lt;input type=<span class="stringliteral">"submit"</span>
<a name="l00274"></a>00274                                                                                 name=<span class="stringliteral">"tx_memberaccess_modfunc1_accesstool_command_download_reporting"</span>
<a name="l00275"></a>00275                                                                                 value=<span class="stringliteral">"'</span>
<a name="l00276"></a>00276 <span class="stringliteral">                                                                        . $LANG-&gt;getLL( 'form.download.options.button.reporting.buttontext' )</span>
<a name="l00277"></a>00277 <span class="stringliteral">                                                                        . '"</span> /&gt;';
<a name="l00278"></a>00278 
<a name="l00279"></a>00279                                                                                         <span class="comment">//Download button</span>
<a name="l00280"></a>00280                 $buttonDownloadForACLModification = '&lt;input type=<span class="stringliteral">"submit"</span>
<a name="l00281"></a>00281                                                                                 name=<span class="stringliteral">"tx_memberaccess_modfunc1_accesstool_command_download_aclmodification"</span>
<a name="l00282"></a>00282                                                                                 value=<span class="stringliteral">"'</span>
<a name="l00283"></a>00283 <span class="stringliteral">                                                                        . $LANG-&gt;getLL( 'form.download.options.button.aclmodification.buttontext' )</span>
<a name="l00284"></a>00284 <span class="stringliteral">                                                                        . '"</span> /&gt;';
<a name="l00285"></a>00285 
<a name="l00286"></a>00286                 <span class="comment">//assemble the form elements in order</span>
<a name="l00287"></a>00287                 $output         .= $title
<a name="l00288"></a>00288                                         . $this-&gt;pObj-&gt;doc-&gt;spacer(5)
<a name="l00289"></a>00289                                         . $buttonDownloadForReporting
<a name="l00290"></a>00290                                         . $buttonDownloadForACLModification
<a name="l00291"></a>00291                                         ;
<a name="l00292"></a>00292                 <span class="keywordflow">return</span> $output;
<a name="l00293"></a>00293                 
<a name="l00294"></a>00294         }
<a name="l00295"></a>00295 
<a name="l00296"></a>00296 
<a name="l00316"></a><a class="code" href="classtx__memberaccess__modfunc1.html#a5">00316</a>         function <a class="code" href="classtx__memberaccess__modfunc1.html#a5">doUpdateDisplay</a>( $what )
<a name="l00317"></a>00317         {
<a name="l00318"></a>00318                 <span class="keywordflow">if</span> ($this-&gt;debug) {
<a name="l00319"></a>00319                         echo '<a class="code" href="classtx__memberaccess__modfunc1.html#a5">doUpdateDisplay</a>()';
<a name="l00320"></a>00320                         $this-&gt;<a class="code" href="classtx__memberaccess__modfunc1.html#a24">testAccessLevel</a>();
<a name="l00321"></a>00321                         $this-&gt;db-&gt;debugOutput = <span class="keyword">true</span>;
<a name="l00322"></a>00322                 }
<a name="l00323"></a>00323                 
<a name="l00324"></a>00324                 $output = '';
<a name="l00325"></a>00325                 
<a name="l00326"></a>00326                 <span class="keywordflow">if</span> ('tx_memberaccess_modfunc1_accesstool_command_updatedisplay' == $what) {
<a name="l00327"></a>00327                         $this-&gt;<a class="code" href="classtx__memberaccess__modfunc1.html#a25">updateAccessList</a>();
<a name="l00328"></a>00328                         $this-&gt;<a class="code" href="classtx__memberaccess__modfunc1.html#a26">updateFeUserGroups</a>();
<a name="l00329"></a>00329                         $output .= $this-&gt;<a class="code" href="classtx__memberaccess__modfunc1.html#a3">displayAccessList</a>();
<a name="l00330"></a>00330                 }
<a name="l00331"></a>00331                 
<a name="l00332"></a>00332                 <span class="keywordflow">return</span> $output;
<a name="l00333"></a>00333         }
<a name="l00334"></a>00334 
<a name="l00343"></a><a class="code" href="classtx__memberaccess__modfunc1.html#a25">00343</a>         function <a class="code" href="classtx__memberaccess__modfunc1.html#a25">updateAccessList</a>()
<a name="l00344"></a>00344         {
<a name="l00345"></a>00345                 
<a name="l00346"></a>00346                 $uploadedACL = $this-&gt;<a class="code" href="classtx__memberaccess__modfunc1.html#a14">getPOSTedAccessListAsRowArray</a>();
<a name="l00347"></a>00347                 $replaceQuery = '';
<a name="l00348"></a>00348                 
<a name="l00349"></a>00349                 foreach ($uploadedACL as $row) {
<a name="l00350"></a>00350                         <span class="keywordflow">if</span> ($this-&gt;debug) {
<a name="l00351"></a>00351                                 echo '$row: ';
<a name="l00352"></a>00352                                 print_r ($row);
<a name="l00353"></a>00353                                 echo '&lt;br&gt;';
<a name="l00354"></a>00354                         }
<a name="l00355"></a>00355                         <span class="comment">//if there is a match on email between uploaded acl and the existing acl</span>
<a name="l00356"></a>00356                         
<a name="l00357"></a>00357                         <span class="comment">//get the accesslevel field for the record identified by this email</span>
<a name="l00358"></a>00358                         <span class="comment">//that's already stored in the database (if any) </span>
<a name="l00359"></a>00359                         
<a name="l00360"></a>00360                         $email = $row[$this-&gt;uploadedDataFieldPositionEmail];
<a name="l00361"></a>00361                         $name = $row[$this-&gt;uploadedDataFieldPositionName];
<a name="l00362"></a>00362                         $company = $row[$this-&gt;uploadedDataFieldPositionCompany];
<a name="l00363"></a>00363                         $desiredAccessLevel = trim($row[$this-&gt;uploadedDataFieldPositionAccessLevel]);
<a name="l00364"></a>00364                         
<a name="l00365"></a>00365                         <span class="keywordflow">if</span> ($this-&gt;debug) {
<a name="l00366"></a>00366                                 echo '$row[2]: /' . $email . <span class="charliteral">'/'</span>;
<a name="l00367"></a>00367                         }
<a name="l00368"></a>00368                         
<a name="l00369"></a>00369                         <span class="comment">//To know the existing access level, we have to read the existing</span>
<a name="l00370"></a>00370                         <span class="comment">//Access Control Entry, if any.</span>
<a name="l00371"></a>00371                         $existingAce = $this-&gt;<a class="code" href="classtx__memberaccess__modfunc1.html#a11">getExistingAce</a>($email);
<a name="l00372"></a>00372                         <span class="keywordflow">if</span>(<span class="keyword">false</span>==$existingAce) {
<a name="l00373"></a>00373                                 $currentAccessLevel = '';
<a name="l00374"></a>00374                         } <span class="keywordflow">else</span> {
<a name="l00375"></a>00375                                 $currentAccessLevel = trim($existingAce['accesslevel']);
<a name="l00376"></a>00376                         }
<a name="l00377"></a>00377                         
<a name="l00378"></a>00378                         
<a name="l00379"></a>00379                         <span class="comment">//append any accesslevels present in the uploaded ace not present in the existing ace </span>
<a name="l00380"></a>00380                         <span class="comment">//appendAce</span>
<a name="l00381"></a>00381                         $newAccessLevel = $this-&gt;<a class="code" href="classtx__memberaccess__modfunc1.html#a0">appendAccessLevel</a>( strval($currentAccessLevel), strval($desiredAccessLevel) );
<a name="l00382"></a>00382                         <span class="keywordflow">if</span> ($this-&gt;debug) {
<a name="l00383"></a>00383                                 echo '$newAccessLevel /' . $newAccessLevel . '/&lt;br&gt;';
<a name="l00384"></a>00384                         }
<a name="l00385"></a>00385                         
<a name="l00386"></a>00386                         <span class="comment">//build REPLACE INTO query</span>
<a name="l00387"></a>00387                         <span class="comment">//note: this depends on there being a unique index on email on this table.</span>
<a name="l00388"></a>00388                         <span class="comment">//REPLACE INTO $table_member_acl</span>
<a name="l00389"></a>00389                         <span class="comment">//SET email = '$email', name = '$name', company = '$company', accesslevel='$accesslevel'</span>
<a name="l00390"></a>00390                         <span class="comment">//For some reason, PHP doesn't want to execute multiple REPLACE queries all at once,</span>
<a name="l00391"></a>00391                         <span class="comment">//even though phpmyadmin will gladly execute the query if the same query string is cut and</span>
<a name="l00392"></a>00392                         <span class="comment">//pasted into it.</span>
<a name="l00393"></a>00393                         <span class="comment">//So instead of building one big REPLACE INTO query, we execute 1 query for every</span>
<a name="l00394"></a>00394                         <span class="comment">//acl row (which could be 500 some rows).</span>
<a name="l00395"></a>00395                         $replaceQuery = <span class="stringliteral">" REPLACE INTO $this-&gt;table_member_acl"</span>
<a name="l00396"></a>00396                                                         . <span class="stringliteral">" SET email = \"$email\", name = \"$name\","</span> 
<a name="l00397"></a>00397                                                         . <span class="stringliteral">" company = \"$company\", accesslevel=\"$newAccessLevel\" ; "</span>;
<a name="l00398"></a>00398                         <span class="comment">//execute the replace query</span>
<a name="l00399"></a>00399                         $result = $this-&gt;db-&gt;sql_query( trim($replaceQuery) );
<a name="l00400"></a>00400                         <span class="keywordflow">if</span> ($this-&gt;debug) {
<a name="l00401"></a>00401                                 echo $replaceQuery;
<a name="l00402"></a>00402                                 echo '&lt;br&gt;Query result:/' ; var_dump($result); echo <span class="charliteral">'/'</span>;
<a name="l00403"></a>00403                                 echo '&lt;br&gt;Affected rows:' . mysql_affected_rows();
<a name="l00404"></a>00404                         }
<a name="l00405"></a>00405                         
<a name="l00406"></a>00406                 }
<a name="l00407"></a>00407                 
<a name="l00408"></a>00408                 <span class="keywordflow">if</span> ($this-&gt;debug &amp;&amp; <span class="keyword">false</span>) {
<a name="l00409"></a>00409                         echo $replaceQuery;
<a name="l00410"></a>00410                         echo 'Query result:/' ; var_dump($result); echo <span class="charliteral">'/'</span>;
<a name="l00411"></a>00411                         echo 'Affected rows:' . mysql_affected_rows();
<a name="l00412"></a>00412                         
<a name="l00413"></a>00413                         <span class="comment">//$testquery = 'INSERT INTO tx_memberaccess_acl(name, company, email, accesslevel) VALUES ("David Hame2rmesh", "ABN AMRO Mort2gagae Group", "david.hamermes2h@abnamro.com", "9");';</span>
<a name="l00414"></a>00414                         $testquery = &lt;&lt;&lt;EOD
<a name="l00415"></a>00415                                 REPLACE INTO tx_memberaccess_acl SET email = <span class="stringliteral">"lod@brainstorm-group.com"</span>, name = <span class="stringliteral">"Linda O'Donnell"</span>, company = <span class="stringliteral">"BrainStorm G2orup, Inc."</span>, accesslevel=<span class="stringliteral">"9,12"</span> ;
<a name="l00416"></a>00416 EOD;
<a name="l00417"></a>00417                         $testquery = &lt;&lt;&lt;EOD
<a name="l00418"></a>00418                                 REPLACE INTO tx_memberaccess_acl SET email = <span class="stringliteral">"lod@brainstorm-group.com"</span>, name = <span class="stringliteral">"Linda O'Donnell"</span>, company = <span class="stringliteral">"BrainStorm G2orup, Inc."</span>, accesslevel=<span class="stringliteral">"9,12"</span> ; 
<a name="l00419"></a>00419                                 REPLACE INTO tx_memberaccess_acl SET email = <span class="stringliteral">"Darryl_Hahn@CSAA.com"</span>, name = <span class="stringliteral">"Darryl H2ahn"</span>, company = <span class="stringliteral">"A2AA"</span>, accesslevel=<span class="stringliteral">"10,19"</span> ;
<a name="l00420"></a>00420 EOD;
<a name="l00421"></a>00421                         $testquery = &lt;&lt;&lt;EOD
<a name="l00422"></a>00422                                 REPLACE INTO tx_memberaccess_acl SET email = <span class="stringliteral">"lod@brainstorm-group.com"</span>, name = <span class="stringliteral">"Linda O'Donnell"</span>, company = <span class="stringliteral">"BrainStorm G2orup, Inc."</span>, accesslevel=<span class="stringliteral">"9,12"</span>  
<a name="l00423"></a>00423                                 REPLACE INTO tx_memberaccess_acl SET email = <span class="stringliteral">"Darryl_Hahn@CSAA.com"</span>, name = <span class="stringliteral">"Darryl H2ahn"</span>, company = <span class="stringliteral">"A2AA"</span>, accesslevel=<span class="stringliteral">"10,19"</span> 
<a name="l00424"></a>00424 EOD;
<a name="l00425"></a>00425 
<a name="l00426"></a>00426                         echo $testquery;
<a name="l00427"></a>00427                         $result=<span class="keyword">false</span>;
<a name="l00428"></a>00428                         <span class="comment">//$result = $this-&gt;db-&gt;sql_query( $testquery );</span>
<a name="l00429"></a>00429                         echo '&lt;br&gt;test Query result:/'; var_dump($result); echo <span class="charliteral">'/'</span>;
<a name="l00430"></a>00430                         echo 'test query Affected rows:' . mysql_affected_rows();
<a name="l00431"></a>00431                         
<a name="l00432"></a>00432                         
<a name="l00433"></a>00433                 }
<a name="l00434"></a>00434                 
<a name="l00435"></a>00435         }
<a name="l00436"></a>00436         
<a name="l00443"></a><a class="code" href="classtx__memberaccess__modfunc1.html#a14">00443</a>         function <a class="code" href="classtx__memberaccess__modfunc1.html#a14">getPOSTedAccessListAsRowArray</a>()
<a name="l00444"></a>00444         {
<a name="l00445"></a>00445                 <span class="comment">//This is a big string with newlines separating the lines, tabs separating the fields</span>
<a name="l00446"></a>00446                 $uploadedACL = t3lib_div::_POST( 'tx_memberaccess_modfunc1_accesstool_form_accesslist' );
<a name="l00447"></a>00447                 
<a name="l00448"></a>00448                 <span class="keywordflow">if</span>($this-&gt;debug) echo $uploadedACL; <span class="comment">//should show a big string</span>
<a name="l00449"></a>00449                 
<a name="l00450"></a>00450                 <span class="comment">//Transform into an array of tab-separated strings</span>
<a name="l00451"></a>00451                 $uploadedACL_array = explode(<span class="stringliteral">"\n"</span>, $uploadedACL);
<a name="l00452"></a>00452                 
<a name="l00453"></a>00453                 <span class="keywordflow">if</span>($this-&gt;debug) echo print_r($uploadedACL_array); <span class="comment">//should show an array</span>
<a name="l00454"></a>00454                 
<a name="l00455"></a>00455                 <span class="comment">//Convert each line to an array, as well</span>
<a name="l00456"></a>00456                 $uploadedACL_rowarray = array();
<a name="l00457"></a>00457                 foreach ($uploadedACL_array as $line) {
<a name="l00458"></a>00458                         <span class="keywordflow">if</span> ($line != '') {
<a name="l00459"></a>00459                                 $row = explode(<span class="stringliteral">"\t"</span>, $line);
<a name="l00460"></a>00460                                 <span class="comment">//only add if the email field isn't blank</span>
<a name="l00461"></a>00461                                 <span class="keywordflow">if</span> ($row[$this-&gt;uploadedDataFieldPositionEmail] != '' ) {
<a name="l00462"></a>00462                                         $uploadedACL_rowarray[] = $row;
<a name="l00463"></a>00463                                 }
<a name="l00464"></a>00464                         }
<a name="l00465"></a>00465                 }
<a name="l00466"></a>00466                 
<a name="l00467"></a>00467                 <span class="keywordflow">return</span> $uploadedACL_rowarray;
<a name="l00468"></a>00468 
<a name="l00469"></a>00469         }
<a name="l00470"></a>00470         
<a name="l00471"></a>00471         
<a name="l00472"></a>00472         
<a name="l00481"></a><a class="code" href="classtx__memberaccess__modfunc1.html#a11">00481</a>         function <a class="code" href="classtx__memberaccess__modfunc1.html#a11">getExistingAce</a>($email)
<a name="l00482"></a>00482         {
<a name="l00483"></a>00483                 $returnValue = <span class="keyword">false</span>;
<a name="l00484"></a>00484                 <span class="keywordflow">if</span> (''==$email) {
<a name="l00485"></a>00485                         <span class="keywordflow">return</span> $returnValue;
<a name="l00486"></a>00486                 }
<a name="l00487"></a>00487                 
<a name="l00488"></a>00488                 <span class="comment">//use caching here.</span>
<a name="l00489"></a>00489                 <span class="comment">//if this is the first time around, the cache won't be set yet.</span>
<a name="l00490"></a>00490                 <span class="comment">//so fill it in.</span>
<a name="l00491"></a>00491                 <span class="keywordflow">if</span> (!isset($this-&gt;accessListCache)) {
<a name="l00492"></a>00492                         $this-&gt;accessListCache = $this-&gt;<a class="code" href="classtx__memberaccess__modfunc1.html#a15">getRowsAccessList</a>();
<a name="l00493"></a>00493                 } <span class="comment">//for subsequent go-arounds, we won't need to do a SELECT</span>
<a name="l00494"></a>00494                 
<a name="l00495"></a>00495                 $emailPath = $this-&gt;<a class="code" href="classtx__memberaccess__modfunc1.html#a2">array_search_recursive2</a>( $email, $this-&gt;accessListCache, 'email' );
<a name="l00496"></a>00496                 <span class="keywordflow">if</span> (null==$emailPath) {
<a name="l00497"></a>00497                         <span class="keywordflow">if</span> ($this-&gt;debug) {
<a name="l00498"></a>00498                                 echo 'Not found: /'.$email.'/&lt;br&gt;';
<a name="l00499"></a>00499                         }
<a name="l00500"></a>00500                 } <span class="keywordflow">else</span> {
<a name="l00501"></a>00501                         
<a name="l00502"></a>00502                         <span class="comment">//note that $emailPath will be an array with values like Array ( [0] =&gt; 2 [1] =&gt; 2 )</span>
<a name="l00503"></a>00503                         <span class="comment">//the elements of the path are used as indexes to the data array</span>
<a name="l00504"></a>00504                         <span class="comment">//We only care about the first index, though, as it tells us the row no.</span>
<a name="l00505"></a>00505                         <span class="comment">//We return the entire row</span>
<a name="l00506"></a>00506                         $returnValue = $this-&gt;accessListCache[$emailPath[0]];
<a name="l00507"></a>00507                         
<a name="l00508"></a>00508                         <span class="comment">//there should be 2 elements in the path</span>
<a name="l00509"></a>00509                         <span class="keywordflow">if</span> ($this-&gt;debug) {
<a name="l00510"></a>00510                                 <span class="keywordflow">if</span> (($elementCount = count($emailPath)) != 2) {
<a name="l00511"></a>00511                                         echo 'Error: expecting 2 elements in $emailPath; actually ' . $elementCount; 
<a name="l00512"></a>00512                                 }
<a name="l00513"></a>00513                                 $accesslevel = $this-&gt;accessListCache[$emailPath[0]]['accesslevel'];
<a name="l00514"></a>00514                                 echo 'Found: User-accesslevel/'.$email.<span class="charliteral">'/'</span>.$accesslevel.'/&lt;br&gt;';
<a name="l00515"></a>00515                         }
<a name="l00516"></a>00516                         
<a name="l00517"></a>00517                 }
<a name="l00518"></a>00518                 
<a name="l00519"></a>00519                 <span class="keywordflow">if</span> ($this-&gt;debug) {
<a name="l00520"></a>00520                         <span class="comment">//echo print_r($this-&gt;accessListCache);</span>
<a name="l00521"></a>00521                         echo 'count($this-&gt;accessListCache): /' . count($this-&gt;accessListCache). <span class="charliteral">'/'</span>;
<a name="l00522"></a>00522                         echo '$emailPath /' ; print_r($emailPath); echo '/ &lt;br&gt;';
<a name="l00523"></a>00523                         
<a name="l00524"></a>00524                 }
<a name="l00525"></a>00525                 
<a name="l00526"></a>00526                 <span class="keywordflow">return</span> $returnValue;
<a name="l00527"></a>00527         }
<a name="l00528"></a>00528         
<a name="l00540"></a><a class="code" href="classtx__memberaccess__modfunc1.html#a1">00540</a>         function <a class="code" href="classtx__memberaccess__modfunc1.html#a1">array_search_recursive</a>( $needle, $haystack )
<a name="l00541"></a>00541         {
<a name="l00542"></a>00542           $path = NULL;
<a name="l00543"></a>00543           $keys = array_keys($haystack);
<a name="l00544"></a>00544           <span class="keywordflow">while</span> (!$path &amp;&amp; (list($toss,$k)=each($keys))) {
<a name="l00545"></a>00545                  $v = $haystack[$k];
<a name="l00546"></a>00546                  <span class="keywordflow">if</span> (is_scalar($v)) {
<a name="l00547"></a>00547                         <span class="keywordflow">if</span> ($v===$needle) {
<a name="l00548"></a>00548                            $path = array($k);
<a name="l00549"></a>00549                         }
<a name="l00550"></a>00550                  } elseif (is_array($v)) {
<a name="l00551"></a>00551                         <span class="keywordflow">if</span> ($path=$this-&gt;array_search_recursive( $needle, $v )) {
<a name="l00552"></a>00552                            array_unshift($path,$k);
<a name="l00553"></a>00553                         }
<a name="l00554"></a>00554                  }
<a name="l00555"></a>00555           }
<a name="l00556"></a>00556           <span class="keywordflow">return</span> $path;
<a name="l00557"></a>00557         }
<a name="l00558"></a>00558 
<a name="l00559"></a>00559 
<a name="l00573"></a><a class="code" href="classtx__memberaccess__modfunc1.html#a2">00573</a>         function <a class="code" href="classtx__memberaccess__modfunc1.html#a2">array_search_recursive2</a>($needle, $haystack, $key_lookin=<span class="stringliteral">""</span>) {
<a name="l00574"></a>00574                 $path = NULL;
<a name="l00575"></a>00575                 <span class="keywordflow">if</span> (!empty($key_lookin) &amp;&amp; array_key_exists($key_lookin, $haystack) &amp;&amp; $needle === $haystack[$key_lookin]) {
<a name="l00576"></a>00576                         $path[] = $key_lookin;
<a name="l00577"></a>00577                 } <span class="keywordflow">else</span> {
<a name="l00578"></a>00578                         foreach($haystack as $key =&gt; $val) {
<a name="l00579"></a>00579                                 <span class="keywordflow">if</span> (is_scalar($val) &amp;&amp; $val === $needle &amp;&amp; empty($key_lookin)) {
<a name="l00580"></a>00580                                         $path[] = $key;
<a name="l00581"></a>00581                                         <span class="keywordflow">break</span>;
<a name="l00582"></a>00582                                 } 
<a name="l00583"></a>00583                                 elseif (is_array($val) &amp;&amp; $path = $this-&gt;array_search_recursive2($needle, $val, $key_lookin)) {
<a name="l00584"></a>00584                                         array_unshift($path, $key);
<a name="l00585"></a>00585                                         <span class="keywordflow">break</span>;
<a name="l00586"></a>00586                                 }
<a name="l00587"></a>00587                         }
<a name="l00588"></a>00588                 }
<a name="l00589"></a>00589                 <span class="keywordflow">return</span> $path;
<a name="l00590"></a>00590         }
<a name="l00591"></a>00591 
<a name="l00592"></a>00592         
<a name="l00593"></a>00593 
<a name="l00597"></a><a class="code" href="classtx__memberaccess__modfunc1.html#a24">00597</a>         function <a class="code" href="classtx__memberaccess__modfunc1.html#a24">testAccessLevel</a>() {
<a name="l00598"></a>00598                 $this-&gt;<a class="code" href="classtx__memberaccess__modfunc1.html#a0">appendAccessLevel</a>('<span class="charliteral">','</span>');
<a name="l00599"></a>00599                 $this-&gt;<a class="code" href="classtx__memberaccess__modfunc1.html#a0">appendAccessLevel</a>(<span class="charliteral">'9'</span>,'');
<a name="l00600"></a>00600                 $this-&gt;<a class="code" href="classtx__memberaccess__modfunc1.html#a0">appendAccessLevel</a>('<span class="charliteral">','</span>9');
<a name="l00601"></a>00601                 $this-&gt;<a class="code" href="classtx__memberaccess__modfunc1.html#a0">appendAccessLevel</a>(<span class="charliteral">'9'</span>,'10');
<a name="l00602"></a>00602                 $this-&gt;<a class="code" href="classtx__memberaccess__modfunc1.html#a0">appendAccessLevel</a>('10<span class="charliteral">','</span>10');
<a name="l00603"></a>00603                 $this-&gt;<a class="code" href="classtx__memberaccess__modfunc1.html#a0">appendAccessLevel</a>('9,10<span class="charliteral">','</span>9');
<a name="l00604"></a>00604                 $this-&gt;<a class="code" href="classtx__memberaccess__modfunc1.html#a0">appendAccessLevel</a>('9,11<span class="charliteral">','</span>10');
<a name="l00605"></a>00605         }
<a name="l00606"></a>00606 
<a name="l00615"></a><a class="code" href="classtx__memberaccess__modfunc1.html#a0">00615</a>         function <a class="code" href="classtx__memberaccess__modfunc1.html#a0">appendAccessLevel</a>($currentAccessLevel, $desiredAccessLevel, $ignoredLevels='')
<a name="l00616"></a>00616         {
<a name="l00617"></a>00617 
<a name="l00618"></a>00618                 <span class="keywordflow">if</span> ($this-&gt;debug) {
<a name="l00619"></a>00619                         echo '&lt;br&gt; $currentAccessLevel ';
<a name="l00620"></a>00620                         var_dump($currentAccessLevel);
<a name="l00621"></a>00621                         echo '&lt;br&gt; $desiredAccessLevel ';
<a name="l00622"></a>00622                         var_dump($desiredAccessLevel);
<a name="l00623"></a>00623                         echo '&lt;br&gt; $ignoredLevels ';
<a name="l00624"></a>00624                         var_dump($ignoredLevels);
<a name="l00625"></a>00625                         echo '&lt;br&gt;';
<a name="l00626"></a>00626                 }
<a name="l00627"></a>00627                 
<a name="l00628"></a>00628                 <span class="comment">// Since the accesslevel/usergroups value is a comma-separated values string, we explode on the comma,</span>
<a name="l00629"></a>00629                 <span class="comment">// process, and then implode into a string again.</span>
<a name="l00630"></a>00630                 <span class="comment">//Note how we trim spaces--the search algorithm below won't work if there are</span>
<a name="l00631"></a>00631                 <span class="comment">//extra spaces: they'll be seen as a different value</span>
<a name="l00632"></a>00632                 $comma = <span class="stringliteral">","</span>;
<a name="l00633"></a>00633                 $currentAccessLevelArray = explode( $comma, trim($currentAccessLevel) );
<a name="l00634"></a>00634                 $desiredAccessLevelArray = explode( $comma, trim($desiredAccessLevel) );
<a name="l00635"></a>00635                 $ignoredAccessLevelArray = explode( $comma, trim($ignoredLevels) );
<a name="l00636"></a>00636                 <span class="comment">//start off w/ current access level as a base, minus the levels to be ignored</span>
<a name="l00637"></a>00637                 $newAccessLevelArray = array_diff($currentAccessLevelArray, $ignoredAccessLevelArray) ;  
<a name="l00638"></a>00638                 <span class="keywordflow">if</span> ($this-&gt;debug) {
<a name="l00639"></a>00639                         echo <span class="stringliteral">"\$newAccessLevelArray before processing $newAccessLevelArray \n&lt;br&gt;"</span>; 
<a name="l00640"></a>00640                         var_dump($newAccessLevelArray);
<a name="l00641"></a>00641                 }
<a name="l00642"></a>00642 
<a name="l00643"></a>00643                 <span class="comment">//if any single desired access level doesn't already exist, add it to the new access level array</span>
<a name="l00644"></a>00644                 foreach ($desiredAccessLevelArray as $groupid) {
<a name="l00645"></a>00645                         <span class="keywordflow">if</span> (!in_array($groupid, $newAccessLevelArray)) {
<a name="l00646"></a>00646                                 $newAccessLevelArray[] = $groupid;
<a name="l00647"></a>00647                         }
<a name="l00648"></a>00648                 }
<a name="l00649"></a>00649                 
<a name="l00650"></a>00650                 $newAccessLevel = implode( $comma, $newAccessLevelArray );
<a name="l00651"></a>00651                 $newAccessLevelTrimmed = trim($newAccessLevel,$comma); 
<a name="l00652"></a>00652 
<a name="l00653"></a>00653                 <span class="keywordflow">if</span>($this-&gt;debug) {
<a name="l00654"></a>00654                         echo '&lt;br&gt;&lt;br&gt;Current:'.$currentAccessLevel; print_r ($currentAccessLevelArray);
<a name="l00655"></a>00655                         echo '&lt;br&gt;Desired:'.$desiredAccessLevel; print_r ($desiredAccessLevelArray); 
<a name="l00656"></a>00656                         echo '&lt;br&gt;New:'.$newAccessLevelTrimmed; print_r ($newAccessLevelArray );
<a name="l00657"></a>00657                 }
<a name="l00658"></a>00658                 <span class="keywordflow">return</span> $newAccessLevelTrimmed;
<a name="l00659"></a>00659         }
<a name="l00660"></a>00660         
<a name="l00661"></a>00661         
<a name="l00670"></a><a class="code" href="classtx__memberaccess__modfunc1.html#a26">00670</a>         function <a class="code" href="classtx__memberaccess__modfunc1.html#a26">updateFeUserGroups</a>($uid = null)
<a name="l00671"></a>00671         {
<a name="l00672"></a>00672                 <span class="comment">//get the rows which are in both tables, correlated by email</span>
<a name="l00673"></a>00673                 $rows = $this-&gt;<a class="code" href="classtx__memberaccess__modfunc1.html#a16">getRowsFeUserUpdate</a>($uid);
<a name="l00674"></a>00674                 $updateQuery = '';
<a name="l00675"></a>00675                 
<a name="l00676"></a>00676                 <span class="comment">/*</span>
<a name="l00677"></a>00677 <span class="comment">                What the update query will look like:</span>
<a name="l00678"></a>00678 <span class="comment">                UPDATE fe_users</span>
<a name="l00679"></a>00679 <span class="comment">                SET usergroup = '9,10'</span>
<a name="l00680"></a>00680 <span class="comment">                WHERE uid = [uid] </span>
<a name="l00681"></a>00681 <span class="comment">                */</span>
<a name="l00682"></a>00682                 <span class="comment">//iterate over these rows;</span>
<a name="l00683"></a>00683                 <span class="comment">//create an update query which will add the desired access level to the current access level</span>
<a name="l00684"></a>00684                 foreach ( $rows as $row ) {
<a name="l00685"></a>00685 
<a name="l00686"></a>00686                         $newUsergroup = $this-&gt;<a class="code" href="classtx__memberaccess__modfunc1.html#a0">appendAccessLevel</a>($row['current_accesslevel'], $row['desired_accesslevel']);
<a name="l00687"></a>00687                         $uid = $row['feusers_uid'];
<a name="l00688"></a>00688                         $fields_values = array('usergroup' =&gt; $newUsergroup);
<a name="l00689"></a>00689                         $table = 'fe_users';
<a name="l00690"></a>00690                         $where = <span class="stringliteral">"uid = $uid"</span>;
<a name="l00691"></a>00691                         $result = $this-&gt;db-&gt;exec_UPDATEquery($table,$where,$fields_values);
<a name="l00692"></a>00692 
<a name="l00693"></a>00693                         <span class="keywordflow">if</span> ($this-&gt;debug) {
<a name="l00694"></a>00694                                 echo '&lt;br&gt;Query result:/' ; var_dump($result); echo <span class="charliteral">'/'</span>;
<a name="l00695"></a>00695                                 echo '&lt;br&gt;Affected rows:' . mysql_affected_rows();
<a name="l00696"></a>00696                                 $query =  $this-&gt;db-&gt;UPDATEquery($table,$where,$fields_values);
<a name="l00697"></a>00697                                 $updateQuery .= $query . '; ';
<a name="l00698"></a>00698                         }
<a name="l00699"></a>00699                 }
<a name="l00700"></a>00700 
<a name="l00701"></a>00701                 <span class="keywordflow">if</span> ($this-&gt;debug) echo $updateQuery;
<a name="l00702"></a>00702         }
<a name="l00703"></a>00703         
<a name="l00709"></a><a class="code" href="classtx__memberaccess__modfunc1.html#a16">00709</a>         function <a class="code" href="classtx__memberaccess__modfunc1.html#a16">getRowsFeUserUpdate</a>($uid = null)
<a name="l00710"></a>00710         {
<a name="l00711"></a>00711                 <span class="keywordflow">if</span> ($this-&gt;debug) {
<a name="l00712"></a>00712                         echo <span class="stringliteral">"getRowsFeUserUpdate($uid)&lt;br&gt;"</span>;
<a name="l00713"></a>00713                 }
<a name="l00714"></a>00714                 
<a name="l00715"></a>00715                 <span class="comment">/*</span>
<a name="l00716"></a>00716 <span class="comment">                Whole query looks like this:</span>
<a name="l00717"></a>00717 <span class="comment">                SELECT fe_users.uid feusers_uid, fe_users.email AS feusers_email, fe_users.usergroup AS current_accesslevel, </span>
<a name="l00718"></a>00718 <span class="comment">                        tx_memberaccess_acl.email AS memberaccess_email, tx_memberaccess_acl.accesslevel AS desired_accesslevel</span>
<a name="l00719"></a>00719 <span class="comment">                FROM tx_memberaccess_acl, fe_users</span>
<a name="l00720"></a>00720 <span class="comment">                WHERE tx_memberaccess_acl.email = fe_users.email</span>
<a name="l00721"></a>00721 <span class="comment">                */</span>
<a name="l00722"></a>00722                 $where = <span class="stringliteral">"fe_users.email = $this-&gt;table_member_acl.email"</span>;
<a name="l00723"></a>00723                 $where .= is_null($uid) ? '' : <span class="stringliteral">" AND fe_users.uid = $uid"</span>;
<a name="l00724"></a>00724                 $where .= ' AND fe_users.deleted != 1  AND table_member_acl.deleted !=1 AND fe_users.disable != 1';
<a name="l00725"></a>00725                 $columns = <span class="stringliteral">"fe_users.uid feusers_uid, fe_users.email AS feusers_email, "</span>
<a name="l00726"></a>00726                         .<span class="stringliteral">"fe_users.usergroup AS current_accesslevel, $this-&gt;table_member_acl.email AS memberaccess_email, "</span>
<a name="l00727"></a>00727                         .<span class="stringliteral">"$this-&gt;table_member_acl.accesslevel AS desired_accesslevel"</span>;
<a name="l00728"></a>00728                 $from = <span class="stringliteral">"fe_users, $this-&gt;table_member_acl"</span>;
<a name="l00729"></a>00729                 $groupby = '';
<a name="l00730"></a>00730                 $orderby = '';
<a name="l00731"></a>00731                 $rows =  $this-&gt;db-&gt;exec_SELECTgetRows($columns, $from, $where, $groupby, $orderby  );
<a name="l00732"></a>00732                 
<a name="l00733"></a>00733                 <span class="keywordflow">if</span> (!is_array($rows)) {
<a name="l00734"></a>00734                         <span class="keywordflow">if</span> ($this-&gt;debug) {
<a name="l00735"></a>00735                                 echo ' $rows not an array';
<a name="l00736"></a>00736                         }
<a name="l00737"></a>00737                         $rows=array();
<a name="l00738"></a>00738                 }
<a name="l00739"></a>00739 
<a name="l00740"></a>00740                 <span class="keywordflow">if</span> ($this-&gt;debug) {
<a name="l00741"></a>00741                         echo $where;
<a name="l00742"></a>00742                         echo 'Rows result:';
<a name="l00743"></a>00743                         foreach ( $rows as $row ) {
<a name="l00744"></a>00744                                 print_r($row);
<a name="l00745"></a>00745                                 <span class="comment">//$output .= '';</span>
<a name="l00746"></a>00746                         }
<a name="l00747"></a>00747                         reset( $rows );
<a name="l00748"></a>00748                 }
<a name="l00749"></a>00749                 <span class="keywordflow">return</span> $rows;
<a name="l00750"></a>00750         }
<a name="l00751"></a>00751 
<a name="l00752"></a>00752         
<a name="l00757"></a><a class="code" href="classtx__memberaccess__modfunc1.html#a3">00757</a>         function <a class="code" href="classtx__memberaccess__modfunc1.html#a3">displayAccessList</a>()
<a name="l00758"></a>00758         {
<a name="l00759"></a>00759                 global $LANG;
<a name="l00760"></a>00760                 
<a name="l00761"></a>00761                 <span class="comment">//get the rows</span>
<a name="l00762"></a>00762                 $rows = $this-&gt;<a class="code" href="classtx__memberaccess__modfunc1.html#a15">getRowsAccessList</a>();
<a name="l00763"></a>00763                 
<a name="l00764"></a>00764                 <span class="comment">//and format the data, and convert to HTML with a title, before returning them.</span>
<a name="l00765"></a>00765                 <span class="keywordflow">return</span> cbArr2Html( $this-&gt;formatRowsAccessList($rows), $LANG-&gt;getLL( 'report.accesslist.title' ) );
<a name="l00766"></a>00766         }
<a name="l00767"></a>00767 
<a name="l00772"></a><a class="code" href="classtx__memberaccess__modfunc1.html#a15">00772</a>         function <a class="code" href="classtx__memberaccess__modfunc1.html#a15">getRowsAccessList</a>()
<a name="l00773"></a>00773         {
<a name="l00774"></a>00774                 <span class="keywordflow">if</span> ($this-&gt;debug) {
<a name="l00775"></a>00775                         echo '<a class="code" href="classtx__memberaccess__modfunc1.html#a15">getRowsAccessList</a>()&lt;br&gt;';
<a name="l00776"></a>00776                 }
<a name="l00777"></a>00777                 
<a name="l00778"></a>00778                 $where = ' deleted != 1 ';
<a name="l00779"></a>00779                 $columns = 'name, company, email, accesslevel';
<a name="l00780"></a>00780                 $groupby = '';
<a name="l00781"></a>00781                 $orderby = 'name, company';
<a name="l00782"></a>00782                 $rows =  $this-&gt;db-&gt;exec_SELECTgetRows($columns, $this-&gt;table_member_acl, $where, $groupby, $orderby  );
<a name="l00783"></a>00783                 
<a name="l00784"></a>00784                 <span class="keywordflow">if</span> (!is_array($rows)) {
<a name="l00785"></a>00785                         <span class="keywordflow">if</span> ($this-&gt;debug) {
<a name="l00786"></a>00786                                 echo ' $rows not an array';
<a name="l00787"></a>00787                         }
<a name="l00788"></a>00788                         $rows=array();
<a name="l00789"></a>00789                 }
<a name="l00790"></a>00790 
<a name="l00791"></a>00791                 <span class="keywordflow">if</span> ($this-&gt;debug) {
<a name="l00792"></a>00792                         echo $where;
<a name="l00793"></a>00793                         echo 'Rows result:';
<a name="l00794"></a>00794                         foreach ( $rows as $row ) {
<a name="l00795"></a>00795                                 print_r($row);
<a name="l00796"></a>00796                                 <span class="comment">//$output .= '';</span>
<a name="l00797"></a>00797                         }
<a name="l00798"></a>00798                         reset( $rows );
<a name="l00799"></a>00799                 }
<a name="l00800"></a>00800                 <span class="keywordflow">return</span> $rows;
<a name="l00801"></a>00801         }
<a name="l00802"></a>00802 
<a name="l00803"></a>00803 
<a name="l00812"></a><a class="code" href="classtx__memberaccess__modfunc1.html#a8">00812</a>         function <a class="code" href="classtx__memberaccess__modfunc1.html#a8">formatRowsAccessList</a>( &amp;$rows )
<a name="l00813"></a>00813         {
<a name="l00814"></a>00814                 <span class="comment">//copy the original rows array to a working array</span>
<a name="l00815"></a>00815                 $rowsFormatted = $rows;
<a name="l00816"></a>00816                 <span class="keywordflow">if</span> ($this-&gt;debug) {
<a name="l00817"></a>00817                         echo '<a class="code" href="classtx__memberaccess__modfunc1.html#a8">formatRowsAccessList</a>( &amp;$rows )';
<a name="l00818"></a>00818                         echo '&lt;br&gt;count($rows): ' . count($rows);
<a name="l00819"></a>00819                 }
<a name="l00820"></a>00820                 
<a name="l00821"></a>00821                 <span class="comment">//for each row, substitute formatted text in the working array</span>
<a name="l00822"></a>00822                 <span class="keywordflow">for</span>( $i=0; $i&lt;count($rows); $i++ ) {
<a name="l00823"></a>00823                         
<a name="l00824"></a>00824                         $row = $rows[$i];
<a name="l00825"></a>00825                         <span class="comment">//usergroup</span>
<a name="l00826"></a>00826                         $rowsFormatted[$i][$this-&gt;fieldAlias_usergroup] = $this-&gt;<a class="code" href="classtx__memberaccess__modfunc1.html#a9">formatUserGroup</a>($row[$this-&gt;fieldAlias_usergroup]);
<a name="l00827"></a>00827                         
<a name="l00828"></a>00828                         <span class="keywordflow">if</span> ($this-&gt;debug) {
<a name="l00829"></a>00829                                 echo ' iteration '.$i;
<a name="l00830"></a>00830                                 echo <span class="charliteral">' '</span>.$rowsFormatted[$i][$this-&gt;fieldAlias_usergroup];
<a name="l00831"></a>00831                         }
<a name="l00832"></a>00832                 }
<a name="l00833"></a>00833                 <span class="keywordflow">return</span> $rowsFormatted;
<a name="l00834"></a>00834         }
<a name="l00835"></a>00835 
<a name="l00844"></a><a class="code" href="classtx__memberaccess__modfunc1.html#a9">00844</a>         function <a class="code" href="classtx__memberaccess__modfunc1.html#a9">formatUserGroup</a>($usergroup)
<a name="l00845"></a>00845         {       
<a name="l00846"></a>00846                 
<a name="l00847"></a>00847                 $usergroupTranslationTable = array(
<a name="l00848"></a>00848                                 <span class="charliteral">'1'</span>                        =&gt; 'Member'
<a name="l00849"></a>00849                                 , <span class="charliteral">'2'</span>                    =&gt; 'Professional Member'
<a name="l00850"></a>00850                                 , <span class="charliteral">'4'</span>                    =&gt; 'Complimentary'
<a name="l00851"></a>00851                                 , <span class="charliteral">'5'</span>                    =&gt; 'Visitor, White Paper'
<a name="l00852"></a>00852                                 , <span class="charliteral">'6'</span>                    =&gt; 'Visitor, Round Table'
<a name="l00853"></a>00853                                 , <span class="charliteral">'7'</span>                    =&gt; 'Visitor, Presentation'
<a name="l00854"></a>00854                                 , <span class="charliteral">'8'</span>                    =&gt; 'Editor Preview'
<a name="l00855"></a>00855                                 , <span class="charliteral">'9'</span>                    =&gt; 'BPM - Chicago 2005'
<a name="l00856"></a>00856                                 , '10'                    =&gt; 'BPM - San Francisco 2005'
<a name="l00857"></a>00857                                 , '11'                                  =&gt;   'BPM - Washington 2005'
<a name="l00858"></a>00858                 );
<a name="l00859"></a>00859 
<a name="l00860"></a>00860                 <span class="comment">//change commas to slash</span>
<a name="l00861"></a>00861                 $usergroup = preg_replace( <span class="stringliteral">"/,/"</span>, ' / ', $usergroup); 
<a name="l00862"></a>00862 
<a name="l00863"></a>00863                 <span class="comment">//replace the usergroup numbers with names.</span>
<a name="l00864"></a>00864                 foreach ($usergroupTranslationTable as $searchText =&gt; $replacementText) {
<a name="l00865"></a>00865                         $usergroup = preg_replace( <span class="stringliteral">"#\b$searchText\b#"</span>, $replacementText, $usergroup );
<a name="l00866"></a>00866                 }
<a name="l00867"></a>00867                 
<a name="l00868"></a>00868                                                                         
<a name="l00869"></a>00869                 <span class="keywordflow">if</span> ($this-&gt;debug) {
<a name="l00870"></a>00870                         echo ' usergroup:' . $usergroup;
<a name="l00871"></a>00871                 }
<a name="l00872"></a>00872                 
<a name="l00873"></a>00873                 <span class="keywordflow">return</span> $usergroup;
<a name="l00874"></a>00874         }
<a name="l00875"></a>00875 
<a name="l00876"></a>00876         
<a name="l00883"></a><a class="code" href="classtx__memberaccess__modfunc1.html#a4">00883</a>         function <a class="code" href="classtx__memberaccess__modfunc1.html#a4">doDownload</a> ( $what )
<a name="l00884"></a>00884         {
<a name="l00885"></a>00885                 <span class="keywordflow">switch</span> ($what) {
<a name="l00886"></a>00886                         <span class="keywordflow">case</span> 'tx_memberaccess_modfunc1_accesstool_command_download_reporting': 
<a name="l00887"></a>00887                                 $this-&gt;<a class="code" href="classtx__memberaccess__modfunc1.html#a7">downloadAccessListForReporting</a>();
<a name="l00888"></a>00888                                 <span class="keywordflow">break</span>;
<a name="l00889"></a>00889                         <span class="keywordflow">case</span> 'tx_memberaccess_modfunc1_accesstool_command_download_aclmodification': 
<a name="l00890"></a>00890                                 $this-&gt;<a class="code" href="classtx__memberaccess__modfunc1.html#a6">downloadAccessListForACLModification</a>();
<a name="l00891"></a>00891                                 <span class="keywordflow">break</span>;
<a name="l00892"></a>00892                         <span class="keywordflow">default</span>:
<a name="l00893"></a>00893                                 <span class="comment">//not supposed to happen</span>
<a name="l00894"></a>00894                                 <span class="keywordflow">if</span> ($this-&gt;debug) echo 'Improper <span class="keywordflow">case</span> (<a class="code" href="classtx__memberaccess__modfunc1.html#a4">doDownload</a> ( $what ))';
<a name="l00895"></a>00895                 }
<a name="l00896"></a>00896         }
<a name="l00897"></a>00897 
<a name="l00906"></a><a class="code" href="classtx__memberaccess__modfunc1.html#a7">00906</a>         function <a class="code" href="classtx__memberaccess__modfunc1.html#a7">downloadAccessListForReporting</a>()
<a name="l00907"></a>00907         {
<a name="l00908"></a>00908                 $rows                = $rows = $this-&gt;<a class="code" href="classtx__memberaccess__modfunc1.html#a15">getRowsAccessList</a>();
<a name="l00909"></a>00909                 $rowsFormatted      = $this-&gt;<a class="code" href="classtx__memberaccess__modfunc1.html#a8">formatRowsAccessList</a>($rows);
<a name="l00910"></a>00910 
<a name="l00911"></a>00911                 <span class="comment">// convert rows to csv for download</span>
<a name="l00912"></a>00912                 $rowsCsv                = '';
<a name="l00913"></a>00913 
<a name="l00914"></a>00914                 foreach ( $rowsFormatted as $key =&gt; $value )
<a name="l00915"></a>00915                 {
<a name="l00916"></a>00916                         $rowsCsv            .= cbMkCsvString( $value );
<a name="l00917"></a>00917                 }
<a name="l00918"></a>00918 
<a name="l00919"></a>00919                 $filename                               = $this-&gt;<a class="code" href="classtx__memberaccess__modfunc1.html#a10">getDownloadFilename</a>( 'Member_AccessList_Report_' );
<a name="l00920"></a>00920                 
<a name="l00921"></a>00921                 <span class="comment">// download members list</span>
<a name="l00922"></a>00922                 <span class="comment">// send to browser as download</span>
<a name="l00923"></a>00923                 cbBrowserDownload( $filename, $rowsCsv );
<a name="l00924"></a>00924                 exit();
<a name="l00925"></a>00925         }
<a name="l00926"></a>00926 
<a name="l00938"></a><a class="code" href="classtx__memberaccess__modfunc1.html#a6">00938</a>         function <a class="code" href="classtx__memberaccess__modfunc1.html#a6">downloadAccessListForACLModification</a>()
<a name="l00939"></a>00939         {
<a name="l00940"></a>00940                 $rows                = $rows = $this-&gt;<a class="code" href="classtx__memberaccess__modfunc1.html#a15">getRowsAccessList</a>();
<a name="l00941"></a>00941 
<a name="l00942"></a>00942                 <span class="comment">// convert rows to csv for download</span>
<a name="l00943"></a>00943                 $rowsCsv                = '';
<a name="l00944"></a>00944 
<a name="l00945"></a>00945                 foreach ( $rows as $key =&gt; $value )
<a name="l00946"></a>00946                 {
<a name="l00947"></a>00947                         $rowsCsv            .= cbMkCsvString( $value );
<a name="l00948"></a>00948                 }
<a name="l00949"></a>00949 
<a name="l00950"></a>00950                 $filename                               = $this-&gt;<a class="code" href="classtx__memberaccess__modfunc1.html#a10">getDownloadFilename</a>( 'Member_AccessList_' );
<a name="l00951"></a>00951                 
<a name="l00952"></a>00952                 <span class="comment">// download members list</span>
<a name="l00953"></a>00953                 <span class="comment">// send to browser as download</span>
<a name="l00954"></a>00954                 cbBrowserDownload( $filename, $rowsCsv );
<a name="l00955"></a>00955                 exit();
<a name="l00956"></a>00956         }
<a name="l00957"></a>00957 
<a name="l00958"></a>00958         
<a name="l00966"></a><a class="code" href="classtx__memberaccess__modfunc1.html#a10">00966</a>         function <a class="code" href="classtx__memberaccess__modfunc1.html#a10">getDownloadFilename</a>( $basename ) {
<a name="l00967"></a>00967                 
<a name="l00968"></a>00968                 $dateFormatted          = date('F j Y', time() );  
<a name="l00969"></a>00969                 $filename              = $basename . $dateFormatted . '.csv';
<a name="l00970"></a>00970                 $filename              = $this-&gt;<a class="code" href="classtx__memberaccess__modfunc1.html#a23">spaceToUnderscore</a>( $filename );
<a name="l00971"></a>00971                 <span class="keywordflow">return</span> $filename;
<a name="l00972"></a>00972         }
<a name="l00973"></a>00973         
<a name="l00979"></a><a class="code" href="classtx__memberaccess__modfunc1.html#a23">00979</a>         function <a class="code" href="classtx__memberaccess__modfunc1.html#a23">spaceToUnderscore</a>($string)
<a name="l00980"></a>00980         {
<a name="l00981"></a>00981                 <span class="keywordflow">return</span> preg_replace( '/ /', <span class="charliteral">'_'</span>, $string);
<a name="l00982"></a>00982         }
<a name="l00983"></a>00983 
<a name="l00988"></a><a class="code" href="classtx__memberaccess__modfunc1.html#a19">00988</a>         function <a class="code" href="classtx__memberaccess__modfunc1.html#a19">setValues</a>(){}
<a name="l00989"></a>00989 
<a name="l00990"></a>00990 }
<a name="l00991"></a>00991 
<a name="l00992"></a>00992 
<a name="l00993"></a>00993 
<a name="l00994"></a>00994 <span class="keywordflow">if</span> (defined(<span class="stringliteral">"TYPO3_MODE"</span>) &amp;&amp; $TYPO3_CONF_VARS[TYPO3_MODE][<span class="stringliteral">"XCLASS"</span>][<span class="stringliteral">"ext/member_access/modfunc1/class.tx_memberaccess_modfunc1.php"</span>])   {
<a name="l00995"></a>00995         include_once($TYPO3_CONF_VARS[TYPO3_MODE][<span class="stringliteral">"XCLASS"</span>][<span class="stringliteral">"ext/member_access/modfunc1/class.tx_memberaccess_modfunc1.php"</span>]);
<a name="l00996"></a>00996 }
<a name="l00997"></a>00997 
<a name="l00998"></a>00998 ?&gt;
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Mon Sep 19 21:00:13 2005 for BPM Membership Access by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.4 </small></address>
</body>
</html>
