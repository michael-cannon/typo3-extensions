<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>BPM Membership Access: My Documents/bus/proj/cannonbose/bpm/membershipaccess/docs/member_access/technical/code/class.tx_srfeuserregister_pi1.php Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">technical</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_000001.html">code</a></div>
<h1>class.tx_srfeuserregister_pi1.php</h1><a href="class_8tx__srfeuserregister__pi1_8php.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00002"></a>00002 <span class="comment">/***************************************************************</span>
<a name="l00003"></a>00003 <span class="comment">*  Copyright notice</span>
<a name="l00004"></a>00004 <span class="comment">*</span>
<a name="l00005"></a>00005 <span class="comment">*  (c) 1999-2003 Kasper Skårhøj (kasper@typo3.com)</span>
<a name="l00006"></a>00006 <span class="comment">*  (c) 2004 Stanislas Rolland (stanislas.rolland@fructifor.com)</span>
<a name="l00007"></a>00007 <span class="comment">*  All rights reserved</span>
<a name="l00008"></a>00008 <span class="comment">*</span>
<a name="l00009"></a>00009 <span class="comment">*  This script is part of the Typo3 project. The Typo3 project is</span>
<a name="l00010"></a>00010 <span class="comment">*  free software; you can redistribute it and/or modify</span>
<a name="l00011"></a>00011 <span class="comment">*  it under the terms of the GNU General Public License as published by</span>
<a name="l00012"></a>00012 <span class="comment">*  the Free Software Foundation; either version 2 of the License, or</span>
<a name="l00013"></a>00013 <span class="comment">*  (at your option) any later version.</span>
<a name="l00014"></a>00014 <span class="comment">*</span>
<a name="l00015"></a>00015 <span class="comment">*  The GNU General Public License can be found at</span>
<a name="l00016"></a>00016 <span class="comment">*  http://www.gnu.org/copyleft/gpl.html.</span>
<a name="l00017"></a>00017 <span class="comment">*  A copy is found in the textfile GPL.txt and important notices to the license</span>
<a name="l00018"></a>00018 <span class="comment">*  from the author is found in LICENSE.txt distributed with these scripts.</span>
<a name="l00019"></a>00019 <span class="comment">*</span>
<a name="l00020"></a>00020 <span class="comment">*  This script is distributed in the hope that it will be useful,</span>
<a name="l00021"></a>00021 <span class="comment">*  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00022"></a>00022 <span class="comment">*  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00023"></a>00023 <span class="comment">*  GNU General Public License for more details.</span>
<a name="l00024"></a>00024 <span class="comment">*</span>
<a name="l00025"></a>00025 <span class="comment">*  This copyright notice MUST APPEAR in all copies of the script!</span>
<a name="l00026"></a>00026 <span class="comment">***************************************************************/</span>
<a name="l00082"></a>00082 require_once(PATH_tslib.'<span class="keyword">class</span>.tslib_pibase.php');
<a name="l00083"></a>00083         <span class="comment">// To get the pid language overlay</span>
<a name="l00084"></a>00084 require_once(PATH_t3lib.'<span class="keyword">class</span>.t3lib_page.php');
<a name="l00085"></a>00085 require_once(t3lib_extMgm::extPath('sr_static_info').'pi1/<span class="keyword">class</span>.tx_srstaticinfo_pi1.php');
<a name="l00086"></a>00086 require_once(t3lib_extMgm::extPath('sr_feuser_register').'pi1/<span class="keyword">class</span>.tx_srfeuserregister_pi1_t3lib_htmlmail.php');
<a name="l00087"></a>00087 require_once(t3lib_extMgm::extPath('sr_feuser_register').'pi1/<span class="keyword">class</span>.tx_srfeuserregister_pi1_urlvalidator.php');
<a name="l00088"></a>00088 require_once(t3lib_extMgm::extPath('sr_feuser_register').'pi1/<span class="keyword">class</span>.tx_srfeuserregister_pi1_adodb_time.php');
<a name="l00089"></a>00089         <span class="comment">// For use with images:</span>
<a name="l00090"></a>00090 require_once (PATH_t3lib.'<span class="keyword">class</span>.t3lib_basicfilefunc.php');
<a name="l00091"></a>00091 
<a name="l00092"></a>00092 <span class="comment">// MLC credit card validation</span>
<a name="l00093"></a>00093 require_once(t3lib_extMgm::extPath('sr_feuser_register').'pi1/Cb_Validate_Credit_Card.class.php');
<a name="l00094"></a>00094  
<a name="l00095"></a>00095 <span class="comment">//js for upgradeMemberAccess()</span>
<a name="l00096"></a>00096 require_once(t3lib_extMgm::extPath('member_access').'modfunc1/<span class="keyword">class</span>.<a class="code" href="classtx__memberaccess__modfunc1.html">tx_memberaccess_modfunc1</a>.php');
<a name="l00097"></a>00097 
<a name="l00098"></a><a class="code" href="classtx__srfeuserregister__pi1.html">00098</a> <span class="keyword">class </span><a class="code" href="classtx__srfeuserregister__pi1.html">tx_srfeuserregister_pi1</a> <span class="keyword">extends</span> tslib_pibase {
<a name="l00099"></a><a class="code" href="classtx__srfeuserregister__pi1.html#o7">00099</a>         var <a class="code" href="classtx__srfeuserregister__pi1.html#o7">$cObj</a>;
<a name="l00100"></a>00100         <span class="comment">// The backReference to the mother cObj object set at call time</span>
<a name="l00101"></a><a class="code" href="classtx__srfeuserregister__pi1.html#o9">00101</a>         var <a class="code" href="classtx__srfeuserregister__pi1.html#o9">$conf</a> = array();
<a name="l00102"></a><a class="code" href="classtx__srfeuserregister__pi1.html#o42">00102</a>         var <a class="code" href="classtx__srfeuserregister__pi1.html#o42">$site_url</a> = '';
<a name="l00103"></a><a class="code" href="classtx__srfeuserregister__pi1.html#o47">00103</a>         var <a class="code" href="classtx__srfeuserregister__pi1.html#o47">$theTable</a> = 'fe_users';
<a name="l00104"></a><a class="code" href="classtx__srfeuserregister__pi1.html#o43">00104</a>         var <a class="code" href="classtx__srfeuserregister__pi1.html#o43">$TCA</a> = array();
<a name="l00105"></a>00105          
<a name="l00106"></a><a class="code" href="classtx__srfeuserregister__pi1.html#o23">00106</a>         var <a class="code" href="classtx__srfeuserregister__pi1.html#o23">$feUserData</a> = array();
<a name="l00107"></a><a class="code" href="classtx__srfeuserregister__pi1.html#o13">00107</a>         var <a class="code" href="classtx__srfeuserregister__pi1.html#o13">$dataArr</a> = array();
<a name="l00108"></a><a class="code" href="classtx__srfeuserregister__pi1.html#o12">00108</a>         var <a class="code" href="classtx__srfeuserregister__pi1.html#o12">$currentArr</a> = array();
<a name="l00109"></a><a class="code" href="classtx__srfeuserregister__pi1.html#o22">00109</a>         var <a class="code" href="classtx__srfeuserregister__pi1.html#o22">$failureMsg</a> = array();
<a name="l00110"></a><a class="code" href="classtx__srfeuserregister__pi1.html#o45">00110</a>         var <a class="code" href="classtx__srfeuserregister__pi1.html#o45">$thePid</a> = 0;
<a name="l00111"></a><a class="code" href="classtx__srfeuserregister__pi1.html#o46">00111</a>         var <a class="code" href="classtx__srfeuserregister__pi1.html#o46">$thePidTitle</a>;
<a name="l00112"></a><a class="code" href="classtx__srfeuserregister__pi1.html#o28">00112</a>         var <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a> = array();
<a name="l00113"></a><a class="code" href="classtx__srfeuserregister__pi1.html#o44">00113</a>         var <a class="code" href="classtx__srfeuserregister__pi1.html#o44">$templateCode</a> = '';
<a name="l00114"></a>00114          
<a name="l00115"></a><a class="code" href="classtx__srfeuserregister__pi1.html#o35">00115</a>         var <a class="code" href="classtx__srfeuserregister__pi1.html#o35">$registerPID</a>;
<a name="l00116"></a><a class="code" href="classtx__srfeuserregister__pi1.html#o16">00116</a>         var <a class="code" href="classtx__srfeuserregister__pi1.html#o16">$editPID</a>;
<a name="l00117"></a><a class="code" href="classtx__srfeuserregister__pi1.html#o10">00117</a>         var <a class="code" href="classtx__srfeuserregister__pi1.html#o10">$confirmPID</a>;
<a name="l00118"></a><a class="code" href="classtx__srfeuserregister__pi1.html#o11">00118</a>         var <a class="code" href="classtx__srfeuserregister__pi1.html#o11">$confirmType</a>;
<a name="l00119"></a><a class="code" href="classtx__srfeuserregister__pi1.html#o27">00119</a>         var <a class="code" href="classtx__srfeuserregister__pi1.html#o27">$loginPID</a>;
<a name="l00120"></a><a class="code" href="classtx__srfeuserregister__pi1.html#o5">00120</a>         var <a class="code" href="classtx__srfeuserregister__pi1.html#o5">$cmd</a>;
<a name="l00121"></a><a class="code" href="classtx__srfeuserregister__pi1.html#o40">00121</a>         var <a class="code" href="classtx__srfeuserregister__pi1.html#o40">$setfixedEnabled</a> = 1;
<a name="l00122"></a><a class="code" href="classtx__srfeuserregister__pi1.html#o26">00122</a>         var <a class="code" href="classtx__srfeuserregister__pi1.html#o26">$HTMLMailEnabled</a> = 1;
<a name="l00123"></a><a class="code" href="classtx__srfeuserregister__pi1.html#o32">00123</a>         var <a class="code" href="classtx__srfeuserregister__pi1.html#o32">$preview</a>;
<a name="l00124"></a><a class="code" href="classtx__srfeuserregister__pi1.html#o33">00124</a>         var <a class="code" href="classtx__srfeuserregister__pi1.html#o33">$previewLabel</a> = '';
<a name="l00125"></a><a class="code" href="classtx__srfeuserregister__pi1.html#o2">00125</a>         var <a class="code" href="classtx__srfeuserregister__pi1.html#o2">$backURL</a>;
<a name="l00126"></a><a class="code" href="classtx__srfeuserregister__pi1.html#o34">00126</a>         var <a class="code" href="classtx__srfeuserregister__pi1.html#o34">$recUid</a>;
<a name="l00127"></a><a class="code" href="classtx__srfeuserregister__pi1.html#o21">00127</a>         var <a class="code" href="classtx__srfeuserregister__pi1.html#o21">$failure</a> = 0;
<a name="l00128"></a>00128         <span class="comment">// is set if data did not have the required fields set.</span>
<a name="l00129"></a><a class="code" href="classtx__srfeuserregister__pi1.html#o20">00129</a>         var <a class="code" href="classtx__srfeuserregister__pi1.html#o20">$error</a> = '';
<a name="l00130"></a><a class="code" href="classtx__srfeuserregister__pi1.html#o38">00130</a>         var <a class="code" href="classtx__srfeuserregister__pi1.html#o38">$saved</a> = 0;
<a name="l00131"></a>00131         <span class="comment">// is set if data is saved</span>
<a name="l00132"></a><a class="code" href="classtx__srfeuserregister__pi1.html#o31">00132</a>         var <a class="code" href="classtx__srfeuserregister__pi1.html#o31">$nc</a> = '';
<a name="l00133"></a>00133         <span class="comment">// "&amp;no_cache=1" if you want that parameter sent.</span>
<a name="l00134"></a><a class="code" href="classtx__srfeuserregister__pi1.html#o0">00134</a>         var <a class="code" href="classtx__srfeuserregister__pi1.html#o0">$additionalUpdateFields</a> = '';
<a name="l00135"></a><a class="code" href="classtx__srfeuserregister__pi1.html#o19">00135</a>         var <a class="code" href="classtx__srfeuserregister__pi1.html#o19">$emailMarkPrefix</a> = 'EMAIL_TEMPLATE_';
<a name="l00136"></a><a class="code" href="classtx__srfeuserregister__pi1.html#o17">00136</a>         var <a class="code" href="classtx__srfeuserregister__pi1.html#o17">$emailMarkAdminSuffix</a> = '_ADMIN';
<a name="l00137"></a><a class="code" href="classtx__srfeuserregister__pi1.html#o39">00137</a>         var <a class="code" href="classtx__srfeuserregister__pi1.html#o39">$savedSuffix</a> = '_SAVED';
<a name="l00138"></a><a class="code" href="classtx__srfeuserregister__pi1.html#o41">00138</a>         var <a class="code" href="classtx__srfeuserregister__pi1.html#o41">$setfixedPrefix</a> = 'SETFIXED_';
<a name="l00139"></a><a class="code" href="classtx__srfeuserregister__pi1.html#o18">00139</a>         var <a class="code" href="classtx__srfeuserregister__pi1.html#o18">$emailMarkHTMLSuffix</a> = '_HTML';
<a name="l00140"></a><a class="code" href="classtx__srfeuserregister__pi1.html#o4">00140</a>         var <a class="code" href="classtx__srfeuserregister__pi1.html#o4">$charset</a> = 'iso-8859-1'; <span class="comment">// charset to be used in emails and form conversions</span>
<a name="l00141"></a><a class="code" href="classtx__srfeuserregister__pi1.html#o8">00141</a>         var <a class="code" href="classtx__srfeuserregister__pi1.html#o8">$codeLength</a>;
<a name="l00142"></a><a class="code" href="classtx__srfeuserregister__pi1.html#o6">00142</a>         var <a class="code" href="classtx__srfeuserregister__pi1.html#o6">$cmdKey</a>;
<a name="l00143"></a><a class="code" href="classtx__srfeuserregister__pi1.html#o24">00143</a>         var <a class="code" href="classtx__srfeuserregister__pi1.html#o24">$fieldList</a>;
<a name="l00144"></a>00144         <span class="comment">// List of fields from fe_admin_fieldList</span>
<a name="l00145"></a><a class="code" href="classtx__srfeuserregister__pi1.html#o37">00145</a>         var <a class="code" href="classtx__srfeuserregister__pi1.html#o37">$requiredArr</a>;
<a name="l00146"></a>00146         <span class="comment">// List of required fields</span>
<a name="l00147"></a><a class="code" href="classtx__srfeuserregister__pi1.html#o1">00147</a>         var <a class="code" href="classtx__srfeuserregister__pi1.html#o1">$adminFieldList</a> = 'name,disable,usergroup';
<a name="l00148"></a><a class="code" href="classtx__srfeuserregister__pi1.html#o25">00148</a>         var <a class="code" href="classtx__srfeuserregister__pi1.html#o25">$fileFunc</a> = ''; <span class="comment">// Set to a basic_filefunc object for file uploads</span>
<a name="l00149"></a>00149         <span class="comment">// MLC cc valid</span>
<a name="l00150"></a><a class="code" href="classtx__srfeuserregister__pi1.html#o3">00150</a>         var <a class="code" href="classtx__srfeuserregister__pi1.html#o3">$cc_valid</a>                           = <span class="keyword">false</span>;
<a name="l00151"></a>00151     
<a name="l00152"></a>00152     <span class="comment">//js</span>
<a name="l00153"></a><a class="code" href="classtx__srfeuserregister__pi1.html#o15">00153</a>     var <a class="code" href="classtx__srfeuserregister__pi1.html#o15">$debug</a> = <span class="keyword">false</span>;
<a name="l00154"></a>00154         <span class="comment">//whether to perform member expiry processing</span>
<a name="l00155"></a>00155         <span class="comment">//set from the typoscript variable $this-&gt;conf['memberExpiryProcessing'];</span>
<a name="l00156"></a><a class="code" href="classtx__srfeuserregister__pi1.html#o30">00156</a>         var <a class="code" href="classtx__srfeuserregister__pi1.html#o30">$memberExpiryProcessing</a> = <span class="keyword">false</span>;
<a name="l00157"></a>00157         <span class="comment">//whether to perform member access processing</span>
<a name="l00158"></a>00158         <span class="comment">//set from the typoscript variable $this-&gt;conf['memberAccessProcessing'];</span>
<a name="l00159"></a><a class="code" href="classtx__srfeuserregister__pi1.html#o29">00159</a>         var <a class="code" href="classtx__srfeuserregister__pi1.html#o29">$memberAccessProcessing</a> = <span class="keyword">false</span>;
<a name="l00160"></a>00160         <span class="comment">//whether to perform registration error processing (log errors to a table)</span>
<a name="l00161"></a>00161         <span class="comment">//set from the typoscript variable $this-&gt;conf['registrationErrorLogging'];</span>
<a name="l00162"></a><a class="code" href="classtx__srfeuserregister__pi1.html#o36">00162</a>         var <a class="code" href="classtx__srfeuserregister__pi1.html#o36">$registrationErrorLogging</a> = <span class="keyword">false</span>;
<a name="l00163"></a>00163         
<a name="l00165"></a><a class="code" href="classtx__srfeuserregister__pi1.html#o14">00165</a>         var <a class="code" href="classtx__srfeuserregister__pi1.html#o14">$db</a>;
<a name="l00166"></a>00166 
<a name="l00167"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a32">00167</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a32">initId</a>() {
<a name="l00168"></a>00168                 $this-&gt;prefixId = '<a class="code" href="classtx__srfeuserregister__pi1.html">tx_srfeuserregister_pi1</a>';  <span class="comment">// Same as class name</span>
<a name="l00169"></a>00169                 $this-&gt;scriptRelPath = 'pi1/<span class="keyword">class</span>.tx_srfeuserregister_pi1.php'; <span class="comment">// Path to this script relative to the extension dir.</span>
<a name="l00170"></a>00170                 $this-&gt;extKey = 'sr_feuser_register';  <span class="comment">// The extension key.</span>
<a name="l00171"></a>00171 
<a name="l00172"></a>00172                 $this-&gt;theTable = 'fe_users';
<a name="l00173"></a>00173                 $this-&gt;adminFieldList = 'name,disable,usergroup';
<a name="l00174"></a>00174         }
<a name="l00175"></a>00175          
<a name="l00176"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a35">00176</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a35">main</a>($content, $conf) {
<a name="l00177"></a>00177 
<a name="l00178"></a>00178                         <span class="comment">// plugin initialization</span>
<a name="l00179"></a>00179                 $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a32">initId</a>();
<a name="l00180"></a>00180                 $this-&gt;conf = <a class="code" href="classtx__srfeuserregister__pi1.html#o9">$conf</a>;
<a name="l00181"></a>00181                 $this-&gt;pi_loadLL();
<a name="l00182"></a>00182                 $this-&gt;pi_USER_INT_obj = 1;
<a name="l00183"></a>00183                 
<a name="l00184"></a>00184                 $this-&gt;db                = $GLOBALS['TYPO3_DB'];
<a name="l00185"></a>00185                 
<a name="l00186"></a>00186                 <span class="comment">// Disable caching</span>
<a name="l00187"></a>00187                 $this-&gt;pi_setPiVarDefaults();
<a name="l00188"></a>00188                 $this-&gt;site_url = t3lib_div::getIndpEnv('TYPO3_SITE_URL');
<a name="l00189"></a>00189 
<a name="l00190"></a>00190         <span class="comment">//turn on debug information output if required (js)</span>
<a name="l00191"></a>00191         $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a53">setDebugStatus</a>();
<a name="l00192"></a>00192                 
<a name="l00193"></a>00193         <span class="keywordflow">if</span> ( $this-&gt;debug &amp;&amp; <span class="keyword">true</span> )
<a name="l00194"></a>00194         {
<a name="l00195"></a>00195             echo '/Start <a class="code" href="classtx__srfeuserregister__pi1.html#o9">$conf</a>/';
<a name="l00196"></a>00196                         cbPrint2( '$conf', $conf );
<a name="l00197"></a>00197                         echo '/End <a class="code" href="classtx__srfeuserregister__pi1.html#o9">$conf</a>/';
<a name="l00198"></a>00198         }
<a name="l00199"></a>00199 
<a name="l00200"></a>00200                 $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a36">memberExpiryInit</a>(); <span class="comment">//js</span>
<a name="l00201"></a>00201 
<a name="l00202"></a>00202                 <span class="comment">// get the table definition</span>
<a name="l00203"></a>00203                 $GLOBALS['TSFE']-&gt;includeTCA();
<a name="l00204"></a>00204                 t3lib_div::loadTCA($this-&gt;theTable);
<a name="l00205"></a>00205                 $this-&gt;TCA = $GLOBALS['TCA'][$this-&gt;theTable];
<a name="l00206"></a>00206                  
<a name="l00207"></a>00207                 <span class="comment">// prepare for character set settings and conversions</span>
<a name="l00208"></a>00208                 $this-&gt;typoVersion = t3lib_div::int_from_ver($GLOBALS['TYPO_VERSION']);
<a name="l00209"></a>00209                 <span class="keywordflow">if</span> ($this-&gt;typoVersion &gt;= 3006000 ) {
<a name="l00210"></a>00210                         <span class="keywordflow">if</span> (trim($GLOBALS['TSFE']-&gt;config['config']['metaCharset'])) {
<a name="l00211"></a>00211                                 $this-&gt;charset = $GLOBALS['TSFE']-&gt;csConvObj-&gt;parse_charset($GLOBALS['TSFE']-&gt;config['config']['metaCharset']);
<a name="l00212"></a>00212                         }
<a name="l00213"></a>00213                 }
<a name="l00214"></a>00214 
<a name="l00215"></a>00215                 <span class="comment">// prepare for handling dates befor 1970</span>
<a name="l00216"></a>00216                 $this-&gt;adodbTime = t3lib_div::makeInstance('tx_srfeuserregister_pi1_adodb_time');
<a name="l00217"></a>00217                  
<a name="l00218"></a>00218                 <span class="comment">// set the pid's and the title language overlay</span>
<a name="l00219"></a>00219                 $this-&gt;pidRecord = t3lib_div::makeInstance('t3lib_pageSelect');
<a name="l00220"></a>00220                 $this-&gt;pidRecord-&gt;init(0);
<a name="l00221"></a>00221                 $this-&gt;pidRecord-&gt;sys_language_uid = (trim($GLOBALS['TSFE']-&gt;config['config']['sys_language_uid'])) ? trim($GLOBALS['TSFE']-&gt;config['config']['sys_language_uid']) :
<a name="l00222"></a>00222                 0;
<a name="l00223"></a>00223                 $this-&gt;thePid = intval($this-&gt;conf['pid']) ? intval($this-&gt;conf['pid']) :
<a name="l00224"></a>00224                 $GLOBALS['TSFE']-&gt;id;
<a name="l00225"></a>00225                 $row = $this-&gt;pidRecord-&gt;getPage($this-&gt;thePid);
<a name="l00226"></a>00226                 $this-&gt;thePidTitle = $row['title'];
<a name="l00227"></a>00227                 $this-&gt;registerPID = intval($this-&gt;conf['registerPID']) ? intval($this-&gt;conf['registerPID']) :
<a name="l00228"></a>00228                 $GLOBALS['TSFE']-&gt;id;
<a name="l00229"></a>00229                 $this-&gt;editPID = intval($this-&gt;conf['editPID']) ? intval($this-&gt;conf['editPID']) :
<a name="l00230"></a>00230                 $GLOBALS['TSFE']-&gt;id;
<a name="l00231"></a>00231                 $this-&gt;confirmPID = intval($this-&gt;conf['confirmPID']) ? intval($this-&gt;conf['confirmPID']) :
<a name="l00232"></a>00232                 $this-&gt;registerPID;
<a name="l00233"></a>00233                 $this-&gt;confirmType = intval($this-&gt;conf['confirmType']) ? intval($this-&gt;conf['confirmType']) :
<a name="l00234"></a>00234                 $GLOBALS['TSFE']-&gt;type;
<a name="l00235"></a>00235                 <span class="keywordflow">if</span> ($this-&gt;conf['confirmType'] == 0 ) {
<a name="l00236"></a>00236                         $this-&gt;confirmType = 0;
<a name="l00237"></a>00237                 };
<a name="l00238"></a>00238                 $this-&gt;loginPID = intval($this-&gt;conf['loginPID']) ? intval($this-&gt;conf['loginPID']) :
<a name="l00239"></a>00239                 $GLOBALS['TSFE']-&gt;id;
<a name="l00240"></a>00240                  
<a name="l00241"></a>00241                 <span class="comment">// Initialise static info library</span>
<a name="l00242"></a>00242                 $this-&gt;staticInfo = t3lib_div::makeInstance('tx_srstaticinfo_pi1');
<a name="l00243"></a>00243                 $this-&gt;staticInfo-&gt;init();
<a name="l00244"></a>00244                  
<a name="l00245"></a>00245                 <span class="comment">// Initialise fileFunc object</span>
<a name="l00246"></a>00246                 $this-&gt;fileFunc = t3lib_div::makeInstance('t3lib_basicFileFunctions');
<a name="l00247"></a>00247                  
<a name="l00248"></a>00248                 <span class="comment">// Get post parameters</span>
<a name="l00249"></a>00249                 <span class="keywordflow">if</span> ($this-&gt;typoVersion &gt;= 3006000 ) {
<a name="l00250"></a>00250                         $this-&gt;feUserData = t3lib_div::_GP($this-&gt;prefixId);
<a name="l00251"></a>00251                         $fe = t3lib_div::_GP('FE');
<a name="l00252"></a>00252                 } <span class="keywordflow">else</span> {
<a name="l00253"></a>00253                         $this-&gt;feUserData = t3lib_div::slashArray(t3lib_div::GPvar($this-&gt;prefixId), 'strip');
<a name="l00254"></a>00254                         $fe = t3lib_div::GPvar('FE');
<a name="l00255"></a>00255                 };
<a name="l00256"></a>00256                 $this-&gt;dataArr = $fe[$this-&gt;theTable];
<a name="l00257"></a>00257         <span class="keywordflow">if</span> ( $this-&gt;debug )
<a name="l00258"></a>00258         {
<a name="l00259"></a>00259             cbPrint2( '$this-&gt;dataArr', $this-&gt;dataArr );
<a name="l00260"></a>00260         }
<a name="l00261"></a>00261 
<a name="l00262"></a>00262                         <span class="comment">// Establishing compatibility with Direct Mail extension</span>
<a name="l00263"></a>00263                 $this-&gt;feUserData['rU'] = t3lib_div::GPvar('rU') ? t3lib_div::GPvar('rU') : $this-&gt;feUserData['rU'];
<a name="l00264"></a>00264                 $this-&gt;feUserData['aC'] = t3lib_div::GPvar('aC') ? t3lib_div::GPvar('aC') : $this-&gt;feUserData['aC'];
<a name="l00265"></a>00265                 $this-&gt;feUserData['cmd'] = t3lib_div::GPvar('cmd') ? t3lib_div::GPvar('cmd') : $this-&gt;feUserData['cmd'];
<a name="l00266"></a>00266 
<a name="l00267"></a>00267                 $this-&gt;backURL = $this-&gt;feUserData['backURL'];
<a name="l00268"></a>00268                 $this-&gt;recUid = intval($this-&gt;feUserData['rU']);
<a name="l00269"></a>00269                 $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a6">authCode</a> = $this-&gt;feUserData['aC'];
<a name="l00270"></a>00270                  
<a name="l00271"></a>00271                 <span class="comment">// Setting cmd and various switches</span>
<a name="l00272"></a>00272                 <span class="keywordflow">if</span> ( $this-&gt;theTable == 'fe_users' &amp;&amp; $this-&gt;feUserData['cmd'] == 'login' ) {
<a name="l00273"></a>00273                         unset($this-&gt;feUserData['cmd']);
<a name="l00274"></a>00274                 }
<a name="l00275"></a>00275                 $this-&gt;cmd = $this-&gt;feUserData['cmd'] ? $this-&gt;feUserData['cmd'] :
<a name="l00276"></a>00276                         strtolower($this-&gt;cObj-&gt;data['select_key']);
<a name="l00277"></a>00277                 $this-&gt;cmd = $this-&gt;cmd ? $this-&gt;cmd :
<a name="l00278"></a>00278                         strtolower($this-&gt;conf['defaultCODE']) ;
<a name="l00279"></a>00279                 <span class="keywordflow">if</span> ($this-&gt;cmd == 'edit' ) {
<a name="l00280"></a>00280                         $this-&gt;cmdKey = 'edit';
<a name="l00281"></a>00281                 } <span class="keywordflow">else</span> {
<a name="l00282"></a>00282                         $this-&gt;cmdKey = 'create';
<a name="l00283"></a>00283                 }
<a name="l00284"></a>00284                 <span class="keywordflow">if</span> (!($this-&gt;conf['<a class="code" href="classtx__srfeuserregister__pi1.html#a54">setfixed</a>'] == 1) ) {
<a name="l00285"></a>00285                         $this-&gt;setfixedEnabled = 0;
<a name="l00286"></a>00286                 }
<a name="l00287"></a>00287                 <span class="keywordflow">if</span> (!($this-&gt;conf['email.'][HTMLMail] == 1) ) {
<a name="l00288"></a>00288                         $this-&gt;HTMLMailEnabled = 0;
<a name="l00289"></a>00289                 }
<a name="l00290"></a>00290                 $this-&gt;preview = $this-&gt;feUserData['preview'];
<a name="l00291"></a>00291                 <span class="comment">// Setting the list of fields allowed for editing and creation.</span>
<a name="l00292"></a>00292                 $this-&gt;fieldList = implode(<span class="charliteral">','</span>, t3lib_div::trimExplode(<span class="charliteral">','</span>, $GLOBALS['TCA'][$this-&gt;theTable]['feInterface']['fe_admin_fieldList'], 1));
<a name="l00293"></a>00293                 $this-&gt;adminFieldList = implode(<span class="charliteral">','</span>, array_intersect( explode(<span class="charliteral">','</span>, $this-&gt;fieldList), t3lib_div::trimExplode(<span class="charliteral">','</span>, $this-&gt;adminFieldList, 1) ));
<a name="l00294"></a>00294                  
<a name="l00295"></a>00295                 <span class="comment">// Setting requiredArr to the fields in "required" intersected field the total field list in order to remove invalid fields.</span>
<a name="l00296"></a>00296                 $this-&gt;requiredArr = array_intersect(t3lib_div::trimExplode(<span class="charliteral">','</span>, $this-&gt;conf[$this-&gt;cmdKey.<span class="charliteral">'.'</span>]['required'], 1),
<a name="l00297"></a>00297                         t3lib_div::trimExplode(<span class="charliteral">','</span>, $this-&gt;conf[$this-&gt;cmdKey.<span class="charliteral">'.'</span>]['fields'], 1)
<a name="l00298"></a>00298                 );
<a name="l00299"></a>00299                  
<a name="l00300"></a>00300                 <span class="comment">// Setting the authCode length</span>
<a name="l00301"></a>00301                 $this-&gt;codeLength = intval($this-&gt;conf['authcodeFields.']['codeLength']) ? intval($this-&gt;conf['authcodeFields.']['codeLength']) :
<a name="l00302"></a>00302                 8;
<a name="l00303"></a>00303                  
<a name="l00304"></a>00304                 <span class="comment">// Setting the record uid if a frontend user is logged in and we are nor trying to send an invitation</span>
<a name="l00305"></a>00305                 <span class="keywordflow">if</span> ($this-&gt;theTable == 'fe_users' &amp;&amp; $GLOBALS['TSFE']-&gt;loginUser &amp;&amp; $this-&gt;cmd != 'invite') {
<a name="l00306"></a>00306                         $this-&gt;recUid = $GLOBALS['TSFE']-&gt;fe_user-&gt;user['uid'];
<a name="l00307"></a>00307                 }
<a name="l00308"></a>00308                  
<a name="l00309"></a>00309                 <span class="comment">// Fetching the template file</span>
<a name="l00310"></a>00310                 $this-&gt;templateCode = $this-&gt;cObj-&gt;fileResource($this-&gt;conf['templateFile']);
<a name="l00311"></a>00311                  
<a name="l00312"></a>00312                 <span class="comment">// Set globally substituted markers, fonts and colors.</span>
<a name="l00313"></a>00313                 $splitMark = md5(microtime());
<a name="l00314"></a>00314                 list($this-&gt;markerArray['###GW1B###'], $this-&gt;markerArray['###GW1E###']) = explode($splitMark, $this-&gt;cObj-&gt;stdWrap($splitMark, $this-&gt;conf['wrap1.']));
<a name="l00315"></a>00315                 list($this-&gt;markerArray['###GW2B###'], $this-&gt;markerArray['###GW2E###']) = explode($splitMark, $this-&gt;cObj-&gt;stdWrap($splitMark, $this-&gt;conf['wrap2.']));
<a name="l00316"></a>00316                 list($this-&gt;markerArray['###GW3B###'], $this-&gt;markerArray['###GW3E###']) = explode($splitMark, $this-&gt;cObj-&gt;stdWrap($splitMark, $this-&gt;conf['wrap3.']));
<a name="l00317"></a>00317                 $this-&gt;markerArray['###GC1###'] = $this-&gt;cObj-&gt;stdWrap($this-&gt;conf['color1'], $this-&gt;conf['color1.']);
<a name="l00318"></a>00318                 $this-&gt;markerArray['###GC2###'] = $this-&gt;cObj-&gt;stdWrap($this-&gt;conf['color2'], $this-&gt;conf['color2.']);
<a name="l00319"></a>00319                 $this-&gt;markerArray['###GC3###'] = $this-&gt;cObj-&gt;stdWrap($this-&gt;conf['color3'], $this-&gt;conf['color3.']);
<a name="l00320"></a>00320                 $this-&gt;markerArray['###CHARSET###'] = $this-&gt;charset;
<a name="l00321"></a>00321                 $this-&gt;markerArray['###PREFIXID###'] = $this-&gt;prefixId;
<a name="l00322"></a>00322                  
<a name="l00323"></a>00323                 <span class="comment">// Setting URL, HIDDENFIELDS and signature markers</span>
<a name="l00324"></a>00324                 $this-&gt;markerArray = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a5">addURLMarkers</a>($this-&gt;markerArray);
<a name="l00325"></a>00325                  
<a name="l00326"></a>00326                 <span class="comment">// Setting CSS style markers if required</span>
<a name="l00327"></a>00327                 <span class="keywordflow">if</span> ($this-&gt;HTMLMailEnabled) {
<a name="l00328"></a>00328                         $this-&gt;markerArray = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a1">addCSSStyleMarkers</a>($this-&gt;markerArray);
<a name="l00329"></a>00329                 }
<a name="l00330"></a>00330                  
<a name="l00331"></a>00331                 <span class="comment">// *****************</span>
<a name="l00332"></a>00332                 <span class="comment">// If data is submitted, we take care of it here.</span>
<a name="l00333"></a>00333                 <span class="comment">// *******************</span>
<a name="l00334"></a>00334                 <span class="keywordflow">if</span> ($this-&gt;cmd == '<span class="keyword">delete</span>' &amp;&amp; !$this-&gt;feUserData['preview'] &amp;&amp; !$this-&gt;feUserData['doNotSave'] ) {
<a name="l00335"></a>00335                         <span class="comment">// Delete record if delete command is sent + the preview flag is NOT set.</span>
<a name="l00336"></a>00336 
<a name="l00337"></a>00337                         $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a15">deleteRecord</a>();
<a name="l00338"></a>00338                 }
<a name="l00339"></a>00339 
<a name="l00340"></a>00340                 <span class="comment">// Evaluate incoming data</span>
<a name="l00341"></a>00341                 <span class="keywordflow">if</span> (is_array($this-&gt;dataArr)) {
<a name="l00342"></a>00342                         $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a56">setName</a>();
<a name="l00343"></a>00343                         $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a42">parseValues</a>();
<a name="l00344"></a>00344                         $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a39">overrideValues</a>();
<a name="l00345"></a>00345                         <span class="keywordflow">if</span> ($this-&gt;feUserData['submit'] || $this-&gt;feUserData['doNotSave'] )
<a name="l00346"></a>00346                         {
<a name="l00347"></a>00347                                 <span class="comment">// MLC require credit card details</span>
<a name="l00348"></a>00348                                 <span class="keywordflow">if</span> ( 'credit_card' == $this-&gt;dataArr[ 'payment_method' ] )
<a name="l00349"></a>00349                                 {
<a name="l00350"></a>00350                                         $this-&gt;requiredArr[]    = 'cc_type';
<a name="l00351"></a>00351                                         $this-&gt;requiredArr[]    = 'cc_number';
<a name="l00352"></a>00352                                         $this-&gt;requiredArr[]    = 'cc_expiry';
<a name="l00353"></a>00353                                         $this-&gt;requiredArr[]    = 'cc_name';
<a name="l00354"></a>00354                                 }
<a name="l00355"></a>00355 
<a name="l00356"></a>00356                                 <span class="keywordflow">if</span> ($this-&gt;conf['evalFunc'] ) {
<a name="l00357"></a>00357                                         $this-&gt;dataArr = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a61">userProcess</a>('evalFunc', $this-&gt;dataArr);
<a name="l00358"></a>00358                                 }
<a name="l00359"></a>00359 
<a name="l00360"></a>00360                                 <span class="comment">// MLC set referrer</span>
<a name="l00361"></a>00361                                 <span class="keywordflow">if</span> ( '' == $this-&gt;dataArr[ 'referrer_uri' ] )
<a name="l00362"></a>00362                                 {
<a name="l00363"></a>00363                                         <span class="comment">// MLC check that site_url is part of refrerre</span>
<a name="l00364"></a>00364                                         <span class="comment">// else go home</span>
<a name="l00365"></a>00365                                         $siteClean      = preg_quote( $this-&gt;site_url );
<a name="l00366"></a>00366 
<a name="l00367"></a>00367                                         <span class="keywordflow">if</span> ( preg_match( <span class="charliteral">'#'</span> . $siteClean . '#i'
<a name="l00368"></a>00368                                                 , $_SERVER[ 'HTTP_REFERER' ]
<a name="l00369"></a>00369                                                 )
<a name="l00370"></a>00370                                         )
<a name="l00371"></a>00371                                         {
<a name="l00372"></a>00372                                                 $this-&gt;dataArr[ 'referrer_uri' ] =
<a name="l00373"></a>00373                                                         $_SERVER[ 'HTTP_REFERER' ];
<a name="l00374"></a>00374                                         }
<a name="l00375"></a>00375 
<a name="l00376"></a>00376                                         <span class="keywordflow">else</span>
<a name="l00377"></a>00377                                         {
<a name="l00378"></a>00378                                                 $this-&gt;dataArr[ 'referrer_uri' ] =
<a name="l00379"></a>00379                                                         $this-&gt;site_url;
<a name="l00380"></a>00380                                         }
<a name="l00381"></a>00381                                 }
<a name="l00382"></a>00382 
<a name="l00383"></a>00383                                 <span class="comment">// MLC set endtime about x days later per timelimit</span>
<a name="l00384"></a>00384                                 <span class="keywordflow">if</span> ( '' != $this-&gt;conf[ 'timelimit' ] )
<a name="l00385"></a>00385                                 {
<a name="l00386"></a>00386                                         $now            = time();
<a name="l00387"></a>00387                                         $later          = $now
<a name="l00388"></a>00388                                                                         + ( $this-&gt;conf[ 'timelimit' ]
<a name="l00389"></a>00389                                                                                 * 24 * 60 * 60 
<a name="l00390"></a>00390                                                                         );
<a name="l00391"></a>00391 
<a name="l00392"></a>00392                                         $this-&gt;dataArr[ 'endtime' ]     = $later;
<a name="l00393"></a>00393                                 }
<a name="l00394"></a>00394 
<a name="l00395"></a>00395                                 <span class="comment">// MLC create psuedo username and pasword</span>
<a name="l00396"></a>00396                                 <span class="comment">// form has been submitted</span>
<a name="l00397"></a>00397                                 <span class="keywordflow">if</span> ( 'tempuser' == $this-&gt;cmd )
<a name="l00398"></a>00398                                 {
<a name="l00399"></a>00399                                         $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a11">createTempuser</a>();
<a name="l00400"></a>00400                                 }
<a name="l00401"></a>00401 
<a name="l00402"></a>00402                                 <span class="comment">// MLC set start/end time based upon create/edit and group</span>
<a name="l00403"></a>00403                                 <span class="keywordflow">if</span> ( 'create' == $this-&gt;cmd || 'edit' == $this-&gt;cmd )
<a name="l00404"></a>00404                                 {
<a name="l00405"></a>00405                                         $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a57">setStartEndTime</a>();
<a name="l00406"></a>00406                                 }
<a name="l00407"></a>00407 
<a name="l00408"></a>00408                                 <span class="comment">// MLC modifiy the usergroup with an override</span>
<a name="l00409"></a>00409                                 <span class="keywordflow">if</span> ( '' != $this-&gt;conf[ 'userGroupUponRegistration' ] )
<a name="l00410"></a>00410                                 {
<a name="l00411"></a>00411                                         <span class="comment">// lookup current, create array</span>
<a name="l00412"></a>00412 <span class="comment">//                                      $usergroup      = $GLOBALS['TSFE']-&gt;fe_user-&gt;user['usergroup'];</span>
<a name="l00413"></a>00413 <span class="comment">//                                      $usergroup      = explode( ',', $usergroup );</span>
<a name="l00414"></a>00414 <span class="comment">//</span>
<a name="l00415"></a>00415 <span class="comment">//                                      $ugNew          = explode( ','</span>
<a name="l00416"></a>00416 <span class="comment">//                                                                      , $this-&gt;conf[ 'userGroupUponRegistration' ]</span>
<a name="l00417"></a>00417 <span class="comment">//                                                              );</span>
<a name="l00418"></a>00418 <span class="comment">//</span>
<a name="l00419"></a>00419 <span class="comment">//                                      $ugNew          = array_merge( $usergroup, $ugNew );</span>
<a name="l00420"></a>00420 <span class="comment">//                                      $ugNew          = array_unique( $ugNew );</span>
<a name="l00421"></a>00421 <span class="comment">//                                      $ugNew          = implode( ',', $ugNew );</span>
<a name="l00422"></a>00422 
<a name="l00423"></a>00423                                         $this-&gt;dataArr[ 'usergroup' ]   =
<a name="l00424"></a>00424                                                                         $this-&gt;conf[ 'userGroupUponRegistration' ];
<a name="l00425"></a>00425                                 }
<a name="l00426"></a>00426 
<a name="l00427"></a>00427                                 <span class="comment">// MLC append usergroup</span>
<a name="l00428"></a>00428                                 <span class="keywordflow">if</span> ( '' != $this-&gt;dataArr[ 'usergroupaddon' ]
<a name="l00429"></a>00429                                         &amp;&amp; ! preg_match(
<a name="l00430"></a>00430                                                 <span class="charliteral">'#'</span> . $this-&gt;dataArr[ 'usergroupaddon' ] . <span class="charliteral">'#'</span>
<a name="l00431"></a>00431                                                 , $this-&gt;dataArr[ 'usergroup' ]
<a name="l00432"></a>00432                                         )
<a name="l00433"></a>00433                                 )
<a name="l00434"></a>00434                                 {
<a name="l00435"></a>00435                                         $prepend                = '';
<a name="l00436"></a>00436 
<a name="l00437"></a>00437                                         <span class="keywordflow">if</span> ( '' != $this-&gt;dataArr[ 'usergroup' ] )
<a name="l00438"></a>00438                                         {
<a name="l00439"></a>00439                                                 $prepend        = <span class="charliteral">','</span>;
<a name="l00440"></a>00440                                         }
<a name="l00441"></a>00441 
<a name="l00442"></a>00442                                         $this-&gt;dataArr[ 'usergroup' ]   .= $prepend
<a name="l00443"></a>00443                                                                 . $this-&gt;dataArr[ 'usergroupaddon' ];
<a name="l00444"></a>00444                                 }
<a name="l00445"></a>00445 
<a name="l00446"></a>00446                                 <span class="comment">// a button was clicked on</span>
<a name="l00447"></a>00447                                 $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a25">evalValues</a>();
<a name="l00448"></a>00448 
<a name="l00449"></a>00449                                 <span class="keywordflow">if</span> ( $this-&gt;debug )
<a name="l00450"></a>00450                                 {
<a name="l00451"></a>00451                                         cbPrint2( '$this-&gt;dataArr', $this-&gt;dataArr );
<a name="l00452"></a>00452                                 }
<a name="l00453"></a>00453                         } <span class="keywordflow">else</span> {
<a name="l00454"></a>00454                                 <span class="comment">//this is either a country change submitted through the onchange event! or a file deletion already processed by the parsing function</span>
<a name="l00455"></a>00455                                 <span class="comment">// we are going to redisplay</span>
<a name="l00456"></a>00456                                 $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a25">evalValues</a>();
<a name="l00457"></a>00457                                 $this-&gt;failure = 1;
<a name="l00458"></a>00458                         }
<a name="l00459"></a>00459                         <span class="keywordflow">if</span> (!$this-&gt;failure &amp;&amp; !$this-&gt;feUserData['preview'] &amp;&amp; !$this-&gt;feUserData['doNotSave'] ) {
<a name="l00460"></a>00460                                 $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a49">save</a>();
<a name="l00461"></a>00461                 
<a name="l00462"></a>00462                                 <span class="keywordflow">if</span> ( $this-&gt;debug )
<a name="l00463"></a>00463                                 {
<a name="l00464"></a>00464                                         cbPrint2( '$this-&gt;dataArr', $this-&gt;dataArr );
<a name="l00465"></a>00465                                 }
<a name="l00466"></a>00466                         }
<a name="l00467"></a>00467                 } <span class="keywordflow">else</span> {
<a name="l00468"></a>00468                         $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a13">defaultValues</a>(); <span class="comment">// If no incoming data, this will set the default values.</span>
<a name="l00469"></a>00469                         $this-&gt;feUserData['preview'] = 0; <span class="comment">// No preview if data is not received</span>
<a name="l00470"></a>00470                 }
<a name="l00471"></a>00471                 <span class="keywordflow">if</span> ($this-&gt;failure ) {
<a name="l00472"></a>00472                         $this-&gt;feUserData['preview'] = 0;
<a name="l00473"></a>00473                         
<a name="l00474"></a>00474                         <span class="keywordflow">if</span> ($this-&gt;debug)  <span class="stringliteral">"Failure:"</span>;
<a name="l00475"></a>00475                         <span class="comment">//log the error - js</span>
<a name="l00476"></a>00476                         $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a34">logRegistrationErrors</a>();
<a name="l00477"></a>00477                         
<a name="l00478"></a>00478                 } <span class="comment">// No preview flag if a evaluation failure has occured</span>
<a name="l00479"></a>00479                 $this-&gt;previewLabel = ($this-&gt;feUserData['preview']) ? '_PREVIEW' :
<a name="l00480"></a>00480                 ''; <span class="comment">// Setting preview template label suffix.</span>
<a name="l00481"></a>00481                  
<a name="l00482"></a>00482                 <span class="comment">// Display forms</span>
<a name="l00483"></a>00483                 <span class="keywordflow">if</span> ($this-&gt;saved) {
<a name="l00484"></a>00484                         <span class="comment">// Displaying the page here that says, the record has been saved. You're able to include the saved values by markers.</span>
<a name="l00485"></a>00485                         <span class="keywordflow">switch</span>($this-&gt;cmd) {
<a name="l00486"></a>00486                                 <span class="keywordflow">case</span> '<span class="keyword">delete</span>':
<a name="l00487"></a>00487                                 $key = 'DELETE'.$this-&gt;savedSuffix;
<a name="l00488"></a>00488                                 <span class="keywordflow">break</span>;
<a name="l00489"></a>00489                                 <span class="keywordflow">case</span> 'edit':
<a name="l00490"></a>00490                                 $key = 'EDIT'.$this-&gt;savedSuffix;
<a name="l00491"></a>00491                                 <span class="keywordflow">break</span>;
<a name="l00492"></a>00492                                 <span class="keywordflow">case</span> 'invite':
<a name="l00493"></a>00493                                 $key = $this-&gt;setfixedPrefix.'INVITE';
<a name="l00494"></a>00494                                 <span class="keywordflow">break</span>;
<a name="l00495"></a>00495                                 <span class="keywordflow">default</span>:
<a name="l00496"></a>00496                                 <span class="keywordflow">if</span> ($this-&gt;setfixedEnabled ) {
<a name="l00497"></a>00497                                         $key = $this-&gt;setfixedPrefix.'CREATE';
<a name="l00498"></a>00498                                 } <span class="keywordflow">else</span> {
<a name="l00499"></a>00499                                         $key = 'CREATE'.$this-&gt;savedSuffix;
<a name="l00500"></a>00500                                 }
<a name="l00501"></a>00501                                 <span class="keywordflow">break</span>;
<a name="l00502"></a>00502                         }
<a name="l00503"></a>00503 
<a name="l00504"></a>00504                         <span class="comment">// Display confirmation message</span>
<a name="l00505"></a>00505                         <a class="code" href="classtx__srfeuserregister__pi1.html#o44">$templateCode</a> = $this-&gt;cObj-&gt;getSubpart($this-&gt;templateCode, '###TEMPLATE_'.$key.'###');
<a name="l00506"></a>00506                         <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a> = $this-&gt;cObj-&gt;fillInMarkerArray($this-&gt;markerArray, $this-&gt;currentArr);
<a name="l00507"></a>00507                         <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a> = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a4">addStaticInfoMarkers</a>($markerArray, $this-&gt;currentArr);
<a name="l00508"></a>00508                         <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a> = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a3">addLabelMarkers</a>($markerArray, $this-&gt;currentArr);
<a name="l00509"></a>00509                         $content = $this-&gt;cObj-&gt;substituteMarkerArray($templateCode, $markerArray);
<a name="l00510"></a>00510                          
<a name="l00511"></a>00511                         <span class="comment">// MLC send mail prior to redirect or displaying form</span>
<a name="l00512"></a>00512                         <span class="comment">// Send email message(s)</span>
<a name="l00513"></a>00513                         $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a9">compileMail</a>($key, array($this-&gt;currentArr), $this-&gt;currentArr[$this-&gt;conf['email.']['field']], $this-&gt;conf['<a class="code" href="classtx__srfeuserregister__pi1.html#a54">setfixed</a>.']);
<a name="l00514"></a>00514                          
<a name="l00515"></a>00515                         <span class="comment">// MLC redirect saved tempuser</span>
<a name="l00516"></a>00516                         <span class="keywordflow">if</span> ( $key == 'CREATE_SAVED'
<a name="l00517"></a>00517                                 &amp;&amp; $this-&gt;cmd == 'tempuser'
<a name="l00518"></a>00518                                 &amp;&amp; $this-&gt;conf[ 'enableAutoLoginTempuser' ]
<a name="l00519"></a>00519                         ) 
<a name="l00520"></a>00520                         {
<a name="l00521"></a>00521                                 $loginVars = array();
<a name="l00522"></a>00522                                 $loginVars['pid'] = $this-&gt;thePid;
<a name="l00523"></a>00523                                 $loginVars['logintype'] = 'login';
<a name="l00524"></a>00524                                 $loginVars['redirect_url'] = htmlspecialchars( trim(
<a name="l00525"></a>00525                                         $this-&gt;dataArr[ 'referrer_uri' ] )
<a name="l00526"></a>00526                                 );
<a name="l00527"></a>00527                                 $loginVars['user'] = $this-&gt;dataArr['username'];
<a name="l00528"></a>00528                                 $loginVars['pass'] = $this-&gt;dataArr['password'];
<a name="l00529"></a>00529 
<a name="l00530"></a>00530                                 <span class="comment">// MLC review loginVars</span>
<a name="l00531"></a>00531                                 <span class="keywordflow">if</span> ( $this-&gt;debug )
<a name="l00532"></a>00532                                 {
<a name="l00533"></a>00533                                         cbPrint2( 'loginVars', $loginVars );
<a name="l00534"></a>00534 
<a name="l00535"></a>00535                                         cbPrint2( 'location', 'Location: '.t3lib_div::locationHeaderUrl($this-&gt;site_url.$this-&gt;cObj-&gt;getTypoLink_URL($this-&gt;loginPID.<span class="charliteral">','</span>.$GLOBALS['TSFE']-&gt;type, $loginVars)));
<a name="l00536"></a>00536                                         exit;
<a name="l00537"></a>00537                                 }
<a name="l00538"></a>00538 
<a name="l00539"></a>00539                                 header('Location: '.t3lib_div::locationHeaderUrl($this-&gt;site_url.$this-&gt;cObj-&gt;getTypoLink_URL($this-&gt;loginPID.<span class="charliteral">','</span>.$GLOBALS['TSFE']-&gt;type, $loginVars)));
<a name="l00540"></a>00540                                 exit;
<a name="l00541"></a>00541                         }
<a name="l00542"></a>00542                 } elseif ($this-&gt;error) {
<a name="l00543"></a>00543                         <span class="comment">// If there was an error, we return the template-subpart with the error message</span>
<a name="l00544"></a>00544                         <a class="code" href="classtx__srfeuserregister__pi1.html#o44">$templateCode</a> = $this-&gt;cObj-&gt;getSubpart($this-&gt;templateCode, $this-&gt;error);
<a name="l00545"></a>00545                         $this-&gt;setCObjects($templateCode);
<a name="l00546"></a>00546                         $content = $this-&gt;cObj-&gt;substituteMarkerArray($templateCode, $this-&gt;markerArray);
<a name="l00547"></a>00547                 } <span class="keywordflow">else</span> {
<a name="l00548"></a>00548                         <span class="comment">// Finally, if there has been no attempt to save. That is either preview or just displaying and empty or not correctly filled form:</span>
<a name="l00549"></a>00549                         <span class="keywordflow">switch</span>($this-&gt;cmd) {
<a name="l00550"></a>00550                                 <span class="keywordflow">case</span> '<a class="code" href="classtx__srfeuserregister__pi1.html#a54">setfixed</a>':
<a name="l00551"></a>00551                                 $content = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a43">procesSetFixed</a>();
<a name="l00552"></a>00552                                 <span class="keywordflow">break</span>;
<a name="l00553"></a>00553                                 <span class="keywordflow">case</span> 'infomail':
<a name="l00554"></a>00554                                 $content = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a51">sendInfoMail</a>();
<a name="l00555"></a>00555                                 <span class="keywordflow">break</span>;
<a name="l00556"></a>00556                                 <span class="keywordflow">case</span> '<span class="keyword">delete</span>':
<a name="l00557"></a>00557                                 $content = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a17">displayDeleteScreen</a>();
<a name="l00558"></a>00558                                 <span class="keywordflow">break</span>;
<a name="l00559"></a>00559                                 <span class="keywordflow">case</span> 'edit':
<a name="l00560"></a>00560                                 $content = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a19">displayEditScreen</a>();
<a name="l00561"></a>00561                                 <span class="keywordflow">break</span>;
<a name="l00562"></a>00562                                 <span class="keywordflow">case</span> 'invite':
<a name="l00563"></a>00563                                 $content = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a16">displayCreateScreen</a>($this-&gt;cmd);
<a name="l00564"></a>00564                                 <span class="keywordflow">break</span>;
<a name="l00565"></a>00565                                 <span class="comment">// MLC allow for tempuser creation</span>
<a name="l00566"></a>00566                                 <span class="keywordflow">case</span> 'tempuser':
<a name="l00567"></a>00567                                 <span class="keywordflow">case</span> 'create':
<a name="l00568"></a>00568                                 $content = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a16">displayCreateScreen</a>($this-&gt;cmd);
<a name="l00569"></a>00569                                 <span class="keywordflow">break</span>;
<a name="l00570"></a>00570                                 <span class="keywordflow">default</span>:
<a name="l00571"></a>00571                                 <span class="keywordflow">if</span> ($this-&gt;theTable == 'fe_users' &amp;&amp; $GLOBALS['TSFE']-&gt;loginUser) {
<a name="l00572"></a>00572                                         $content = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a16">displayCreateScreen</a>($this-&gt;cmd);
<a name="l00573"></a>00573                                 } <span class="keywordflow">else</span> {
<a name="l00574"></a>00574                                         $content = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a19">displayEditScreen</a>();
<a name="l00575"></a>00575                                 }
<a name="l00576"></a>00576                                 <span class="keywordflow">break</span>;
<a name="l00577"></a>00577                         }
<a name="l00578"></a>00578                 }
<a name="l00579"></a>00579 
<a name="l00580"></a>00580                 <span class="comment">// MLC delete the cc info from database as needed</span>
<a name="l00581"></a>00581                 <span class="keywordflow">if</span> ( $this-&gt;dataArr[ 'cc_number' ] 
<a name="l00582"></a>00582                         &amp;&amp; ! $this-&gt;conf[ 'enableCreditcardSave' ]
<a name="l00583"></a>00583                 )
<a name="l00584"></a>00584                 {
<a name="l00585"></a>00585                         $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a46">removeCreditcard</a>( $this-&gt;dataArr );
<a name="l00586"></a>00586                 }
<a name="l00587"></a>00587                 
<a name="l00588"></a>00588                 <span class="keywordflow">return</span> $this-&gt;pi_wrapInBaseClass($content);
<a name="l00589"></a>00589         }
<a name="l00590"></a>00590          
<a name="l00591"></a>00591         
<a name="l00595"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a36">00595</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a36">memberExpiryInit</a>() {
<a name="l00596"></a>00596                 
<a name="l00597"></a>00597                 <span class="keywordflow">if</span> ($this-&gt;debug) {
<a name="l00598"></a>00598                         echo '<a class="code" href="classtx__srfeuserregister__pi1.html#a36">memberExpiryInit</a>()';
<a name="l00599"></a>00599                         echo $this-&gt;conf;
<a name="l00600"></a>00600 
<a name="l00601"></a>00601                         echo <span class="stringliteral">"&lt;br&gt;\n this-&gt;memberExpiryProcessing = "</span> . $this-&gt;memberExpiryProcessing .<span class="stringliteral">"&lt;br&gt;\n"</span>;
<a name="l00602"></a>00602                         echo <span class="stringliteral">" this-&gt;memberAccessProcessing = "</span> . $this-&gt;memberAccessProcessing .<span class="stringliteral">" &lt;br&gt;\n"</span>;
<a name="l00603"></a>00603                         echo <span class="stringliteral">"this-&gt;registrationErrorLogging = "</span>. $this-&gt;registrationErrorLogging .<span class="stringliteral">"&lt;br&gt;\n"</span>;
<a name="l00604"></a>00604                         <span class="keywordflow">if</span> ($this-&gt;registrationErrorLogging  == <span class="keyword">false</span> ) {
<a name="l00605"></a>00605                                 echo <span class="stringliteral">"this-&gt;registrationErrorLogging  turned off"</span>;
<a name="l00606"></a>00606                         }
<a name="l00607"></a>00607                         var_dump($this-&gt;registrationErrorLogging);
<a name="l00608"></a>00608                         
<a name="l00609"></a>00609                 }
<a name="l00610"></a>00610                 
<a name="l00611"></a>00611                 <span class="keywordflow">if</span>(isset($this-&gt;conf['memberExpiryProcessing'])) {
<a name="l00612"></a>00612                         $this-&gt;memberExpiryProcessing = $this-&gt;conf['memberExpiryProcessing'];
<a name="l00613"></a>00613                 }
<a name="l00614"></a>00614                 <span class="keywordflow">if</span>(isset($this-&gt;conf['memberAccessProcessing'])) {
<a name="l00615"></a>00615                         $this-&gt;memberAccessProcessing =  $this-&gt;conf['memberAccessProcessing'];
<a name="l00616"></a>00616                 }
<a name="l00617"></a>00617                 <span class="keywordflow">if</span>(isset($this-&gt;conf['registrationErrorLogging'])) {
<a name="l00618"></a>00618                         $this-&gt;registrationErrorLogging = $this-&gt;conf['registrationErrorLogging'];
<a name="l00619"></a>00619                 }
<a name="l00620"></a>00620 
<a name="l00621"></a>00621                 <span class="keywordflow">if</span> ($this-&gt;debug) {
<a name="l00622"></a>00622                         echo <span class="stringliteral">"&lt;br&gt;\n this-&gt;memberExpiryProcessing = "</span> . $this-&gt;memberExpiryProcessing .<span class="stringliteral">"&lt;br&gt;\n"</span>;
<a name="l00623"></a>00623                         echo <span class="stringliteral">" this-&gt;memberAccessProcessing = "</span> . $this-&gt;memberAccessProcessing .<span class="stringliteral">" &lt;br&gt;\n"</span>;
<a name="l00624"></a>00624                         echo <span class="stringliteral">"this-&gt;registrationErrorLogging = "</span>. $this-&gt;registrationErrorLogging .<span class="stringliteral">"&lt;br&gt;\n"</span>;
<a name="l00625"></a>00625                         <span class="keywordflow">if</span> ($this-&gt;registrationErrorLogging  == <span class="keyword">false</span> ) {
<a name="l00626"></a>00626                                 echo <span class="stringliteral">"this-&gt;registrationErrorLogging  turned off"</span>;
<a name="l00627"></a>00627                         }
<a name="l00628"></a>00628                         <span class="keywordflow">if</span> (1==$this-&gt;registrationErrorLogging){
<a name="l00629"></a>00629                            echo  <span class="stringliteral">"logging RegistrationErrors on"</span>;
<a name="l00630"></a>00630                         }
<a name="l00631"></a>00631                 }
<a name="l00632"></a>00632                 
<a name="l00633"></a>00633         }
<a name="l00634"></a>00634         
<a name="l00641"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a53">00641</a>     function <a class="code" href="classtx__srfeuserregister__pi1.html#a53">setDebugStatus</a>(){
<a name="l00642"></a>00642         <span class="comment">//change the true below to false to always not show debug info</span>
<a name="l00643"></a>00643         <span class="keywordflow">if</span> ( <span class="keyword">true</span> &amp;&amp; '59.94.209.67' == $_SERVER[ 'REMOTE_ADDR' ] ) {
<a name="l00644"></a>00644             $this-&gt;debug = <span class="keyword">true</span>;
<a name="l00645"></a>00645             <span class="comment">//echo 'Remote:59.94.208.61';</span>
<a name="l00646"></a>00646             <span class="comment">//echo 'Join Now.';</span>
<a name="l00647"></a>00647             <span class="comment">//echo $_SERVER[ 'REMOTE_ADDR' ];</span>
<a name="l00648"></a>00648         }
<a name="l00649"></a>00649     }
<a name="l00650"></a>00650     
<a name="l00656"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a25">00656</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a25">evalValues</a>() {
<a name="l00657"></a>00657                 <span class="comment">// Check required, set failure if not ok.</span>
<a name="l00658"></a>00658                 reset($this-&gt;requiredArr);
<a name="l00659"></a>00659                 $tempArr = array();
<a name="l00660"></a>00660                 <span class="keywordflow">while</span> (list(, $theField) = each($this-&gt;requiredArr)) {
<a name="l00661"></a>00661                         <span class="keywordflow">if</span> (!trim($this-&gt;dataArr[$theField])) {
<a name="l00662"></a>00662 
<a name="l00663"></a>00663                                 $tempArr[] = $theField;
<a name="l00664"></a>00664                         }
<a name="l00665"></a>00665                 }
<a name="l00666"></a>00666 
<a name="l00667"></a>00667                 <span class="comment">// Evaluate: This evaluates for more advanced things than "required" does. But it returns the same error code, so you must let the required-message tell, if further evaluation has failed!</span>
<a name="l00668"></a>00668                 $recExist = 0;
<a name="l00669"></a>00669                 <span class="keywordflow">if</span> (is_array($this-&gt;conf[$this-&gt;cmdKey.<span class="charliteral">'.'</span>]['<a class="code" href="classtx__srfeuserregister__pi1.html#a25">evalValues</a>.'])) {
<a name="l00670"></a>00670                         <span class="keywordflow">switch</span>($this-&gt;cmd) {
<a name="l00671"></a>00671                                 <span class="keywordflow">case</span> 'edit':
<a name="l00672"></a>00672                                 <span class="keywordflow">if</span> (isset($this-&gt;dataArr['pid'])) {
<a name="l00673"></a>00673                                          
<a name="l00674"></a>00674                                         <span class="comment">// This may be tricked if the input has the pid-field set but the edit-field list does NOT allow the pid to be edited. Then the pid may be false.</span>
<a name="l00675"></a>00675                                         $recordTestPid = intval($this-&gt;dataArr['pid']);
<a name="l00676"></a>00676                                 } <span class="keywordflow">else</span> {
<a name="l00677"></a>00677                                         $tempRecArr = $GLOBALS['TSFE']-&gt;sys_page-&gt;getRawRecord($this-&gt;theTable, $this-&gt;dataArr[uid]);
<a name="l00678"></a>00678                                         $recordTestPid = intval($tempRecArr['pid']);
<a name="l00679"></a>00679                                 }
<a name="l00680"></a>00680                                 $recExist = 1;
<a name="l00681"></a>00681                                 <span class="keywordflow">break</span>;
<a name="l00682"></a>00682                                 <span class="keywordflow">default</span>:
<a name="l00683"></a>00683                                 $recordTestPid = $this-&gt;thePid ? $this-&gt;thePid :
<a name="l00684"></a>00684                                 t3lib_div::intval_positive($this-&gt;dataArr['pid']);
<a name="l00685"></a>00685                                 <span class="keywordflow">break</span>;
<a name="l00686"></a>00686                         }
<a name="l00687"></a>00687                          
<a name="l00688"></a>00688                         reset($this-&gt;conf[$this-&gt;cmdKey.<span class="charliteral">'.'</span>]['<a class="code" href="classtx__srfeuserregister__pi1.html#a25">evalValues</a>.']);
<a name="l00689"></a>00689                         <span class="keywordflow">while</span> (list($theField, $theValue) = each($this-&gt;conf[$this-&gt;cmdKey.<span class="charliteral">'.'</span>]['<a class="code" href="classtx__srfeuserregister__pi1.html#a25">evalValues</a>.'])) {
<a name="l00690"></a>00690                                 $listOfCommands = t3lib_div::trimExplode(<span class="charliteral">','</span>, $theValue, 1);
<a name="l00691"></a>00691                                 <span class="keywordflow">while</span> (list(, $cmd) = each($listOfCommands)) {
<a name="l00692"></a>00692                                         $cmdParts = split(<span class="stringliteral">"\[|\]"</span>, $cmd); <span class="comment">// Point is to enable parameters after each command enclosed in brackets [..]. These will be in position 1 in the array.</span>
<a name="l00693"></a>00693 
<a name="l00694"></a>00694                                         $theCmd = trim($cmdParts[0]);
<a name="l00695"></a>00695 
<a name="l00696"></a>00696                                         <span class="keywordflow">switch</span>($theCmd) {
<a name="l00697"></a>00697                                                 <span class="keywordflow">case</span> 'uniqueGlobal':
<a name="l00698"></a>00698                                                 <span class="keywordflow">if</span> (trim($this-&gt;dataArr[$theField]) &amp;&amp; $DBrows = $GLOBALS['TSFE']-&gt;sys_page-&gt;getRecordsByField($this-&gt;theTable, $theField, $this-&gt;dataArr[$theField], 'LIMIT 1')) {
<a name="l00699"></a>00699                                                         <span class="keywordflow">if</span> (!$recExist || $DBrows[0]['uid'] != $this-&gt;dataArr['uid']) {
<a name="l00700"></a>00700                                                                 <span class="comment">// Only issue an error if the record is not existing (if new...) and if the record with the false value selected was not our self.</span>
<a name="l00701"></a>00701                                                                 $tempArr[] = $theField;
<a name="l00702"></a>00702                                                                 $this-&gt;failureMsg[$theField][] = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a29">getFailure</a>($theField, $theCmd, 'The value exists already. Enter a <span class="keyword">new</span> value.');
<a name="l00703"></a>00703                                                         }
<a name="l00704"></a>00704                                                 }
<a name="l00705"></a>00705                                                 <span class="keywordflow">break</span>;
<a name="l00706"></a>00706                                                 <span class="keywordflow">case</span> 'uniqueLocal':
<a name="l00707"></a>00707                                                 <span class="keywordflow">if</span> (trim($this-&gt;dataArr[$theField]) &amp;&amp; $DBrows = $GLOBALS['TSFE']-&gt;sys_page-&gt;getRecordsByField($this-&gt;theTable, $theField, $this-&gt;dataArr[$theField], <span class="stringliteral">"AND pid IN ("</span>.$recordTestPid.') LIMIT 1')) {
<a name="l00708"></a>00708                                                         <span class="keywordflow">if</span> (!$recExist || $DBrows[0]['uid'] != $this-&gt;dataArr['uid']) {
<a name="l00709"></a>00709                                                                 <span class="comment">// Only issue an error if the record is not existing (if new...) and if the record with the false value selected was not our self.</span>
<a name="l00710"></a>00710                                                                 $tempArr[] = $theField;
<a name="l00711"></a>00711                                                                 $this-&gt;failureMsg[$theField][] = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a29">getFailure</a>($theField, $theCmd, 'The value exists already. Enter a <span class="keyword">new</span> value.');
<a name="l00712"></a>00712                                                         }
<a name="l00713"></a>00713                                                 }
<a name="l00714"></a>00714                                                 <span class="keywordflow">break</span>;
<a name="l00715"></a>00715                                                 <span class="keywordflow">case</span> 'twice':
<a name="l00716"></a>00716                                                 <span class="keywordflow">if</span> (strcmp($this-&gt;dataArr[$theField], $this-&gt;dataArr[$theField.'_again'])) {
<a name="l00717"></a>00717                                                         $tempArr[] = $theField;
<a name="l00718"></a>00718                                                         $this-&gt;failureMsg[$theField][] = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a29">getFailure</a>($theField, $theCmd, 'You must enter the same value twice.');
<a name="l00719"></a>00719                                                 }
<a name="l00720"></a>00720                                                 <span class="keywordflow">break</span>;
<a name="l00721"></a>00721                                                 <span class="keywordflow">case</span> 'email':
<a name="l00722"></a>00722                                                 <span class="keywordflow">if</span> (trim($this-&gt;dataArr[$theField]) &amp;&amp; !$this-&gt;cObj-&gt;checkEmail($this-&gt;dataArr[$theField])) {
<a name="l00723"></a>00723                                                         $tempArr[] = $theField;
<a name="l00724"></a>00724                                                         $this-&gt;failureMsg[$theField][] = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a29">getFailure</a>($theField, $theCmd, 'You must enter a valid email address.');
<a name="l00725"></a>00725                                                 }
<a name="l00726"></a>00726                                                 <span class="keywordflow">break</span>;
<a name="l00727"></a>00727                                                 <span class="keywordflow">case</span> 'required':
<a name="l00728"></a>00728                                                 <span class="keywordflow">if</span> (!trim($this-&gt;dataArr[$theField])) {
<a name="l00729"></a>00729                                                         $tempArr[] = $theField;
<a name="l00730"></a>00730                                                         $this-&gt;failureMsg[$theField][] = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a29">getFailure</a>($theField, $theCmd, 'You must enter a value!');
<a name="l00731"></a>00731                                                 }
<a name="l00732"></a>00732                                                 <span class="keywordflow">break</span>;
<a name="l00733"></a>00733                                                 <span class="keywordflow">case</span> 'atLeast':
<a name="l00734"></a>00734                                                 $chars = intval($cmdParts[1]);
<a name="l00735"></a>00735                                                 <span class="keywordflow">if</span> (strlen($this-&gt;dataArr[$theField]) &lt; $chars) {
<a name="l00736"></a>00736                                                         $tempArr[] = $theField;
<a name="l00737"></a>00737                                                         $this-&gt;failureMsg[$theField][] = sprintf($this-&gt;getFailure($theField, $theCmd, 'You must enter at least %s characters!'), $chars);
<a name="l00738"></a>00738                                                 }
<a name="l00739"></a>00739                                                 <span class="keywordflow">break</span>;
<a name="l00740"></a>00740                                                 <span class="keywordflow">case</span> 'atMost':
<a name="l00741"></a>00741                                                 $chars = intval($cmdParts[1]);
<a name="l00742"></a>00742                                                 <span class="keywordflow">if</span> (strlen($this-&gt;dataArr[$theField]) &gt; $chars) {
<a name="l00743"></a>00743                                                         $tempArr[] = $theField;
<a name="l00744"></a>00744                                                         $this-&gt;failureMsg[$theField][] = sprintf($this-&gt;getFailure($theField, $theCmd, 'You must enter at most %s characters!'), $chars);
<a name="l00745"></a>00745                                                 }
<a name="l00746"></a>00746                                                 <span class="keywordflow">break</span>;
<a name="l00747"></a>00747                                                 <span class="keywordflow">case</span> 'inBranch':
<a name="l00748"></a>00748                                                 $pars = explode(<span class="charliteral">';'</span>, $cmdParts[1]);
<a name="l00749"></a>00749                                                 <span class="keywordflow">if</span> (intval($pars[0])) {
<a name="l00750"></a>00750                                                         $pid_list = $this-&gt;cObj-&gt;getTreeList(
<a name="l00751"></a>00751                                                         intval($pars[0]),
<a name="l00752"></a>00752                                                                 intval($pars[1]) ? intval($pars[1]) :
<a name="l00753"></a>00753                                                         999,
<a name="l00754"></a>00754                                                                  
<a name="l00755"></a>00755                                                         intval($pars[2])
<a name="l00756"></a>00756                                                         );
<a name="l00757"></a>00757                                                         <span class="keywordflow">if</span> (!$pid_list || !t3lib_div::inList($pid_list, $this-&gt;dataArr[$theField])) {
<a name="l00758"></a>00758                                                                 $tempArr[] = $theField;
<a name="l00759"></a>00759                                                                 $this-&gt;failureMsg[$theField][] = sprintf($this-&gt;getFailure($theField, $theCmd, 'The value was not a valid value from <span class="keyword">this</span> list: %s'), $pid_list);
<a name="l00760"></a>00760                                                         }
<a name="l00761"></a>00761                                                 }
<a name="l00762"></a>00762                                                 <span class="keywordflow">break</span>;
<a name="l00763"></a>00763                                                 <span class="keywordflow">case</span> 'unsetEmpty':
<a name="l00764"></a>00764                                                 <span class="keywordflow">if</span> (!$this-&gt;dataArr[$theField]) {
<a name="l00765"></a>00765                                                         $hash = array_flip($tempArr);
<a name="l00766"></a>00766                                                         unset($hash[$theField]);
<a name="l00767"></a>00767                                                         $tempArr = array_keys($hash);
<a name="l00768"></a>00768                                                         unset($this-&gt;failureMsg[$theField]);
<a name="l00769"></a>00769                                                         unset($this-&gt;dataArr[$theField]); <span class="comment">// This should prevent the field from entering the database.</span>
<a name="l00770"></a>00770                                                 }
<a name="l00771"></a>00771                                                 <span class="keywordflow">break</span>;
<a name="l00772"></a>00772                                                 <span class="keywordflow">case</span> 'upload':
<a name="l00773"></a>00773                                                 <span class="keywordflow">if</span> ($this-&gt;dataArr[$theField] &amp;&amp; is_array($this-&gt;TCA['columns'][$theField]['config']) ) {
<a name="l00774"></a>00774                                                         <span class="keywordflow">if</span> ($this-&gt;TCA['columns'][$theField]['config']['type'] == 'group' &amp;&amp; $this-&gt;TCA['columns'][$theField]['config']['internal_type'] == 'file') {
<a name="l00775"></a>00775                                                                 $uploadPath = $this-&gt;TCA['columns'][$theField]['config']['uploadfolder'];
<a name="l00776"></a>00776                                                                 $allowedExtArray = t3lib_div::trimExplode(<span class="charliteral">','</span>, $this-&gt;TCA['columns'][$theField]['config']['allowed'], 1);
<a name="l00777"></a>00777                                                                 $maxSize = $this-&gt;TCA['columns'][$theField]['config']['max_size'];
<a name="l00778"></a>00778                                                                 $fileNameList = explode(<span class="charliteral">','</span>, $this-&gt;dataArr[$theField]);
<a name="l00779"></a>00779                                                                 $newFileNameList = array();
<a name="l00780"></a>00780                                                                 reset($fileNameList);
<a name="l00781"></a>00781                                                                 <span class="keywordflow">while</span> (list(, $filename) = each($fileNameList)) {
<a name="l00782"></a>00782                                                                         $fI = pathinfo($filename);
<a name="l00783"></a>00783                                                                         <span class="keywordflow">if</span> (!count($allowedExtArray) || in_array(strtolower($fI['extension']), $allowedExtArray)) {
<a name="l00784"></a>00784                                                                                 <span class="keywordflow">if</span> (@is_file(PATH_site.$uploadPath.<span class="charliteral">'/'</span>.$filename)) {
<a name="l00785"></a>00785                                                                                         <span class="keywordflow">if</span> (!$maxSize || (filesize(PATH_site.$uploadPath.<span class="charliteral">'/'</span>.$filename) &lt; ($maxSize * 1024))) {
<a name="l00786"></a>00786                                                                                                 $newFileNameList[] = $filename;
<a name="l00787"></a>00787                                                                                         } <span class="keywordflow">else</span> {
<a name="l00788"></a>00788                                                                                                 $this-&gt;failureMsg[$theField][] = sprintf($this-&gt;getFailure($theField, 'max_size', 'The file is larger than %s KB.'), $maxSize);
<a name="l00789"></a>00789                                                                                                 unlink(PATH_site.$uploadPath.<span class="charliteral">'/'</span>.$filename);
<a name="l00790"></a>00790                                                                                         }
<a name="l00791"></a>00791                                                                                 }
<a name="l00792"></a>00792                                                                         } <span class="keywordflow">else</span> {
<a name="l00793"></a>00793                                                                                 $this-&gt;failureMsg[$theField][] = sprintf($this-&gt;getFailure($theField, 'allowed', 'The file extension %s is not allowed.'), $fI['extension']);
<a name="l00794"></a>00794                                                                                 unlink(PATH_site.$uploadPath.<span class="charliteral">'/'</span>.$filename);
<a name="l00795"></a>00795                                                                         }
<a name="l00796"></a>00796                                                                 }
<a name="l00797"></a>00797                                                                 $this-&gt;dataArr[$theField] = implode(<span class="charliteral">','</span>, $newFileNameList);
<a name="l00798"></a>00798                                                         }
<a name="l00799"></a>00799                                                 }
<a name="l00800"></a>00800                                                 <span class="keywordflow">break</span>;
<a name="l00801"></a>00801                                                 <span class="keywordflow">case</span> 'wwwURL':
<a name="l00802"></a>00802                                                 <span class="keywordflow">if</span> ($this-&gt;dataArr[$theField]) {
<a name="l00803"></a>00803                                                         $wwwURLOptions = array (
<a name="l00804"></a>00804                                                         'AssumeProtocol' =&gt; 'http' ,
<a name="l00805"></a>00805                                                                 'AllowBracks' =&gt; TRUE ,
<a name="l00806"></a>00806                                                                 'AllowedProtocols' =&gt; array(0 =&gt; 'http', 1 =&gt; 'https', ) ,
<a name="l00807"></a>00807                                                                 'Require' =&gt; array('Protocol' =&gt; FALSE , 'User' =&gt; FALSE , 'Password' =&gt; FALSE , 'Server' =&gt; TRUE , 'Resource' =&gt; FALSE , 'TLD' =&gt; TRUE , 'Port' =&gt; FALSE , 'QueryString' =&gt; FALSE , 'Anchor' =&gt; FALSE , ) ,
<a name="l00808"></a>00808                                                                 'Forbid' =&gt; array('Protocol' =&gt; FALSE , 'User' =&gt; TRUE , 'Password' =&gt; TRUE , 'Server' =&gt; FALSE , 'Resource' =&gt; FALSE , 'TLD' =&gt; FALSE , 'Port' =&gt; TRUE , 'QueryString' =&gt; FALSE , 'Anchor' =&gt; FALSE , ) ,
<a name="l00809"></a>00809                                                                 );
<a name="l00810"></a>00810                                                         $wwwURLResult = tx_srfeuserregister_pi1_urlvalidator::_ValURL($this-&gt;dataArr[$theField], $wwwURLOptions);
<a name="l00811"></a>00811                                                         <span class="keywordflow">if</span> ($wwwURLResult['Result'] != 'EW_OK' ) {
<a name="l00812"></a>00812                                                                 $tempArr[] = $theField;
<a name="l00813"></a>00813                                                                 $this-&gt;failureMsg[$theField][] = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a29">getFailure</a>($theField, $theCmd, 'Please enter a valid Internet site address.');
<a name="l00814"></a>00814                                                         }
<a name="l00815"></a>00815                                                 }
<a name="l00816"></a>00816                                                 <span class="keywordflow">break</span>;
<a name="l00817"></a>00817                                                 <span class="keywordflow">case</span> 'date':
<a name="l00818"></a>00818                                                 <span class="keywordflow">if</span> ($this-&gt;dataArr[$theField] &amp;&amp; !$this-&gt;evalDate($this-&gt;dataArr[$theField]) ){
<a name="l00819"></a>00819                                                         $tempArr[] = $theField;
<a name="l00820"></a>00820                                                         $this-&gt;failureMsg[$theField][] = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a29">getFailure</a>($theField, $theCmd, 'Please enter a valid date.');
<a name="l00821"></a>00821                                                 }
<a name="l00822"></a>00822                                                 <span class="keywordflow">break</span>;
<a name="l00823"></a>00823                                                 <span class="keywordflow">case</span> 'expiry':
<a name="l00824"></a>00824                                                 <span class="keywordflow">if</span> ($this-&gt;dataArr[$theField] &amp;&amp; !$this-&gt;evalExpiry($this-&gt;dataArr[$theField]) ){
<a name="l00825"></a>00825                                                         $tempArr[] = $theField;
<a name="l00826"></a>00826                                                         $this-&gt;failureMsg[$theField][] = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a29">getFailure</a>($theField, $theCmd, 'Please enter a valid expiry MM/YYYY.');
<a name="l00827"></a>00827                                                 }
<a name="l00828"></a>00828                                                 <span class="keywordflow">break</span>;
<a name="l00829"></a>00829                                                 <span class="keywordflow">case</span> 'month':
<a name="l00830"></a>00830                                                 <span class="keywordflow">if</span> ($this-&gt;dataArr[$theField] &amp;&amp; !$this-&gt;evalMonth($this-&gt;dataArr[$theField]) ){
<a name="l00831"></a>00831                                                         $tempArr[] = $theField;
<a name="l00832"></a>00832                                                         $this-&gt;failureMsg[$theField][] = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a29">getFailure</a>($theField, $theCmd, 'Please enter a valid month.');
<a name="l00833"></a>00833                                                 }
<a name="l00834"></a>00834                                                 <span class="keywordflow">break</span>;
<a name="l00835"></a>00835                                                 <span class="keywordflow">case</span> 'year':
<a name="l00836"></a>00836                                                 <span class="keywordflow">if</span> ($this-&gt;dataArr[$theField] &amp;&amp; !$this-&gt;evalYear($this-&gt;dataArr[$theField]) ){
<a name="l00837"></a>00837                                                         $tempArr[] = $theField;
<a name="l00838"></a>00838                                                         $this-&gt;failureMsg[$theField][] = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a29">getFailure</a>($theField, $theCmd, 'Please enter a valid year.');
<a name="l00839"></a>00839                                                 }
<a name="l00840"></a>00840                                                 <span class="keywordflow">break</span>;
<a name="l00841"></a>00841                                                 <span class="keywordflow">case</span> '<span class="keywordtype">int</span>':
<a name="l00842"></a>00842                                                 <span class="keywordflow">if</span> ($this-&gt;dataArr[$theField] &amp;&amp; !is_numeric($this-&gt;dataArr[$theField]) ){
<a name="l00843"></a>00843                                                         $tempArr[] = $theField;
<a name="l00844"></a>00844                                                         $this-&gt;failureMsg[$theField][] = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a29">getFailure</a>($theField, $theCmd, 'Please enter a whole number.');
<a name="l00845"></a>00845                                                 }
<a name="l00846"></a>00846                                                 <span class="keywordflow">break</span>;
<a name="l00847"></a>00847 
<a name="l00848"></a>00848                                                 <span class="keywordflow">case</span> 'creditcard':
<a name="l00849"></a>00849                                                 <span class="keywordflow">if</span> ($this-&gt;dataArr[$theField])
<a name="l00850"></a>00850                                                 {
<a name="l00851"></a>00851                                                         <span class="keywordflow">if</span> (!$this-&gt;evalCreditcard($this-&gt;dataArr[$theField]) )
<a name="l00852"></a>00852                                                         {
<a name="l00853"></a>00853                                                                 $tempArr[] = $theField;
<a name="l00854"></a>00854                                                                 $this-&gt;failureMsg[$theField][] = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a29">getFailure</a>($theField, $theCmd, $this-&gt;ccErrorText );
<a name="l00855"></a>00855                                                         }
<a name="l00856"></a>00856                                                         <span class="comment">// MLC since credit card is valid, update usergroup</span>
<a name="l00857"></a>00857                                                         <span class="comment">// for advanced access</span>
<a name="l00858"></a>00858                                                         <span class="keywordflow">else</span>
<a name="l00859"></a>00859                                                         {
<a name="l00860"></a>00860                                                                 $this-&gt;cc_valid         = <span class="keyword">true</span>;
<a name="l00861"></a>00861                                                         }
<a name="l00862"></a>00862                                                 }
<a name="l00863"></a>00863                                                 <span class="keywordflow">break</span>;
<a name="l00864"></a>00864 
<a name="l00865"></a>00865                                                 <span class="keywordflow">case</span> 'routing':
<a name="l00866"></a>00866                                                 <span class="keywordflow">if</span> ($this-&gt;dataArr[$theField] &amp;&amp; !$this-&gt;cbIsAba($this-&gt;dataArr[$theField]) ){
<a name="l00867"></a>00867                                                         $tempArr[] = $theField;
<a name="l00868"></a>00868                                                         $this-&gt;failureMsg[$theField][] = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a29">getFailure</a>($theField, $theCmd, 'Please re-enter the routing number.' );
<a name="l00869"></a>00869                                                 }
<a name="l00870"></a>00870                                                 <span class="keywordflow">break</span>;
<a name="l00871"></a>00871 
<a name="l00872"></a>00872                                                 <span class="keywordflow">case</span> 'pco':
<a name="l00873"></a>00873                                                 <span class="comment">// MLC if zone is in the create list and pco, error</span>
<a name="l00874"></a>00874                                                 <span class="keywordflow">if</span> ( preg_match(
<a name="l00875"></a>00875                                                                 '#\b' . $this-&gt;dataArr[$theField] . '\b#'
<a name="l00876"></a>00876                                                                 , $this-&gt;conf[ 'create.' ][ 'fields' ] ) 
<a name="l00877"></a>00877                                                         &amp;&amp; $this-&gt;dataArr[$theField] == 'PCO'
<a name="l00878"></a>00878                                                 )
<a name="l00879"></a>00879                                                 {
<a name="l00880"></a>00880                                                         $tempArr[] = $theField;
<a name="l00881"></a>00881                                                         $this-&gt;failureMsg[$theField][] = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a29">getFailure</a>($theField, $theCmd, 'Please choose one.' );
<a name="l00882"></a>00882                                                 }
<a name="l00883"></a>00883                                                 <span class="keywordflow">break</span>;
<a name="l00884"></a>00884                                         }
<a name="l00885"></a>00885                                 }
<a name="l00886"></a>00886                                 $this-&gt;markerArray['###EVAL_ERROR_FIELD_'.$theField.'###'] = is_array($this-&gt;failureMsg[$theField])?implode($this-&gt;failureMsg[$theField], '&lt;br /&gt;'):
<a name="l00887"></a>00887                                 '&lt;!--no error--&gt;';
<a name="l00888"></a>00888                         }
<a name="l00889"></a>00889                 }
<a name="l00890"></a>00890                 $this-&gt;failure = implode($tempArr, <span class="charliteral">','</span>);
<a name="l00891"></a>00891 
<a name="l00892"></a>00892                 <span class="keywordflow">if</span> ( $this-&gt;debug )
<a name="l00893"></a>00893                 {
<a name="l00894"></a>00894                         cbPrint2( '$this-&gt;failure', $this-&gt;failure );
<a name="l00895"></a>00895                         cbPrint2( '$this-&gt;failureMsg', $this-&gt;failureMsg );
<a name="l00896"></a>00896                 }
<a name="l00897"></a>00897         }
<a name="l00898"></a>00898          
<a name="l00909"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a29">00909</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a29">getFailure</a>($theField, $theCmd, $label) {
<a name="l00910"></a>00910                 $failureLabel = $this-&gt;pi_getLL('evalErrors_'.$theCmd.<span class="charliteral">'_'</span>.$theField);
<a name="l00911"></a>00911                 $failureLabel = $failureLabel ? $failureLabel :
<a name="l00912"></a>00912                 $this-&gt;pi_getLL('evalErrors_'.$theCmd);
<a name="l00913"></a>00913                 $failureLabel = $failureLabel ? $failureLabel :
<a name="l00914"></a>00914                 (isset($this-&gt;conf['evalErrors.'][$theField.<span class="charliteral">'.'</span>][$theCmd]) ? $this-&gt;conf['evalErrors.'][$theField.<span class="charliteral">'.'</span>][$theCmd] : $label);
<a name="l00915"></a>00915                 <span class="keywordflow">return</span> $failureLabel;
<a name="l00916"></a>00916         }
<a name="l00917"></a>00917          
<a name="l00925"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a61">00925</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a61">userProcess</a>($mConfKey, $passVar) {
<a name="l00926"></a>00926                 <span class="keywordflow">if</span> ($this-&gt;conf[$mConfKey]) {
<a name="l00927"></a>00927                         $funcConf = $this-&gt;conf[$mConfKey.<span class="charliteral">'.'</span>];
<a name="l00928"></a>00928                         $funcConf['parentObj'] = &amp;$this;
<a name="l00929"></a>00929                         $passVar = $GLOBALS['TSFE']-&gt;cObj-&gt;callUserFunction($this-&gt;conf[$mConfKey], $funcConf, $passVar);
<a name="l00930"></a>00930                 }
<a name="l00931"></a>00931                 <span class="keywordflow">return</span> $passVar;
<a name="l00932"></a>00932         }
<a name="l00933"></a>00933          
<a name="l00942"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a62">00942</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a62">userProcess_alt</a>($confVal, $confArr, $passVar) {
<a name="l00943"></a>00943                 <span class="keywordflow">if</span> ($confVal) {
<a name="l00944"></a>00944                         $funcConf = $confArr;
<a name="l00945"></a>00945                         $funcConf['parentObj'] = &amp;$this;
<a name="l00946"></a>00946                         $passVar = $GLOBALS['TSFE']-&gt;cObj-&gt;callUserFunction($confVal, $funcConf, $passVar);
<a name="l00947"></a>00947                 }
<a name="l00948"></a>00948                 <span class="keywordflow">return</span> $passVar;
<a name="l00949"></a>00949         }
<a name="l00950"></a>00950          
<a name="l00956"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a42">00956</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a42">parseValues</a>() {
<a name="l00957"></a>00957                 <span class="keywordflow">if</span> (is_array($this-&gt;conf['<a class="code" href="classtx__srfeuserregister__pi1.html#a42">parseValues</a>.'])) {
<a name="l00958"></a>00958                         reset($this-&gt;conf['<a class="code" href="classtx__srfeuserregister__pi1.html#a42">parseValues</a>.']);
<a name="l00959"></a>00959                         <span class="keywordflow">while</span> (list($theField, $theValue) = each($this-&gt;conf['<a class="code" href="classtx__srfeuserregister__pi1.html#a42">parseValues</a>.'])) {
<a name="l00960"></a>00960                                 $listOfCommands = t3lib_div::trimExplode(<span class="charliteral">','</span>, $theValue, 1);
<a name="l00961"></a>00961                                 <span class="keywordflow">while</span> (list(, $cmd) = each($listOfCommands)) {
<a name="l00962"></a>00962                                         $cmdParts = split(<span class="stringliteral">"\[|\]"</span>, $cmd); <span class="comment">// Point is to enable parameters after each command enclosed in brackets [..]. These will be in position 1 in the array.</span>
<a name="l00963"></a>00963                                         $theCmd = trim($cmdParts[0]);
<a name="l00964"></a>00964                                         <span class="keywordflow">switch</span>($theCmd) {
<a name="l00965"></a>00965                                                 <span class="keywordflow">case</span> '<span class="keywordtype">int</span>':
<a name="l00966"></a>00966                                                 $this-&gt;dataArr[$theField] = intval($this-&gt;dataArr[$theField]);
<a name="l00967"></a>00967                                                 <span class="keywordflow">break</span>;
<a name="l00968"></a>00968                                                 <span class="keywordflow">case</span> 'lower':
<a name="l00969"></a>00969                                                 <span class="keywordflow">case</span> 'upper':
<a name="l00970"></a>00970                                                 $this-&gt;dataArr[$theField] = $this-&gt;cObj-&gt;caseshift($this-&gt;dataArr[$theField], $theCmd);
<a name="l00971"></a>00971                                                 <span class="keywordflow">break</span>;
<a name="l00972"></a>00972                                                 <span class="keywordflow">case</span> 'nospace':
<a name="l00973"></a>00973                                                 $this-&gt;dataArr[$theField] = str_replace(<span class="charliteral">' '</span>, '', $this-&gt;dataArr[$theField]);
<a name="l00974"></a>00974                                                 <span class="keywordflow">break</span>;
<a name="l00975"></a>00975                                                 <span class="keywordflow">case</span> 'alpha':
<a name="l00976"></a>00976                                                 $this-&gt;dataArr[$theField] = ereg_replace('[^a-zA-Z]', '', $this-&gt;dataArr[$theField]);
<a name="l00977"></a>00977                                                 <span class="keywordflow">break</span>;
<a name="l00978"></a>00978                                                 <span class="keywordflow">case</span> 'num':
<a name="l00979"></a>00979                                                 $this-&gt;dataArr[$theField] = ereg_replace('[^0-9]', '', $this-&gt;dataArr[$theField]);
<a name="l00980"></a>00980                                                 <span class="keywordflow">break</span>;
<a name="l00981"></a>00981                                                 <span class="keywordflow">case</span> 'alphanum':
<a name="l00982"></a>00982                                                 $this-&gt;dataArr[$theField] = ereg_replace('[^a-zA-Z0-9]', '', $this-&gt;dataArr[$theField]);
<a name="l00983"></a>00983                                                 <span class="keywordflow">break</span>;
<a name="l00984"></a>00984                                                 <span class="keywordflow">case</span> 'alphanum_x':
<a name="l00985"></a>00985                                                 $this-&gt;dataArr[$theField] = ereg_replace('[^a-zA-Z0-9_-]', '', $this-&gt;dataArr[$theField]);
<a name="l00986"></a>00986                                                 <span class="keywordflow">break</span>;
<a name="l00987"></a>00987                                                 <span class="keywordflow">case</span> 'trim':
<a name="l00988"></a>00988                                                 $this-&gt;dataArr[$theField] = trim($this-&gt;dataArr[$theField]);
<a name="l00989"></a>00989                                                 <span class="keywordflow">break</span>;
<a name="l00990"></a>00990                                                 <span class="keywordflow">case</span> 'random':
<a name="l00991"></a>00991                                                 $this-&gt;dataArr[$theField] = substr(md5(uniqid(microtime(), 1)), 0, intval($cmdParts[1]));
<a name="l00992"></a>00992                                                 <span class="keywordflow">break</span>;
<a name="l00993"></a>00993                                                 <span class="keywordflow">case</span> 'files':
<a name="l00994"></a>00994                                                 <span class="keywordflow">if</span> (is_string($this-&gt;dataArr[$theField]) &amp;&amp; $this-&gt;dataArr[$theField]) {
<a name="l00995"></a>00995                                                         $this-&gt;dataArr[$theField] = explode(<span class="charliteral">','</span>, $this-&gt;dataArr[$theField]);
<a name="l00996"></a>00996                                                 }
<a name="l00997"></a>00997                                                 $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a44">processFiles</a>($theField);
<a name="l00998"></a>00998                                                 <span class="keywordflow">break</span>;
<a name="l00999"></a>00999                                                 <span class="keywordflow">case</span> 'setEmptyIfAbsent':
<a name="l01000"></a>01000                                                 <span class="keywordflow">if</span> (!isset($this-&gt;dataArr[$theField])) {
<a name="l01001"></a>01001                                                         $this-&gt;dataArr[$theField] = '';
<a name="l01002"></a>01002                                                 }
<a name="l01003"></a>01003                                                 <span class="keywordflow">break</span>;
<a name="l01004"></a>01004                                                 <span class="keywordflow">case</span> 'multiple':
<a name="l01005"></a>01005                                                 <span class="keywordflow">if</span> (is_array($this-&gt;dataArr[$theField])) {
<a name="l01006"></a>01006                                                         $this-&gt;dataArr[$theField] = implode(<span class="charliteral">','</span>, $this-&gt;dataArr[$theField]);
<a name="l01007"></a>01007                                                 }
<a name="l01008"></a>01008                                                 <span class="keywordflow">break</span>;
<a name="l01009"></a>01009                                                 <span class="keywordflow">case</span> 'checkArray':
<a name="l01010"></a>01010                                                 <span class="keywordflow">if</span> (is_array($this-&gt;dataArr[$theField])) {
<a name="l01011"></a>01011                                                         reset($this-&gt;dataArr[$theField]);
<a name="l01012"></a>01012                                                         $val = 0;
<a name="l01013"></a>01013                                                         <span class="keywordflow">while</span> (list($kk, $vv) = each($this-&gt;dataArr[$theField])) {
<a name="l01014"></a>01014                                                                 $kk = t3lib_div::intInRange($kk, 0);
<a name="l01015"></a>01015                                                                 <span class="keywordflow">if</span> ($kk &lt;= 30) {
<a name="l01016"></a>01016                                                                         <span class="keywordflow">if</span> ($vv) {
<a name="l01017"></a>01017                                                                                 $val|= pow(2, $kk);
<a name="l01018"></a>01018                                                                         }
<a name="l01019"></a>01019                                                                 }
<a name="l01020"></a>01020                                                         }
<a name="l01021"></a>01021                                                         $this-&gt;dataArr[$theField] = $val;
<a name="l01022"></a>01022                                                 }
<a name="l01023"></a>01023                                                 <span class="keywordflow">break</span>;
<a name="l01024"></a>01024                                                 <span class="keywordflow">case</span> 'uniqueHashInt':
<a name="l01025"></a>01025                                                 $otherFields = t3lib_div::trimExplode(<span class="charliteral">';'</span>, $cmdParts[1], 1);
<a name="l01026"></a>01026                                                 $hashArray = array();
<a name="l01027"></a>01027                                                 <span class="keywordflow">while</span> (list(, $fN) = each($otherFields)) {
<a name="l01028"></a>01028                                                         $vv = $this-&gt;dataArr[$fN];
<a name="l01029"></a>01029                                                         $vv = ereg_replace('[[:space:]]', '', $vv);
<a name="l01030"></a>01030                                                         $vv = ereg_replace('[^[:alnum:]]', '', $vv);
<a name="l01031"></a>01031                                                         $vv = strtolower($vv);
<a name="l01032"></a>01032                                                         $hashArray[] = $vv;
<a name="l01033"></a>01033                                                 }
<a name="l01034"></a>01034                                                 $this-&gt;dataArr[$theField] = hexdec(substr(md5(serialize($hashArray)), 0, 8));
<a name="l01035"></a>01035                                                 <span class="keywordflow">break</span>;
<a name="l01036"></a>01036                                                 <span class="keywordflow">case</span> 'wwwURL':
<a name="l01037"></a>01037                                                 <span class="keywordflow">if</span> ($this-&gt;dataArr[$theField]) {
<a name="l01038"></a>01038                                                         $wwwURLOptions = array (
<a name="l01039"></a>01039                                                         'AssumeProtocol' =&gt; 'http' ,
<a name="l01040"></a>01040                                                                 'AllowBracks' =&gt; TRUE ,
<a name="l01041"></a>01041                                                                 'AllowedProtocols' =&gt; array(0 =&gt; 'http', 1 =&gt; 'https', ) ,
<a name="l01042"></a>01042                                                                 'Require' =&gt; array('Protocol' =&gt; FALSE , 'User' =&gt; FALSE , 'Password' =&gt; FALSE , 'Server' =&gt; TRUE , 'Resource' =&gt; FALSE , 'TLD' =&gt; TRUE , 'Port' =&gt; FALSE , 'QueryString' =&gt; FALSE , 'Anchor' =&gt; FALSE , ) ,
<a name="l01043"></a>01043                                                                 'Forbid' =&gt; array('Protocol' =&gt; FALSE , 'User' =&gt; TRUE , 'Password' =&gt; TRUE , 'Server' =&gt; FALSE , 'Resource' =&gt; FALSE , 'TLD' =&gt; FALSE , 'Port' =&gt; TRUE , 'QueryString' =&gt; FALSE , 'Anchor' =&gt; FALSE , ) ,
<a name="l01044"></a>01044                                                                 );
<a name="l01045"></a>01045                                                         $wwwURLResult = tx_srfeuserregister_pi1_urlvalidator::_ValURL($this-&gt;dataArr[$theField], $wwwURLOptions);
<a name="l01046"></a>01046                                                         <span class="keywordflow">if</span> ($wwwURLResult['Result'] = 'EW_OK' ) {
<a name="l01047"></a>01047                                                                 $this-&gt;dataArr[$theField] = $wwwURLResult['Value'];
<a name="l01048"></a>01048                                                         }
<a name="l01049"></a>01049                                                 }
<a name="l01050"></a>01050                                                 <span class="keywordflow">break</span>;
<a name="l01051"></a>01051                                                 <span class="keywordflow">case</span> 'date':
<a name="l01052"></a>01052                                                 <span class="keywordflow">if</span>($this-&gt;dataArr[$theField] &amp;&amp; $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a21">evalDate</a>($this-&gt;dataArr[$theField]) &amp;&amp; strlen($this-&gt;dataArr[$theField]) == 8) { 
<a name="l01053"></a>01053                                                                 $this-&gt;dataArr[$theField] = substr($this-&gt;dataArr[$theField],0,4).<span class="charliteral">'-'</span>.substr($this-&gt;dataArr[$theField],4,2).<span class="charliteral">'-'</span>.substr($this-&gt;dataArr[$theField],6,2);
<a name="l01054"></a>01054                                                 }
<a name="l01055"></a>01055                                                 <span class="keywordflow">break</span>;
<a name="l01056"></a>01056                                         }
<a name="l01057"></a>01057                                 }
<a name="l01058"></a>01058                         }
<a name="l01059"></a>01059                 }
<a name="l01060"></a>01060         }
<a name="l01061"></a>01061          
<a name="l01068"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a44">01068</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a44">processFiles</a>($theField) {
<a name="l01069"></a>01069                 <span class="keywordflow">if</span> (is_array($this-&gt;TCA['columns'][$theField])) {
<a name="l01070"></a>01070                          
<a name="l01071"></a>01071                         $uploadPath = $this-&gt;TCA['columns'][$theField]['config']['uploadfolder'];
<a name="l01072"></a>01072                 }
<a name="l01073"></a>01073 
<a name="l01074"></a>01074 
<a name="l01075"></a>01075 
<a name="l01076"></a>01076 
<a name="l01077"></a>01077                 $fileNameList = array();
<a name="l01078"></a>01078                 <span class="keywordflow">if</span> (is_array($this-&gt;dataArr[$theField]) &amp;&amp; count($this-&gt;dataArr[$theField])) {
<a name="l01079"></a>01079                         <span class="keywordflow">while</span> (list($i, $file) = each($this-&gt;dataArr[$theField])) {
<a name="l01080"></a>01080                                 <span class="keywordflow">if</span> (is_array($file)) {
<a name="l01081"></a>01081                                         <span class="keywordflow">if</span> ($uploadPath &amp;&amp; $file['submit_delete']) {
<a name="l01082"></a>01082                                                 unlink(PATH_site.$uploadPath.<span class="charliteral">'/'</span>.$file['name']);
<a name="l01083"></a>01083                                         } <span class="keywordflow">else</span> {
<a name="l01084"></a>01084                                                 $fileNameList[] = $file['name'];
<a name="l01085"></a>01085                                         }
<a name="l01086"></a>01086                                 } <span class="keywordflow">else</span> {
<a name="l01087"></a>01087                                         $fileNameList[] = $file;
<a name="l01088"></a>01088                                 }
<a name="l01089"></a>01089                         }
<a name="l01090"></a>01090                 }
<a name="l01091"></a>01091                 <span class="keywordflow">if</span> ($uploadPath &amp;&amp; is_array($_FILES['FE']['name'][$this-&gt;theTable][$theField]) &amp;&amp; $this-&gt;evalFileError($_FILES['FE']['error'])) {
<a name="l01092"></a>01092                         reset($_FILES['FE']['name'][$this-&gt;theTable][$theField]);
<a name="l01093"></a>01093                         <span class="keywordflow">while</span> (list($i, $filename) = each($_FILES['FE']['name'][$this-&gt;theTable][$theField])) {
<a name="l01094"></a>01094                                 <span class="keywordflow">if</span> ($filename) {
<a name="l01095"></a>01095                                         $fI = pathinfo($filename);
<a name="l01096"></a>01096                                         <span class="keywordflow">if</span> (t3lib_div::verifyFilenameAgainstDenyPattern($fI['name'])) {
<a name="l01097"></a>01097                                                 $tmpFilename = (($GLOBALS['TSFE']-&gt;loginUser)?($GLOBALS['TSFE']-&gt;fe_user-&gt;user['username'].<span class="charliteral">'_'</span>):'').basename($filename, <span class="charliteral">'.'</span>.$fI['extension']).<span class="charliteral">'_'</span>.t3lib_div::shortmd5(uniqid($filename)).<span class="charliteral">'.'</span>.$fI['extension'];
<a name="l01098"></a>01098                                                 $theDestFile = $this-&gt;fileFunc-&gt;getUniqueName($this-&gt;fileFunc-&gt;cleanFileName($tmpFilename), PATH_site.$uploadPath.<span class="charliteral">'/'</span>);
<a name="l01099"></a>01099                                                 t3lib_div::upload_copy_move($_FILES['FE']['tmp_name'][$this-&gt;theTable][$theField][$i], $theDestFile);
<a name="l01100"></a>01100                                                 $fI2 = pathinfo($theDestFile);
<a name="l01101"></a>01101                                                 $fileNameList[] = $fI2['basename'];
<a name="l01102"></a>01102                                         }
<a name="l01103"></a>01103                                 }
<a name="l01104"></a>01104                         }
<a name="l01105"></a>01105                 }
<a name="l01106"></a>01106                 $this-&gt;dataArr[$theField] = (count($fileNameList))?implode(<span class="charliteral">','</span>, $fileNameList):
<a name="l01107"></a>01107                 '';
<a name="l01108"></a>01108         }
<a name="l01109"></a>01109          
<a name="l01115"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a39">01115</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a39">overrideValues</a>() {
<a name="l01116"></a>01116                 <span class="comment">// Addition of overriding values</span>
<a name="l01117"></a>01117                 <span class="keywordflow">if</span> (is_array($this-&gt;conf[$this-&gt;cmdKey.<span class="charliteral">'.'</span>]['<a class="code" href="classtx__srfeuserregister__pi1.html#a39">overrideValues</a>.'])) {
<a name="l01118"></a>01118                         reset($this-&gt;conf[$this-&gt;cmdKey.<span class="charliteral">'.'</span>]['<a class="code" href="classtx__srfeuserregister__pi1.html#a39">overrideValues</a>.']);
<a name="l01119"></a>01119                         <span class="keywordflow">while</span> (list($theField, $theValue) = each($this-&gt;conf[$this-&gt;cmdKey.<span class="charliteral">'.'</span>]['<a class="code" href="classtx__srfeuserregister__pi1.html#a39">overrideValues</a>.'])) {
<a name="l01120"></a>01120                                 $this-&gt;dataArr[$theField] = $theValue;
<a name="l01121"></a>01121                         }
<a name="l01122"></a>01122                 }
<a name="l01123"></a>01123         }
<a name="l01124"></a>01124          
<a name="l01130"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a13">01130</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a13">defaultValues</a>() {
<a name="l01131"></a>01131                 <span class="comment">// Addition of default values</span>
<a name="l01132"></a>01132                 <span class="keywordflow">if</span> (is_array($this-&gt;conf[$this-&gt;cmdKey.<span class="charliteral">'.'</span>]['<a class="code" href="classtx__srfeuserregister__pi1.html#a13">defaultValues</a>.'])) {
<a name="l01133"></a>01133                         reset($this-&gt;conf[$this-&gt;cmdKey.<span class="charliteral">'.'</span>]['<a class="code" href="classtx__srfeuserregister__pi1.html#a13">defaultValues</a>.']);
<a name="l01134"></a>01134                         <span class="keywordflow">while</span> (list($theField, $theValue) = each($this-&gt;conf[$this-&gt;cmdKey.<span class="charliteral">'.'</span>]['<a class="code" href="classtx__srfeuserregister__pi1.html#a13">defaultValues</a>.'])) {
<a name="l01135"></a>01135                                 $this-&gt;dataArr[$theField] = $theValue;
<a name="l01136"></a>01136                         }
<a name="l01137"></a>01137                 }
<a name="l01138"></a>01138                 <span class="keywordflow">if</span> (is_array($this-&gt;conf[$this-&gt;cmdKey.<span class="charliteral">'.'</span>]['<a class="code" href="classtx__srfeuserregister__pi1.html#a25">evalValues</a>.'])) {
<a name="l01139"></a>01139                         reset($this-&gt;conf[$this-&gt;cmdKey.<span class="charliteral">'.'</span>]['<a class="code" href="classtx__srfeuserregister__pi1.html#a25">evalValues</a>.']);
<a name="l01140"></a>01140                         <span class="keywordflow">while</span> (list($theField, $theValue) = each($this-&gt;conf[$this-&gt;cmdKey.<span class="charliteral">'.'</span>]['<a class="code" href="classtx__srfeuserregister__pi1.html#a25">evalValues</a>.'])) {
<a name="l01141"></a>01141                                 $this-&gt;markerArray['###EVAL_ERROR_FIELD_'.$theField.'###'] = '&lt;!--no error--&gt;';
<a name="l01142"></a>01142                         }
<a name="l01143"></a>01143                 }
<a name="l01144"></a>01144         }
<a name="l01145"></a>01145          
<a name="l01151"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a56">01151</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a56">setName</a>() {
<a name="l01152"></a>01152                 <span class="keywordflow">if</span> (in_array('name', explode(<span class="charliteral">','</span>, $this-&gt;fieldList)) &amp;&amp; !in_array('name', t3lib_div::trimExplode(<span class="charliteral">','</span>, $this-&gt;conf[$this-&gt;cmdKey.<span class="charliteral">'.'</span>]['fields'], 1)) ) {
<a name="l01153"></a>01153                         $this-&gt;dataArr['name'] = trim(trim($this-&gt;dataArr['first_name']).<span class="charliteral">' '</span>.trim($this-&gt;dataArr['last_name']));
<a name="l01154"></a>01154                 }
<a name="l01155"></a>01155         }
<a name="l01156"></a>01156          
<a name="l01162"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a49">01162</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a49">save</a>() {
<a name="l01163"></a>01163                 <span class="keywordflow">if</span>($this-&gt;debug) echo <span class="stringliteral">"save()&lt;br&gt;\n"</span>;
<a name="l01164"></a>01164                 
<a name="l01165"></a>01165                 $dropFields                             = explode( <span class="charliteral">','</span>
<a name="l01166"></a>01166                                                                         , $this-&gt;conf[ 'dropFields' ]
<a name="l01167"></a>01167                                                                 );
<a name="l01168"></a>01168 
<a name="l01169"></a>01169                 <span class="keywordflow">switch</span>($this-&gt;cmd) {
<a name="l01170"></a>01170                         <span class="keywordflow">case</span> 'edit':
<a name="l01171"></a>01171                         <span class="keywordflow">if</span> ($this-&gt;debug) echo <span class="stringliteral">"case edit &lt;br&gt;\n"</span>;
<a name="l01172"></a>01172                         $theUid = $this-&gt;dataArr['uid'];
<a name="l01173"></a>01173                         $origArr = $GLOBALS['TSFE']-&gt;sys_page-&gt;getRawRecord($this-&gt;theTable, $theUid);
<a name="l01174"></a>01174                         <span class="comment">// Fetches the original record to check permissions</span>
<a name="l01175"></a>01175                         <span class="keywordflow">if</span> ($this-&gt;conf['edit'] &amp;&amp; ($GLOBALS['TSFE']-&gt;loginUser || $this-&gt;aCAuth($origArr))) {
<a name="l01176"></a>01176                                 <span class="comment">// Must be logged in in order to edit  (OR be validated by email)</span>
<a name="l01177"></a>01177                                 $newFieldList = implode(<span class="charliteral">','</span>, array_intersect(explode(<span class="charliteral">','</span>, $this-&gt;fieldList), t3lib_div::trimExplode(<span class="charliteral">','</span>, $this-&gt;conf['edit.']['fields'], 1)));
<a name="l01178"></a>01178                                 $newFieldList  = implode(<span class="charliteral">','</span>, array_unique( array_merge (explode(<span class="charliteral">','</span>, $newFieldList), explode(<span class="charliteral">','</span>, $this-&gt;adminFieldList))));
<a name="l01179"></a>01179                                 <span class="keywordflow">if</span> ($this-&gt;aCAuth($origArr) || $this-&gt;cObj-&gt;DBmayFEUserEdit($this-&gt;theTable, $origArr, $GLOBALS['TSFE']-&gt;fe_user-&gt;user, $this-&gt;conf['allowedGroups'], $this-&gt;conf['fe_userEditSelf'])) {
<a name="l01180"></a>01180         
<a name="l01181"></a>01181                                         <span class="keywordflow">if</span> ( $this-&gt;debug )
<a name="l01182"></a>01182                                         {
<a name="l01183"></a>01183                                                  <span class="comment">//cbPrint2( 'newFieldList', $newFieldList );</span>
<a name="l01184"></a>01184                                         }
<a name="l01185"></a>01185 
<a name="l01186"></a>01186                                         $newFieldList   = implode( <span class="charliteral">','</span>, array_diff( 
<a name="l01187"></a>01187                                                                                         explode( <span class="charliteral">','</span>, $newFieldList )
<a name="l01188"></a>01188                                                                                         , $dropFields
<a name="l01189"></a>01189                                                                                 )
<a name="l01190"></a>01190                                                                         );
<a name="l01191"></a>01191         
<a name="l01192"></a>01192                                         <span class="keywordflow">if</span> ( $this-&gt;debug )
<a name="l01193"></a>01193                                         {
<a name="l01194"></a>01194                                                  cbPrint2( 'newFieldList', $newFieldList );
<a name="l01195"></a>01195                                                  <span class="comment">//exit();</span>
<a name="l01196"></a>01196                                         }
<a name="l01197"></a>01197 
<a name="l01198"></a>01198                                         $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a38">noArrayArray</a>( $this-&gt;dataArr );
<a name="l01199"></a>01199                                         $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a45">rectifyUserGroup</a>();
<a name="l01200"></a>01200                                         $query = $this-&gt;cObj-&gt;DBgetUpdate($this-&gt;theTable, $theUid, $this-&gt;parseOutgoingDates( $this-&gt;dataArr ), $newFieldList);
<a name="l01201"></a>01201 
<a name="l01202"></a>01202                                         <span class="keywordflow">if</span> ( $this-&gt;debug )
<a name="l01203"></a>01203                                         {
<a name="l01204"></a>01204                                                  cbPrint2( 'query', $query );
<a name="l01205"></a>01205                                                  cbPrint2( 'dataArr[<span class="stringliteral">"usergroup"</span>]', $this-&gt;dataArr[<span class="stringliteral">"usergroup"</span>] );
<a name="l01206"></a>01206                                                  exit();
<a name="l01207"></a>01207                                         }
<a name="l01208"></a>01208                                         $GLOBALS[ 'TYPO3_DB' ]-&gt;sql(TYPO3_db, $query);
<a name="l01209"></a>01209                                         echo $GLOBALS[ 'TYPO3_DB' ]-&gt;sql_error();
<a name="l01210"></a>01210                                         $this-&gt;currentArr = $GLOBALS['TSFE']-&gt;sys_page-&gt;getRawRecord($this-&gt;theTable, $theUid);
<a name="l01211"></a>01211                                         $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a62">userProcess_alt</a>($this-&gt;conf['edit.']['userFunc_afterSave'], $this-&gt;conf['edit.']['userFunc_afterSave.'], array('rec' =&gt; $this-&gt;currentArr, 'origRec' =&gt; $origArr));
<a name="l01212"></a>01212                                         $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a59">unsetExpiredField</a>($theUid);  <span class="comment">//set expired flag to 0 if this is a prof/comp.prof. member - js</span>
<a name="l01213"></a>01213                                         $this-&gt;saved = 1;
<a name="l01214"></a>01214                                 } <span class="keywordflow">else</span> {
<a name="l01215"></a>01215                                          
<a name="l01216"></a>01216                                         $this-&gt;error = '###TEMPLATE_NO_PERMISSIONS###';
<a name="l01217"></a>01217                                 }
<a name="l01218"></a>01218                         }
<a name="l01219"></a>01219                          
<a name="l01220"></a>01220                         <span class="keywordflow">break</span>;
<a name="l01221"></a>01221                         <span class="keywordflow">default</span>:
<a name="l01222"></a>01222                         <span class="keywordflow">if</span> ($this-&gt;debug) echo <span class="stringliteral">"case default &lt;br&gt;\n"</span>;
<a name="l01223"></a>01223                         <span class="keywordflow">if</span> ($this-&gt;conf['create']) {
<a name="l01224"></a>01224                                 $newFieldList = implode(array_intersect(explode(<span class="charliteral">','</span>, $this-&gt;fieldList), t3lib_div::trimExplode(<span class="charliteral">','</span>, $this-&gt;conf['create.']['fields'], 1)), <span class="charliteral">','</span>);
<a name="l01225"></a>01225                                 $newFieldList  = implode( array_unique( array_merge (explode(<span class="charliteral">','</span>, $newFieldList), explode(<span class="charliteral">','</span>, $this-&gt;adminFieldList))), <span class="charliteral">','</span>);
<a name="l01226"></a>01226 
<a name="l01227"></a>01227                                 $newFieldList   = implode( <span class="charliteral">','</span>, array_diff( 
<a name="l01228"></a>01228                                                                                 explode( <span class="charliteral">','</span>, $newFieldList )
<a name="l01229"></a>01229                                                                                 , $dropFields
<a name="l01230"></a>01230                                                                         )
<a name="l01231"></a>01231                                                                 );
<a name="l01232"></a>01232 
<a name="l01233"></a>01233                                 $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a38">noArrayArray</a>( $this-&gt;dataArr );
<a name="l01234"></a>01234                                 $query = $this-&gt;cObj-&gt;DBgetInsert($this-&gt;theTable, $this-&gt;thePid, $this-&gt;parseOutgoingDates( $this-&gt;dataArr ), $newFieldList);
<a name="l01235"></a>01235 
<a name="l01236"></a>01236                                 <span class="keywordflow">if</span> ( $this-&gt;debug )
<a name="l01237"></a>01237                                 {
<a name="l01238"></a>01238                                          cbPrint2( 'query', $query );
<a name="l01239"></a>01239                                          exit();
<a name="l01240"></a>01240                                 }
<a name="l01241"></a>01241 
<a name="l01242"></a>01242                                 $GLOBALS[ 'TYPO3_DB' ]-&gt;sql(TYPO3_db, $query);
<a name="l01243"></a>01243                                 echo $GLOBALS[ 'TYPO3_DB' ]-&gt;sql_error();
<a name="l01244"></a>01244                                 $newId = $GLOBALS[ 'TYPO3_DB' ]-&gt;sql_insert_id();
<a name="l01245"></a>01245                                 
<a name="l01246"></a>01246                                 $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a60">upgradeMemberAccess</a>($newId); <span class="comment">// - js</span>
<a name="l01247"></a>01247                                 
<a name="l01248"></a>01248                                 <span class="keywordflow">if</span> ($this-&gt;theTable == <span class="stringliteral">"fe_users"</span> &amp;&amp; $this-&gt;conf['fe_userOwnSelf']) {
<a name="l01249"></a>01249                                         <span class="comment">// enables users, creating logins, to own them self.</span>
<a name="l01250"></a>01250                                         $extraList = '';
<a name="l01251"></a>01251                                         <a class="code" href="classtx__srfeuserregister__pi1.html#o13">$dataArr</a> = array();
<a name="l01252"></a>01252                                         <span class="keywordflow">if</span> ($GLOBALS['TCA'][$this-&gt;theTable]['ctrl']['fe_cruser_id']) {
<a name="l01253"></a>01253                                                 $field = $GLOBALS['TCA'][$this-&gt;theTable]['ctrl']['fe_cruser_id'];
<a name="l01254"></a>01254                                                 <a class="code" href="classtx__srfeuserregister__pi1.html#o13">$dataArr</a>[$field] = $newId;
<a name="l01255"></a>01255                                                 $extraList .= <span class="charliteral">','</span>.$field;
<a name="l01256"></a>01256                                         }
<a name="l01257"></a>01257                                         <span class="keywordflow">if</span> ($GLOBALS['TCA'][$this-&gt;theTable]['ctrl']['fe_crgroup_id']) {
<a name="l01258"></a>01258                                                 $field = $GLOBALS['TCA'][$this-&gt;theTable]['ctrl']['fe_crgroup_id'];
<a name="l01259"></a>01259                                                 list($dataArr[$field]) = explode(<span class="charliteral">','</span>, $this-&gt;dataArr['usergroup']);
<a name="l01260"></a>01260                                                 <a class="code" href="classtx__srfeuserregister__pi1.html#o13">$dataArr</a>[$field] = intval($dataArr[$field]);
<a name="l01261"></a>01261                                                 $extraList .= <span class="charliteral">','</span>.$field;
<a name="l01262"></a>01262                                         }
<a name="l01263"></a>01263                                         <span class="keywordflow">if</span> (count($dataArr)) {
<a name="l01264"></a>01264                                                 $query = $this-&gt;cObj-&gt;DBgetUpdate($this-&gt;theTable, $newId, $dataArr, $extraList);
<a name="l01265"></a>01265                                                  
<a name="l01266"></a>01266                                                 <span class="keywordflow">if</span> ($this-&gt;conf['debug']) debug('Own-<span class="keyword">self</span> query: '.$query, 1);
<a name="l01267"></a>01267                                                         $GLOBALS[ 'TYPO3_DB' ]-&gt;sql(TYPO3_db, $query);
<a name="l01268"></a>01268                                                 echo $GLOBALS[ 'TYPO3_DB' ]-&gt;sql_error();
<a name="l01269"></a>01269                                         }
<a name="l01270"></a>01270                                          
<a name="l01271"></a>01271                                 }
<a name="l01272"></a>01272                                  
<a name="l01273"></a>01273                                 $this-&gt;currentArr = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a40">parseIncomingTimestamps</a>( $GLOBALS['TSFE']-&gt;sys_page-&gt;getRawRecord($this-&gt;theTable, $newId));
<a name="l01274"></a>01274                                 $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a62">userProcess_alt</a>($this-&gt;conf['create.']['userFunc_afterSave'], $this-&gt;conf['create.']['userFunc_afterSave.'], array('rec' =&gt; $this-&gt;currentArr));
<a name="l01275"></a>01275                                 $this-&gt;saved = 1;
<a name="l01276"></a>01276                         }
<a name="l01277"></a>01277                         <span class="keywordflow">break</span>;
<a name="l01278"></a>01278                 }
<a name="l01279"></a>01279         }
<a name="l01280"></a>01280          
<a name="l01293"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a47">01293</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a47">removeRequired</a>($templateCode, $failure) {
<a name="l01294"></a>01294                 reset($this-&gt;requiredArr);
<a name="l01295"></a>01295                 $includedFields = t3lib_div::trimExplode(<span class="charliteral">','</span>, $this-&gt;conf[$this-&gt;cmdKey.<span class="charliteral">'.'</span>]['fields'], 1);
<a name="l01296"></a>01296                 $infoFields = explode(<span class="charliteral">','</span>, $this-&gt;fieldList);
<a name="l01297"></a>01297                 <span class="keywordflow">while</span> (list(, $fName) = each($infoFields) ) {
<a name="l01298"></a>01298                         <span class="keywordflow">if</span> (in_array(trim($fName), $this-&gt;requiredArr) ) {
<a name="l01299"></a>01299                                 <span class="keywordflow">if</span> (!t3lib_div::inList($failure, $fName)) {
<a name="l01300"></a>01300                                         <a class="code" href="classtx__srfeuserregister__pi1.html#o44">$templateCode</a> = $this-&gt;cObj-&gt;substituteSubpart($templateCode, '###SUB_REQUIRED_FIELD_'.$fName.'###', '');
<a name="l01301"></a>01301                                 }
<a name="l01302"></a>01302                         } <span class="keywordflow">else</span> {
<a name="l01303"></a>01303                                 <a class="code" href="classtx__srfeuserregister__pi1.html#o44">$templateCode</a> = $this-&gt;cObj-&gt;substituteSubpart($templateCode, '###SUB_REQUIRED_FIELD_'.$fName.'###', '');
<a name="l01304"></a>01304                                 <span class="keywordflow">if</span> (!in_array(trim($fName), $includedFields) ) {
<a name="l01305"></a>01305                                         <a class="code" href="classtx__srfeuserregister__pi1.html#o44">$templateCode</a> = $this-&gt;cObj-&gt;substituteSubpart($templateCode, '###SUB_INCLUDED_FIELD_'.$fName.'###', '');
<a name="l01306"></a>01306                                 } <span class="keywordflow">else</span> {
<a name="l01307"></a>01307                                         <span class="keywordflow">if</span> (is_array($this-&gt;conf['<a class="code" href="classtx__srfeuserregister__pi1.html#a42">parseValues</a>.']) &amp;&amp; strstr($this-&gt;conf['<a class="code" href="classtx__srfeuserregister__pi1.html#a42">parseValues</a>.'][$fName],'checkArray')) {
<a name="l01308"></a>01308                                                 $listOfCommands = t3lib_div::trimExplode(<span class="charliteral">','</span>, $this-&gt;conf['<a class="code" href="classtx__srfeuserregister__pi1.html#a42">parseValues</a>.'][$fName], 1);
<a name="l01309"></a>01309                                                         <span class="keywordflow">while</span> (list(, $cmd) = each($listOfCommands)) {
<a name="l01310"></a>01310                                                                 $cmdParts = split('\[|\]', $cmd); <span class="comment">// Point is to enable parameters after each command enclosed in brackets [..]. These will be in position 1 in the array.</span>
<a name="l01311"></a>01311                                                                 $theCmd = trim($cmdParts[0]);
<a name="l01312"></a>01312                                                                 <span class="keywordflow">switch</span>($theCmd) {
<a name="l01313"></a>01313                                                                         <span class="keywordflow">case</span> 'checkArray':
<a name="l01314"></a>01314                                                                                 $positions = t3lib_div::trimExplode(<span class="charliteral">';'</span>, $cmdParts[1]);
<a name="l01315"></a>01315                                                                                 <span class="keywordflow">for</span>($i=0; $i&lt;10; $i++) {
<a name="l01316"></a>01316                                                                                         <span class="keywordflow">if</span>(!in_array($i, $positions)) {
<a name="l01317"></a>01317                                                                                                 <a class="code" href="classtx__srfeuserregister__pi1.html#o44">$templateCode</a> = $this-&gt;cObj-&gt;substituteSubpart($templateCode, '###SUB_INCLUDED_FIELD_'.$fName.<span class="charliteral">'_'</span>.$i.'###', '');
<a name="l01318"></a>01318                                                                                         }
<a name="l01319"></a>01319                                                                                 }
<a name="l01320"></a>01320                                                                         <span class="keywordflow">break</span>;
<a name="l01321"></a>01321                                                                 }
<a name="l01322"></a>01322                                                         }
<a name="l01323"></a>01323                                         }
<a name="l01324"></a>01324                                 }
<a name="l01325"></a>01325                         }
<a name="l01326"></a>01326                 }
<a name="l01327"></a>01327                 <span class="keywordflow">return</span> <a class="code" href="classtx__srfeuserregister__pi1.html#o44">$templateCode</a>;
<a name="l01328"></a>01328         }
<a name="l01329"></a>01329          
<a name="l01337"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a30">01337</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a30">getPlainTemplate</a>($key, $r = '') {
<a name="l01338"></a>01338                 <a class="code" href="classtx__srfeuserregister__pi1.html#o44">$templateCode</a> = $this-&gt;cObj-&gt;getSubpart($this-&gt;templateCode, $key);
<a name="l01339"></a>01339                 <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a> = is_array($r) ? $this-&gt;cObj-&gt;fillInMarkerArray($this-&gt;markerArray, $r) :
<a name="l01340"></a>01340                 $this-&gt;markerArray;
<a name="l01341"></a>01341                 <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a> = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a4">addStaticInfoMarkers</a>($markerArray, $r);
<a name="l01342"></a>01342                 <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a> = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a3">addLabelMarkers</a>($markerArray, $r);
<a name="l01343"></a>01343                 <a class="code" href="classtx__srfeuserregister__pi1.html#o44">$templateCode</a> = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a48">removeStaticInfoSubparts</a>($templateCode, $markerArray);
<a name="l01344"></a>01344                 <span class="keywordflow">return</span> $this-&gt;cObj-&gt;substituteMarkerArray($templateCode, $markerArray);
<a name="l01345"></a>01345         }
<a name="l01346"></a>01346          
<a name="l01353"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a18">01353</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a18">displayEditForm</a>($origArr) {
<a name="l01354"></a>01354                 <span class="comment">// MLC mod merging</span>
<a name="l01355"></a>01355                 <a class="code" href="classtx__srfeuserregister__pi1.html#o12">$currentArr</a>                     = isset( $this-&gt;dataArr[ 'uid' ] )
<a name="l01356"></a>01356                                                                 ? array_merge( $origArr[ 0 ], $this-&gt;dataArr )
<a name="l01357"></a>01357                                                                 : $origArr[ 0 ];
<a name="l01358"></a>01358                 <a class="code" href="classtx__srfeuserregister__pi1.html#o44">$templateCode</a> = $this-&gt;cObj-&gt;getSubpart($this-&gt;templateCode, <span class="stringliteral">"###TEMPLATE_EDIT"</span>.$this-&gt;previewLabel.'###');
<a name="l01359"></a>01359                 <a class="code" href="classtx__srfeuserregister__pi1.html#o21">$failure</a> = t3lib_div::GPvar('noWarnings')?<span class="stringliteral">""</span>:
<a name="l01360"></a>01360                 $this-&gt;failure;
<a name="l01361"></a>01361                 <span class="keywordflow">if</span> (!$failure) {
<a name="l01362"></a>01362                         <a class="code" href="classtx__srfeuserregister__pi1.html#o44">$templateCode</a> = $this-&gt;cObj-&gt;substituteSubpart($templateCode, '###SUB_REQUIRED_FIELDS_WARNING###', '');
<a name="l01363"></a>01363                 }
<a name="l01364"></a>01364                 <a class="code" href="classtx__srfeuserregister__pi1.html#o44">$templateCode</a> = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a47">removeRequired</a>($templateCode, $failure);
<a name="l01365"></a>01365                 <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a> = $this-&gt;cObj-&gt;fillInMarkerArray($this-&gt;markerArray, $currentArr);
<a name="l01366"></a>01366                 <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a> = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a4">addStaticInfoMarkers</a>($markerArray, $currentArr);
<a name="l01367"></a>01367                 <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a> = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a3">addLabelMarkers</a>($markerArray, $currentArr);
<a name="l01368"></a>01368                 <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a> = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a2">addFileUploadMarkers</a>('image', $markerArray, $currentArr);
<a name="l01369"></a>01369                 <a class="code" href="classtx__srfeuserregister__pi1.html#o44">$templateCode</a> = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a48">removeStaticInfoSubparts</a>($templateCode, $markerArray);
<a name="l01370"></a>01370                 <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a>['###HIDDENFIELDS###'] .= '&lt;input type=<span class="stringliteral">"hidden"</span> name=<span class="stringliteral">"FE['.$this-&gt;theTable.'][uid]"</span> value=<span class="stringliteral">"'.$currentArr['uid'].'"</span> /&gt;';
<a name="l01371"></a>01371                 <span class="keywordflow">if</span> ( $this-&gt;theTable != 'fe_users' ) {
<a name="l01372"></a>01372                         <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a>['###HIDDENFIELDS###'] .= '&lt;input type=<span class="stringliteral">"hidden"</span> name=<span class="stringliteral">"'.$this-&gt;prefixId.'[aC]"</span> value=<span class="stringliteral">"'.$this-&gt;authCode($origArr).'"</span> /&gt;';
<a name="l01373"></a>01373                         <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a>['###HIDDENFIELDS###'] .= '&lt;input type=<span class="stringliteral">"hidden"</span> name=<span class="stringliteral">"'.$this-&gt;prefixId.'[cmd]"</span> value=<span class="stringliteral">"edit"</span> /&gt;';
<a name="l01374"></a>01374                 }
<a name="l01375"></a>01375                 <span class="keywordflow">if</span> ($this-&gt;conf['edit.']['preview'] &amp;&amp; !$this-&gt;previewLabel) {
<a name="l01376"></a>01376                         <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a>['###HIDDENFIELDS###'] .= '&lt;input type=<span class="stringliteral">"hidden"</span> name=<span class="stringliteral">"'.$this-&gt;prefixId.'[preview]"</span> value=<span class="stringliteral">"1"</span>&gt;';
<a name="l01377"></a>01377                 }
<a name="l01378"></a>01378                 $content = $this-&gt;cObj-&gt;substituteMarkerArray($templateCode, $markerArray);
<a name="l01379"></a>01379                 <span class="comment">// $content .= $this-&gt;cObj-&gt;getUpdateJS($this-&gt;modifyDataArrForFormUpdate($currentArr), $this-&gt;theTable."_form", "FE[".$this-&gt;theTable."]", $this-&gt;fieldList.$this-&gt;additionalUpdateFields);</span>
<a name="l01380"></a>01380                 $content .= $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a31">getUpdateJS</a>($this-&gt;modifyDataArrForFormUpdate($currentArr), $this-&gt;theTable.<span class="stringliteral">"_form"</span>, <span class="stringliteral">"FE["</span>.$this-&gt;theTable.<span class="stringliteral">"]"</span>, $this-&gt;fieldList.$this-&gt;additionalUpdateFields);
<a name="l01381"></a>01381                 <span class="keywordflow">return</span> $content;
<a name="l01382"></a>01382         }
<a name="l01383"></a>01383          
<a name="l01389"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a19">01389</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a19">displayEditScreen</a>() {
<a name="l01390"></a>01390                 <span class="keywordflow">if</span> ($this-&gt;conf['edit']) {
<a name="l01391"></a>01391                         <span class="comment">// If editing is enabled</span>
<a name="l01392"></a>01392                         $origArr = $GLOBALS['TSFE']-&gt;sys_page-&gt;getRawRecord($this-&gt;theTable, $this-&gt;dataArr['uid']?$this-&gt;dataArr['uid']:$this-&gt;recUid);
<a name="l01393"></a>01393                         <span class="comment">// MLC merge dataArr with origArr to capture inline edits</span>
<a name="l01394"></a>01394                         $origArr                        = array( $origArr, $this-&gt;dataArr );
<a name="l01395"></a>01395 
<a name="l01396"></a>01396                         <span class="comment">// MLC removes the silly PCO</span>
<a name="l01397"></a>01397                         $origArr[ 'zone' ]      = ( 'USA' != $origArr[ 'static_country_info' ]
<a name="l01398"></a>01398                                                                         &amp;&amp; 'PCO' == $origArr[ 'zone' ]
<a name="l01399"></a>01399                                                                 )
<a name="l01400"></a>01400                                                                         ? ''
<a name="l01401"></a>01401                                                                         : $origArr[ 'zone' ];
<a name="l01402"></a>01402 
<a name="l01403"></a>01403                         <span class="keywordflow">if</span>( $this-&gt;theTable != 'fe_users' &amp;&amp; $this-&gt;conf['<a class="code" href="classtx__srfeuserregister__pi1.html#a54">setfixed</a>.']['edit.']['_FIELDLIST']) {
<a name="l01404"></a>01404                                 $fD = t3lib_div::GPvar('fD', 1);
<a name="l01405"></a>01405                                 $fieldArr = array();
<a name="l01406"></a>01406                                 <span class="keywordflow">if</span> (is_array($fD)) {
<a name="l01407"></a>01407                                         reset($fD);
<a name="l01408"></a>01408                                         <span class="keywordflow">while</span> (list($field, $value) = each($fD)) {
<a name="l01409"></a>01409                                                 $origArr[$field] = rawurldecode($value);
<a name="l01410"></a>01410                                                 $fieldArr[] = $field;
<a name="l01411"></a>01411                                         }
<a name="l01412"></a>01412                                 }
<a name="l01413"></a>01413                                 $theCode = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a55">setfixedHash</a>($origArr, $origArr['_FIELDLIST']);
<a name="l01414"></a>01414                         }
<a name="l01415"></a>01415                         $origArr = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a40">parseIncomingTimestamps</a>($origArr);
<a name="l01416"></a>01416 
<a name="l01417"></a>01417                         <span class="keywordflow">if</span> ( is_array($origArr) &amp;&amp; ( ($this-&gt;theTable == 'fe_users' &amp;&amp; $GLOBALS['TSFE']-&gt;loginUser) || $this-&gt;aCAuth($origArr) || !strcmp($this-&gt;authCode, $theCode) ) ) {
<a name="l01418"></a>01418                                 <span class="comment">// Must be logged in OR be authenticated by the aC code in order to edit</span>
<a name="l01419"></a>01419                                 <span class="comment">// If the recUid selects a record.... (no check here)</span>
<a name="l01420"></a>01420                                 <span class="keywordflow">if</span> (is_array($origArr)) {
<a name="l01421"></a>01421                                         <span class="keywordflow">if</span> ( !strcmp($this-&gt;authCode, $this-&gt;theCode) || $this-&gt;aCAuth($origArr) || $this-&gt;cObj-&gt;DBmayFEUserEdit($this-&gt;theTable, $origArr, $GLOBALS['TSFE']-&gt;fe_user-&gt;user, $this-&gt;conf['allowedGroups'], $this-&gt;conf['fe_userEditSelf'])) {
<a name="l01422"></a>01422                                                 <span class="comment">// Display the form, if access granted.</span>
<a name="l01423"></a>01423                                                 $content = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a18">displayEditForm</a>($origArr);
<a name="l01424"></a>01424                                         } <span class="keywordflow">else</span> {
<a name="l01425"></a>01425                                                 <span class="comment">// Else display error, that you could not edit that particular record...</span>
<a name="l01426"></a>01426                                                 $content = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a30">getPlainTemplate</a>('###TEMPLATE_NO_PERMISSIONS###');
<a name="l01427"></a>01427                                         }
<a name="l01428"></a>01428                                 }
<a name="l01429"></a>01429                         } <span class="keywordflow">else</span> {
<a name="l01430"></a>01430                                 <span class="comment">// This is if there is no login user. This must tell that you must login. Perhaps link to a page with create-user or login information.</span>
<a name="l01431"></a>01431                                 $content = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a30">getPlainTemplate</a>('###TEMPLATE_AUTH###');
<a name="l01432"></a>01432                         }
<a name="l01433"></a>01433                          
<a name="l01434"></a>01434                 } <span class="keywordflow">else</span> {
<a name="l01435"></a>01435                         $content .= 'Edit-option is not set in TypoScript';
<a name="l01436"></a>01436                 }
<a name="l01437"></a>01437                 <span class="keywordflow">return</span> $content;
<a name="l01438"></a>01438                  
<a name="l01439"></a>01439         }
<a name="l01440"></a>01440          
<a name="l01446"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a15">01446</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a15">deleteRecord</a>() {
<a name="l01447"></a>01447                 <span class="keywordflow">if</span> ($this-&gt;conf['<span class="keyword">delete</span>']) {
<a name="l01448"></a>01448                         <span class="comment">// If deleting is enabled</span>
<a name="l01449"></a>01449                         $origArr = $GLOBALS['TSFE']-&gt;sys_page-&gt;getRawRecord($this-&gt;theTable, $this-&gt;recUid);
<a name="l01450"></a>01450                         <span class="keywordflow">if</span> ($GLOBALS['TSFE']-&gt;loginUser || $this-&gt;aCAuth($origArr)) {
<a name="l01451"></a>01451                                  
<a name="l01452"></a>01452                                 <span class="comment">// Must be logged in OR be authenticated by the aC code in order to delete</span>
<a name="l01453"></a>01453                                 <span class="comment">// If the recUid selects a record.... (no check here)</span>
<a name="l01454"></a>01454                                 <span class="keywordflow">if</span> (is_array($origArr)) {
<a name="l01455"></a>01455                                         <span class="keywordflow">if</span> ($this-&gt;aCAuth($origArr) || $this-&gt;cObj-&gt;DBmayFEUserEdit($this-&gt;theTable, $origArr, $GLOBALS['TSFE']-&gt;fe_user-&gt;user, $this-&gt;conf['allowedGroups'], $this-&gt;conf['fe_userEditSelf'])) {
<a name="l01456"></a>01456                                                 <span class="comment">// Display the form, if access granted.</span>
<a name="l01457"></a>01457                                                 <span class="keywordflow">if</span> (!$this-&gt;TCA['ctrl']['<span class="keyword">delete</span>'] || $this-&gt;conf['forceFileDelete']) {
<a name="l01458"></a>01458                                                         <span class="comment">// If the record is fully deleted... then remove the image attached.</span>
<a name="l01459"></a>01459                                                         $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a14">deleteFilesFromRecord</a>($this-&gt;recUid);
<a name="l01460"></a>01460                                                 }
<a name="l01461"></a>01461                                                  
<a name="l01462"></a>01462                                                 $query = $this-&gt;cObj-&gt;DBgetDelete($this-&gt;theTable, $this-&gt;recUid);
<a name="l01463"></a>01463                                                 $GLOBALS[ 'TYPO3_DB' ]-&gt;sql(TYPO3_db, $query);
<a name="l01464"></a>01464                                                 echo $GLOBALS[ 'TYPO3_DB' ]-&gt;sql_error();
<a name="l01465"></a>01465                                                 $this-&gt;currentArr = $origArr;
<a name="l01466"></a>01466                                                 $this-&gt;saved = 1;
<a name="l01467"></a>01467                                         } <span class="keywordflow">else</span> {
<a name="l01468"></a>01468                                                 $this-&gt;error = '###TEMPLATE_NO_PERMISSIONS###';
<a name="l01469"></a>01469                                         }
<a name="l01470"></a>01470                                 }
<a name="l01471"></a>01471                         }
<a name="l01472"></a>01472                 }
<a name="l01473"></a>01473         }
<a name="l01474"></a>01474          
<a name="l01481"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a14">01481</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a14">deleteFilesFromRecord</a>($uid) {
<a name="l01482"></a>01482                 <span class="comment">// Deletes the files attached to a record and updates the record.</span>
<a name="l01483"></a>01483                 $rec = $GLOBALS['TSFE']-&gt;sys_page-&gt;getRawRecord($this-&gt;theTable, $uid);
<a name="l01484"></a>01484                  
<a name="l01485"></a>01485                 reset($this-&gt;TCA['columns']);
<a name="l01486"></a>01486                 $iFields = array();
<a name="l01487"></a>01487                 <span class="keywordflow">while</span> (list($field, $conf) = each($this-&gt;TCA['columns'])) {
<a name="l01488"></a>01488                         <span class="keywordflow">if</span> ($conf['config']['type'] == <span class="stringliteral">"group"</span> &amp;&amp; $conf['config']['internal_type'] == 'file') {
<a name="l01489"></a>01489                                 $query = 'UPDATE '.$this-&gt;theTable.' SET '.$field.<span class="stringliteral">"='' WHERE uid="</span>.$uid;
<a name="l01490"></a>01490                                 $res = $GLOBALS[ 'TYPO3_DB' ]-&gt;sql(TYPO3_db, $query);
<a name="l01491"></a>01491                                 echo $GLOBALS[ 'TYPO3_DB' ]-&gt;sql_error();
<a name="l01492"></a>01492                                  
<a name="l01493"></a>01493                                 $delFileArr = explode(<span class="charliteral">','</span>, $rec[$field]);
<a name="l01494"></a>01494                                 reset($delFileArr);
<a name="l01495"></a>01495                                 <span class="keywordflow">while</span> (list(, $n) = each($delFileArr)) {
<a name="l01496"></a>01496                                         <span class="keywordflow">if</span> ($n) {
<a name="l01497"></a>01497                                                 $fpath = <a class="code" href="classtx__srfeuserregister__pi1.html#o9">$conf</a>['config']['uploadfolder'].<span class="charliteral">'/'</span>.$n;
<a name="l01498"></a>01498                                                 unlink($fpath);
<a name="l01499"></a>01499                                         }
<a name="l01500"></a>01500                                 }
<a name="l01501"></a>01501                         }
<a name="l01502"></a>01502                 }
<a name="l01503"></a>01503         }
<a name="l01504"></a>01504          
<a name="l01510"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a17">01510</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a17">displayDeleteScreen</a>() {
<a name="l01511"></a>01511                 <span class="keywordflow">if</span> ($this-&gt;conf['<span class="keyword">delete</span>']) {
<a name="l01512"></a>01512                         <span class="comment">// If deleting is enabled</span>
<a name="l01513"></a>01513                         $origArr = $GLOBALS['TSFE']-&gt;sys_page-&gt;getRawRecord($this-&gt;theTable, $this-&gt;recUid);
<a name="l01514"></a>01514                         <span class="keywordflow">if</span> ( ($this-&gt;theTable == 'fe_users' &amp;&amp; $GLOBALS['TSFE']-&gt;loginUser) || $this-&gt;aCAuth($origArr)) {
<a name="l01515"></a>01515                                 <span class="comment">// Must be logged in OR be authenticated by the aC code in order to delete</span>
<a name="l01516"></a>01516                                 <span class="comment">// If the recUid selects a record.... (no check here)</span>
<a name="l01517"></a>01517                                 <span class="keywordflow">if</span> (is_array($origArr)) {
<a name="l01518"></a>01518                                         <span class="keywordflow">if</span> ($this-&gt;aCAuth($origArr) || $this-&gt;cObj-&gt;DBmayFEUserEdit($this-&gt;theTable, $origArr, $GLOBALS['TSFE']-&gt;fe_user-&gt;user, $this-&gt;conf['allowedGroups'], $this-&gt;conf['fe_userEditSelf'])) {
<a name="l01519"></a>01519                                                 <span class="comment">// Display the form, if access granted.</span>
<a name="l01520"></a>01520                                                 $this-&gt;markerArray['###HIDDENFIELDS###'] .= '&lt;input type=<span class="stringliteral">"hidden"</span> name=<span class="stringliteral">"rU"</span> value=<span class="stringliteral">"'.$this-&gt;recUid.'"</span> /&gt;';
<a name="l01521"></a>01521                                                 <span class="keywordflow">if</span> ( $this-&gt;theTable != 'fe_users' ) {
<a name="l01522"></a>01522                                                         $this-&gt;markerArray['###HIDDENFIELDS###'] .= '&lt;input type=<span class="stringliteral">"hidden"</span> name=<span class="stringliteral">"'.$this-&gt;prefixId.'[aC]"</span> value=<span class="stringliteral">"'.$this-&gt;authCode($origArr).'"</span> /&gt;';
<a name="l01523"></a>01523                                                         $this-&gt;markerArray['###HIDDENFIELDS###'] .= '&lt;input type=<span class="stringliteral">"hidden"</span> name=<span class="stringliteral">"'.$this-&gt;prefixId.'[cmd]"</span> value=<span class="stringliteral">"delete"</span> /&gt;';
<a name="l01524"></a>01524                                                 }
<a name="l01525"></a>01525                                                 $content = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a30">getPlainTemplate</a>('###TEMPLATE_DELETE_PREVIEW###', $origArr);
<a name="l01526"></a>01526                                         } <span class="keywordflow">else</span> {
<a name="l01527"></a>01527                                                 <span class="comment">// Else display error, that you could not edit that particular record...</span>
<a name="l01528"></a>01528                                                 $content = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a30">getPlainTemplate</a>('###TEMPLATE_NO_PERMISSIONS###');
<a name="l01529"></a>01529                                         }
<a name="l01530"></a>01530                                 }
<a name="l01531"></a>01531                         } <span class="keywordflow">else</span> {
<a name="l01532"></a>01532                                 <span class="comment">// Finally this is if there is no login user. This must tell that you must login. Perhaps link to a page with create-user or login information.</span>
<a name="l01533"></a>01533                                 <span class="keywordflow">if</span> ( $this-&gt;theTable == 'fe_users' ) {
<a name="l01534"></a>01534                                         $content = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a30">getPlainTemplate</a>('###TEMPLATE_AUTH###');
<a name="l01535"></a>01535                                 } <span class="keywordflow">else</span> {
<a name="l01536"></a>01536                                         $content = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a30">getPlainTemplate</a>('###TEMPLATE_NO_PERMISSIONS###');
<a name="l01537"></a>01537                                 }
<a name="l01538"></a>01538                         }
<a name="l01539"></a>01539                 } <span class="keywordflow">else</span> {
<a name="l01540"></a>01540                         $content .= 'Delete-option is not set in TypoScript';
<a name="l01541"></a>01541                 }
<a name="l01542"></a>01542                 <span class="keywordflow">return</span> $content;
<a name="l01543"></a>01543         }
<a name="l01544"></a>01544          
<a name="l01550"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a16">01550</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a16">displayCreateScreen</a>($cmd = 'create') {
<a name="l01551"></a>01551                 <span class="keywordflow">if</span> ($this-&gt;conf['create']) {
<a name="l01552"></a>01552                         $key                            = (<a class="code" href="classtx__srfeuserregister__pi1.html#o5">$cmd</a> == 'invite')
<a name="l01553"></a>01553                                                                         ? 'INVITE'
<a name="l01554"></a>01554                                                                         : 'CREATE';
<a name="l01555"></a>01555                         <a class="code" href="classtx__srfeuserregister__pi1.html#o44">$templateCode</a> = $this-&gt;cObj-&gt;getSubpart($this-&gt;templateCode, ((!$GLOBALS['TSFE']-&gt;loginUser || $cmd == 'invite')?'###TEMPLATE_'.$key.$this-&gt;previewLabel.'###<span class="charliteral">':'</span>###TEMPLATE_CREATE_LOGIN###'));
<a name="l01556"></a>01556 
<a name="l01557"></a>01557                         <span class="comment">// MLC csv of failed fields</span>
<a name="l01558"></a>01558                         <a class="code" href="classtx__srfeuserregister__pi1.html#o21">$failure</a>                        = t3lib_div::GPvar('noWarnings')
<a name="l01559"></a>01559                                                                         ? ''
<a name="l01560"></a>01560                                                                         : $this-&gt;failure;
<a name="l01561"></a>01561                         <span class="keywordflow">if</span> ( !$failure )
<a name="l01562"></a>01562                         {
<a name="l01563"></a>01563                                 <a class="code" href="classtx__srfeuserregister__pi1.html#o44">$templateCode</a> = $this-&gt;cObj-&gt;substituteSubpart($templateCode, '###SUB_REQUIRED_FIELDS_WARNING###', '');
<a name="l01564"></a>01564                         }
<a name="l01565"></a>01565 
<a name="l01566"></a>01566                         <span class="comment">// MLC removes the silly PCO</span>
<a name="l01567"></a>01567                         $this-&gt;dataArr[ 'zone' ]        = (
<a name="l01568"></a>01568                                                                 'USA' != $this-&gt;dataArr[ 'static_country_info' ]
<a name="l01569"></a>01569                                                                         &amp;&amp; 'PCO' == $this-&gt;dataArr[ 'zone' ]
<a name="l01570"></a>01570                                                                 )
<a name="l01571"></a>01571                                                                         ? ''
<a name="l01572"></a>01572                                                                         : $this-&gt;dataArr[ 'zone' ];
<a name="l01573"></a>01573                         <a class="code" href="classtx__srfeuserregister__pi1.html#o44">$templateCode</a> = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a47">removeRequired</a>($templateCode, $failure);
<a name="l01574"></a>01574                         <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a> = $this-&gt;cObj-&gt;fillInMarkerArray($this-&gt;markerArray, $this-&gt;dataArr);
<a name="l01575"></a>01575                         <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a> = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a4">addStaticInfoMarkers</a>($markerArray, $this-&gt;dataArr);
<a name="l01576"></a>01576                         <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a> = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a2">addFileUploadMarkers</a>('image', $markerArray, $this-&gt;dataArr);
<a name="l01577"></a>01577                         <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a> = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a3">addLabelMarkers</a>($markerArray, $this-&gt;dataArr);
<a name="l01578"></a>01578                         <a class="code" href="classtx__srfeuserregister__pi1.html#o44">$templateCode</a> = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a48">removeStaticInfoSubparts</a>($templateCode, $markerArray);
<a name="l01579"></a>01579                         <span class="keywordflow">if</span> ($this-&gt;conf['create.']['preview'] &amp;&amp; !$this-&gt;previewLabel) {
<a name="l01580"></a>01580                                 <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a>['###HIDDENFIELDS###'] .= '&lt;input type=<span class="stringliteral">"hidden"</span> name=<span class="stringliteral">"'.$this-&gt;prefixId.'[preview]"</span> value=<span class="stringliteral">"1"</span>&gt;';
<a name="l01581"></a>01581                         }
<a name="l01582"></a>01582                         $content = $this-&gt;cObj-&gt;substituteMarkerArray($templateCode, $markerArray);
<a name="l01583"></a>01583                         <span class="comment">// $content .= $this-&gt;cObj-&gt;getUpdateJS($this-&gt;modifyDataArrForFormUpdate($this-&gt;dataArr), $this-&gt;theTable."_form", "FE[".$this-&gt;theTable."]", $this-&gt;fieldList.$this-&gt;additionalUpdateFields);</span>
<a name="l01584"></a>01584                         $content .= $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a31">getUpdateJS</a>($this-&gt;modifyDataArrForFormUpdate($this-&gt;dataArr), $this-&gt;theTable.<span class="stringliteral">"_form"</span>, <span class="stringliteral">"FE["</span>.$this-&gt;theTable.<span class="stringliteral">"]"</span>, $this-&gt;fieldList.$this-&gt;additionalUpdateFields);
<a name="l01585"></a>01585                 }
<a name="l01586"></a>01586                 <span class="keywordflow">return</span> $content;
<a name="l01587"></a>01587         }
<a name="l01588"></a>01588 
<a name="l01595"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a51">01595</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a51">sendInfoMail</a>() {
<a name="l01596"></a>01596                 <span class="keywordflow">if</span> ($this-&gt;conf['infomail'] &amp;&amp; $this-&gt;conf['email.']['field'])  {
<a name="l01597"></a>01597                         $fetch = $this-&gt;feUserData['fetch'];
<a name="l01598"></a>01598                         <span class="keywordflow">if</span> (isset($fetch))      {
<a name="l01599"></a>01599                                 $pidLock=' AND pid IN ('.$this-&gt;thePid.') ';
<a name="l01600"></a>01600 
<a name="l01601"></a>01601                                         <span class="comment">// Getting records</span>
<a name="l01602"></a>01602                                 <span class="keywordflow">if</span> ( $this-&gt;theTable == 'fe_users' &amp;&amp; t3lib_div::testInt($fetch) )      {
<a name="l01603"></a>01603                                         $DBrows = $GLOBALS['TSFE']-&gt;sys_page-&gt;getRecordsByField($this-&gt;theTable,'uid',$fetch,$pidLock,'<span class="charliteral">','</span><span class="charliteral">','</span>1');
<a name="l01604"></a>01604                                 } elseif ($fetch) {     <span class="comment">// $this-&gt;conf['email.']['field'] must be a valid field in the table!</span>
<a name="l01605"></a>01605                                         $DBrows = $GLOBALS['TSFE']-&gt;sys_page-&gt;getRecordsByField($this-&gt;theTable,$this-&gt;conf['email.']['field'],$fetch,$pidLock,'<span class="charliteral">','</span><span class="charliteral">','</span>100');
<a name="l01606"></a>01606                                 }
<a name="l01607"></a>01607                                         <span class="comment">// Processing records</span>
<a name="l01608"></a>01608                                 <span class="keywordflow">if</span> (is_array($DBrows))  {
<a name="l01609"></a>01609                                         $recipient = $DBrows[0][$this-&gt;conf['email.']['field']];
<a name="l01610"></a>01610                                         $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a9">compileMail</a>('INFOMAIL', $DBrows, trim($recipient), $this-&gt;conf['<a class="code" href="classtx__srfeuserregister__pi1.html#a54">setfixed</a>.']);
<a name="l01611"></a>01611                                 } elseif ($this-&gt;cObj-&gt;checkEmail($fetch)) {
<a name="l01612"></a>01612                                         $fetchArray = array( <span class="charliteral">'0'</span> =&gt; array( 'email' =&gt; $fetch));
<a name="l01613"></a>01613                                         $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a9">compileMail</a>('INFOMAIL_NORECORD', $fetchArray, $fetch);
<a name="l01614"></a>01614                                 }
<a name="l01615"></a>01615 
<a name="l01616"></a>01616                                 $content = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a30">getPlainTemplate</a>('###TEMPLATE_'.$this-&gt;infomailPrefix.'SENT###', (is_array($DBrows)?$DBrows[0]:''));
<a name="l01617"></a>01617                         } <span class="keywordflow">else</span> {
<a name="l01618"></a>01618                                 $content = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a30">getPlainTemplate</a>('###TEMPLATE_INFOMAIL###');
<a name="l01619"></a>01619                         }
<a name="l01620"></a>01620                 } <span class="keywordflow">else</span> {
<a name="l01621"></a>01621                         $content='Configuration error: infomail option is not available or emailField is not setup in TypoScript';
<a name="l01622"></a>01622                 }
<a name="l01623"></a>01623                 <span class="keywordflow">return</span> $content;
<a name="l01624"></a>01624         }
<a name="l01625"></a>01625          
<a name="l01632"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a37">01632</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a37">modifyDataArrForFormUpdate</a>($inputArr) {
<a name="l01633"></a>01633                 <span class="keywordflow">if</span> (is_array($this-&gt;conf[$this-&gt;cmdKey.<span class="charliteral">'.'</span>]['<a class="code" href="classtx__srfeuserregister__pi1.html#a25">evalValues</a>.'])) {
<a name="l01634"></a>01634                         reset($this-&gt;conf[$this-&gt;cmdKey.<span class="charliteral">'.'</span>]['<a class="code" href="classtx__srfeuserregister__pi1.html#a25">evalValues</a>.']);
<a name="l01635"></a>01635                          
<a name="l01636"></a>01636                         <span class="keywordflow">while</span> (list($theField, $theValue) = each($this-&gt;conf[$this-&gt;cmdKey.<span class="charliteral">'.'</span>]['<a class="code" href="classtx__srfeuserregister__pi1.html#a25">evalValues</a>.'])) {
<a name="l01637"></a>01637 
<a name="l01638"></a>01638                                 $listOfCommands = t3lib_div::trimExplode(<span class="charliteral">','</span>, $theValue, 1);
<a name="l01639"></a>01639                                 <span class="keywordflow">while</span> (list(, $cmd) = each($listOfCommands)) {
<a name="l01640"></a>01640                                         $cmdParts = split(<span class="stringliteral">"\[|\]"</span>, $cmd); <span class="comment">// Point is to enable parameters after each command enclosed in brackets [..]. These will be in position 1 in the array.</span>
<a name="l01641"></a>01641                                         $theCmd = trim($cmdParts[0]);
<a name="l01642"></a>01642                                         <span class="keywordflow">switch</span>($theCmd) {
<a name="l01643"></a>01643                                                 <span class="keywordflow">case</span> 'twice':
<a name="l01644"></a>01644                                                 <span class="keywordflow">if</span> (isset($inputArr[$theField])) {
<a name="l01645"></a>01645                                                         <span class="keywordflow">if</span> (!isset($inputArr[$theField.'_again'])) {
<a name="l01646"></a>01646                                                                 $inputArr[$theField.'_again'] = $inputArr[$theField];
<a name="l01647"></a>01647                                                         }
<a name="l01648"></a>01648                                                         $this-&gt;additionalUpdateFields .= <span class="charliteral">','</span>.$theField.'_again';
<a name="l01649"></a>01649                                                 }
<a name="l01650"></a>01650                                                 <span class="keywordflow">break</span>;
<a name="l01651"></a>01651                                         }
<a name="l01652"></a>01652                                 }
<a name="l01653"></a>01653                         }
<a name="l01654"></a>01654                 }
<a name="l01655"></a>01655                  
<a name="l01656"></a>01656                 <span class="keywordflow">if</span> (is_array($this-&gt;conf['<a class="code" href="classtx__srfeuserregister__pi1.html#a42">parseValues</a>.'])) {
<a name="l01657"></a>01657                         reset($this-&gt;conf['<a class="code" href="classtx__srfeuserregister__pi1.html#a42">parseValues</a>.']);
<a name="l01658"></a>01658                         <span class="keywordflow">while</span> (list($theField, $theValue) = each($this-&gt;conf['<a class="code" href="classtx__srfeuserregister__pi1.html#a42">parseValues</a>.'])) {
<a name="l01659"></a>01659                                 $listOfCommands = t3lib_div::trimExplode(<span class="charliteral">','</span>, $theValue, 1);
<a name="l01660"></a>01660                                 <span class="keywordflow">while</span> (list(, $cmd) = each($listOfCommands)) {
<a name="l01661"></a>01661                                         $cmdParts = split(<span class="stringliteral">"\[|\]"</span>, $cmd); <span class="comment">// Point is to enable parameters after each command enclosed in brackets [..]. These will be in position 1 in the array.</span>
<a name="l01662"></a>01662                                         $theCmd = trim($cmdParts[0]);
<a name="l01663"></a>01663                                         <span class="keywordflow">switch</span>($theCmd) {
<a name="l01664"></a>01664                                                 <span class="keywordflow">case</span> 'multiple':
<a name="l01665"></a>01665                                                 <span class="keywordflow">if</span> (isset($inputArr[$theField]) &amp;&amp; !$this-&gt;isPreview()) {
<a name="l01666"></a>01666                                                         $inputArr[$theField] = explode(<span class="charliteral">','</span>, $inputArr[$theField]);
<a name="l01667"></a>01667                                                 }
<a name="l01668"></a>01668                                                 <span class="keywordflow">break</span>;
<a name="l01669"></a>01669                                                 <span class="keywordflow">case</span> 'checkArray':
<a name="l01670"></a>01670                                                 <span class="keywordflow">if</span> ($inputArr[$theField] &amp;&amp; !$this-&gt;isPreview()) {
<a name="l01671"></a>01671                                                         <span class="keywordflow">for</span>($a = 0; $a &lt;= 30; $a++) {
<a name="l01672"></a>01672                                                                 <span class="keywordflow">if</span> ($inputArr[$theField] &amp; pow(2, $a)) {
<a name="l01673"></a>01673                                                                         $alt_theField = $theField.']['.$a;
<a name="l01674"></a>01674                                                                         $inputArr[$alt_theField] = 1;
<a name="l01675"></a>01675                                                                         $this-&gt;additionalUpdateFields .= <span class="charliteral">','</span>.$alt_theField;
<a name="l01676"></a>01676                                                                 }
<a name="l01677"></a>01677                                                         }
<a name="l01678"></a>01678                                                 }
<a name="l01679"></a>01679                                                 <span class="keywordflow">break</span>;
<a name="l01680"></a>01680                                         }
<a name="l01681"></a>01681                                 }
<a name="l01682"></a>01682                         }
<a name="l01683"></a>01683                 }
<a name="l01684"></a>01684                 $inputArr = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a62">userProcess_alt</a>($this-&gt;conf['userFunc_updateArray'], $this-&gt;conf['userFunc_updateArray.'], $inputArr );
<a name="l01685"></a>01685                 <span class="keywordflow">return</span> $inputArr;
<a name="l01686"></a>01686         }
<a name="l01687"></a>01687          
<a name="l01693"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a43">01693</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a43">procesSetFixed</a>() {
<a name="l01694"></a>01694                 <span class="keywordflow">if</span> ($this-&gt;setfixedEnabled) {
<a name="l01695"></a>01695                         $origArr = $GLOBALS['TSFE']-&gt;sys_page-&gt;getRawRecord($this-&gt;theTable, $this-&gt;recUid);
<a name="l01696"></a>01696                         $origUsergroup = $origArr['usergroup'];
<a name="l01697"></a>01697                         $fD = t3lib_div::GPvar('fD', 1);
<a name="l01698"></a>01698                         $fieldArr = array();
<a name="l01699"></a>01699                         <span class="keywordflow">if</span> (is_array($fD)) {
<a name="l01700"></a>01700                                 reset($fD);
<a name="l01701"></a>01701                                 <span class="keywordflow">while</span> (list($field, $value) = each($fD)) {
<a name="l01702"></a>01702                                         $origArr[$field] = rawurldecode($value);
<a name="l01703"></a>01703                                         $fieldArr[] = $field;
<a name="l01704"></a>01704                                 }
<a name="l01705"></a>01705                         }
<a name="l01706"></a>01706                          
<a name="l01707"></a>01707                         $theCode = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a55">setfixedHash</a>($origArr, $origArr['_FIELDLIST']);
<a name="l01708"></a>01708                         <span class="keywordflow">if</span> (!strcmp($this-&gt;authCode, $theCode)) {
<a name="l01709"></a>01709                                 <span class="keywordflow">if</span> ($this-&gt;feUserData['sFK'] == 'DELETE') {
<a name="l01710"></a>01710                                         <span class="keywordflow">if</span> (!$this-&gt;TCA['ctrl']['<span class="keyword">delete</span>'] || $this-&gt;conf['forceFileDelete']) {
<a name="l01711"></a>01711                                                 <span class="comment">// If the record is fully deleted... then remove the image attached.</span>
<a name="l01712"></a>01712                                                 $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a14">deleteFilesFromRecord</a>($this-&gt;recUid);
<a name="l01713"></a>01713                                         }
<a name="l01714"></a>01714                                         $query = $this-&gt;cObj-&gt;DBgetDelete($this-&gt;theTable, $this-&gt;recUid);
<a name="l01715"></a>01715                                         $GLOBALS[ 'TYPO3_DB' ]-&gt;sql(TYPO3_db, $query);
<a name="l01716"></a>01716                                         echo $GLOBALS[ 'TYPO3_DB' ]-&gt;sql_error();
<a name="l01717"></a>01717                                 } <span class="keywordflow">else</span> {
<a name="l01718"></a>01718                                         <span class="keywordflow">if</span> ($this-&gt;theTable == 'fe_users' &amp;&amp; $origUsergroup != $this-&gt;conf['create.']['<a class="code" href="classtx__srfeuserregister__pi1.html#a39">overrideValues</a>.']['usergroup'] ) {
<a name="l01719"></a>01719                                                 $origArr['usergroup'] = $origUsergroup;
<a name="l01720"></a>01720                                         }
<a name="l01721"></a>01721                                                 <span class="comment">// Hook: first we initialize the hooks</span>
<a name="l01722"></a>01722                                         $hookObjectsArr = array();
<a name="l01723"></a>01723                                         <span class="keywordflow">if</span> (is_array ($GLOBALS['TYPO3_CONF_VARS']['EXTCONF'][$this-&gt;extKey][$this-&gt;prefixId]['confirmRegistrationClass'])) {
<a name="l01724"></a>01724                                                 foreach  ($GLOBALS['TYPO3_CONF_VARS']['EXTCONF'][$this-&gt;extKey][$this-&gt;prefixId]['confirmRegistrationClass'] as $classRef) {
<a name="l01725"></a>01725                                                         $hookObjectsArr[] = &amp;t3lib_div::getUserObj($classRef);
<a name="l01726"></a>01726                                                 }
<a name="l01727"></a>01727                                         }
<a name="l01728"></a>01728                                                 <span class="comment">// Hook: confirmRegistrationClass_preProcess</span>
<a name="l01729"></a>01729                                         foreach($hookObjectsArr as $hookObj)    {
<a name="l01730"></a>01730                                                 <span class="keywordflow">if</span> (method_exists($hookObj, 'confirmRegistrationClass_preProcess')) {
<a name="l01731"></a>01731                                                         $hookObj-&gt;confirmRegistrationClass_preProcess($origArr, $<span class="keyword">this</span>);
<a name="l01732"></a>01732                                                 }
<a name="l01733"></a>01733                                         }
<a name="l01734"></a>01734                                         $newFieldList = implode(array_intersect(t3lib_div::trimExplode(<span class="charliteral">','</span>, $this-&gt;fieldList), t3lib_div::trimExplode(<span class="charliteral">','</span>, implode($fieldArr, <span class="charliteral">','</span>), 1)), <span class="charliteral">','</span>);
<a name="l01735"></a>01735                                         $query = $this-&gt;cObj-&gt;DBgetUpdate($this-&gt;theTable, $this-&gt;recUid, $origArr, $newFieldList);
<a name="l01736"></a>01736                                         $GLOBALS[ 'TYPO3_DB' ]-&gt;sql(TYPO3_db, $query);
<a name="l01737"></a>01737                                         echo $GLOBALS[ 'TYPO3_DB' ]-&gt;sql_error();
<a name="l01738"></a>01738                                                 <span class="comment">// Hook: confirmRegistrationClass_postProcess</span>
<a name="l01739"></a>01739                                         foreach($hookObjectsArr as $hookObj)    {
<a name="l01740"></a>01740                                                 <span class="keywordflow">if</span> (method_exists($hookObj, 'confirmRegistrationClass_postProcess')) {
<a name="l01741"></a>01741                                                         $hookObj-&gt;confirmRegistrationClass_preProcess($origArr, $<span class="keyword">this</span>);
<a name="l01742"></a>01742                                                 }
<a name="l01743"></a>01743                                         } 
<a name="l01744"></a>01744                                 }
<a name="l01745"></a>01745                                  
<a name="l01746"></a>01746                                 <span class="comment">// Outputting template</span>
<a name="l01747"></a>01747                                 $content = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a30">getPlainTemplate</a>('###TEMPLATE_SETFIXED_OK_'.$this-&gt;feUserData['sFK'].'###', $origArr);
<a name="l01748"></a>01748                                 <span class="keywordflow">if</span> (!$content) {
<a name="l01749"></a>01749                                         $content = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a30">getPlainTemplate</a>('###TEMPLATE_SETFIXED_OK###', $origArr);
<a name="l01750"></a>01750                                 }
<a name="l01751"></a>01751                                  
<a name="l01752"></a>01752                                 <span class="comment">// Compiling email</span>
<a name="l01753"></a>01753                                 $this-&gt;dataArr = $origArr;
<a name="l01754"></a>01754                                 $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a9">compileMail</a>(
<a name="l01755"></a>01755                                         $this-&gt;setfixedPrefix.$this-&gt;feUserData['sFK'],
<a name="l01756"></a>01756                                         array($origArr),
<a name="l01757"></a>01757                                         $origArr[$this-&gt;conf['email.']['field']],
<a name="l01758"></a>01758                                         $this-&gt;conf['<a class="code" href="classtx__srfeuserregister__pi1.html#a54">setfixed</a>.']
<a name="l01759"></a>01759                                 );
<a name="l01760"></a>01760                                  
<a name="l01761"></a>01761                                 <span class="comment">// Auto-login on confirmation</span>
<a name="l01762"></a>01762                                 <span class="keywordflow">if</span> ($this-&gt;theTable == 'fe_users' &amp;&amp; $this-&gt;feUserData['sFK'] == 'APPROVE' &amp;&amp; $this-&gt;conf['enableAutoLoginOnConfirmation']) {
<a name="l01763"></a>01763                                         $loginVars = array();
<a name="l01764"></a>01764                                         $loginVars['user'] = $origArr['username'];
<a name="l01765"></a>01765                                         $loginVars['pass'] = $origArr['password'];
<a name="l01766"></a>01766                                         $loginVars['pid'] = $this-&gt;thePid;
<a name="l01767"></a>01767                                         $loginVars['logintype'] = 'login';
<a name="l01768"></a>01768                                         $loginVars['redirect_url'] = htmlspecialchars(trim($this-&gt;conf['autoLoginRedirect_url']));
<a name="l01769"></a>01769                                         header('Location: '.t3lib_div::locationHeaderUrl($this-&gt;site_url.$this-&gt;cObj-&gt;getTypoLink_URL($this-&gt;loginPID.<span class="charliteral">','</span>.$GLOBALS['TSFE']-&gt;type, $loginVars)));
<a name="l01770"></a>01770                                         exit;
<a name="l01771"></a>01771                                 }
<a name="l01772"></a>01772                         } <span class="keywordflow">else</span> {
<a name="l01773"></a>01773                                 $content = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a30">getPlainTemplate</a>('###TEMPLATE_SETFIXED_FAILED###');
<a name="l01774"></a>01774                         }
<a name="l01775"></a>01775                 }
<a name="l01776"></a>01776                 <span class="keywordflow">return</span> $content;
<a name="l01777"></a>01777         }
<a name="l01778"></a>01778          
<a name="l01788"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a9">01788</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a9">compileMail</a>($key, $DBrows, $recipient, $setFixedConfig = array())
<a name="l01789"></a>01789         {
<a name="l01790"></a>01790                 <span class="comment">// MLC translate values to English</span>
<a name="l01791"></a>01791                 $DBrows                                 = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a12">dataArrTranslate</a>( $DBrows );
<a name="l01792"></a>01792 
<a name="l01793"></a>01793                 $mailContent = '';
<a name="l01794"></a>01794                 $userContent['all'] = '';
<a name="l01795"></a>01795                 $HTMLContent['all'] = '';
<a name="l01796"></a>01796                 $adminContent['all'] = '';
<a name="l01797"></a>01797                 <span class="keywordflow">if</span> (($this-&gt;conf['email.'][$key] ) || ($key == 'SETFIXED_CREATE' &amp;&amp; $this-&gt;setfixedEnabled) || ($key == 'SETFIXED_INVITE' &amp;&amp; $this-&gt;setfixedEnabled) ) {
<a name="l01798"></a>01798                         $userContent['all'] = trim($this-&gt;cObj-&gt;getSubpart($this-&gt;templateCode, '###'.$this-&gt;emailMarkPrefix.$key.'###'));
<a name="l01799"></a>01799                         $HTMLContent['all'] = ($this-&gt;HTMLMailEnabled &amp;&amp; $this-&gt;dataArr['module_sys_dmail_html']) ? trim($this-&gt;cObj-&gt;getSubpart($this-&gt;templateCode, '###'.$this-&gt;emailMarkPrefix.$key.$this-&gt;emailMarkHTMLSuffix.'###')):
<a name="l01800"></a>01800                         '';
<a name="l01801"></a>01801                 }
<a name="l01802"></a>01802                 <span class="keywordflow">if</span> ($this-&gt;conf['notify.'][$key] ) {
<a name="l01803"></a>01803                         $adminContent['all'] = trim($this-&gt;cObj-&gt;getSubpart($this-&gt;templateCode, '###'.$this-&gt;emailMarkPrefix.$key.$this-&gt;emailMarkAdminSuffix.'###'));
<a name="l01804"></a>01804                 }
<a name="l01805"></a>01805                 $userContent['rec'] = $this-&gt;cObj-&gt;getSubpart($userContent['all'], '###SUB_RECORD###');
<a name="l01806"></a>01806                 $HTMLContent['rec'] = $this-&gt;cObj-&gt;getSubpart($HTMLContent['all'], '###SUB_RECORD###');
<a name="l01807"></a>01807                 $adminContent['rec'] = $this-&gt;cObj-&gt;getSubpart($adminContent['all'], '###SUB_RECORD###');
<a name="l01808"></a>01808                  
<a name="l01809"></a>01809                 reset($DBrows);
<a name="l01810"></a>01810                 <span class="keywordflow">while</span> (list(, $r) = each($DBrows)) {
<a name="l01811"></a>01811                         <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a> = $this-&gt;cObj-&gt;fillInMarkerArray($this-&gt;markerArray, $r, '', 0);
<a name="l01812"></a>01812                         <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a>['###SYS_AUTHCODE###'] = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a6">authCode</a>($r);
<a name="l01813"></a>01813                         <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a> = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a54">setfixed</a>($markerArray, $setFixedConfig, $r);
<a name="l01814"></a>01814                         <span class="comment">// MLC don't forget to translate</span>
<a name="l01815"></a>01815                         <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a> = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a4">addStaticInfoMarkers</a>($markerArray, $r);
<a name="l01816"></a>01816                         <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a> = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a3">addLabelMarkers</a>($markerArray, $r);
<a name="l01817"></a>01817                         <span class="keywordflow">if</span> ($userContent['rec']) {
<a name="l01818"></a>01818                                 $userContent['accum'] .= $this-&gt;cObj-&gt;substituteMarkerArray($userContent['rec'], $markerArray);
<a name="l01819"></a>01819                         }
<a name="l01820"></a>01820                         <span class="keywordflow">if</span> ($HTMLContent['rec']) {
<a name="l01821"></a>01821                                 $HTMLContent['accum'] .= $this-&gt;cObj-&gt;substituteMarkerArray($HTMLContent['rec'], $markerArray);
<a name="l01822"></a>01822                         }
<a name="l01823"></a>01823                         <span class="keywordflow">if</span> ($adminContent['rec']) {
<a name="l01824"></a>01824                                 $adminContent['accum'] .= $this-&gt;cObj-&gt;substituteMarkerArray($adminContent['rec'], $markerArray);
<a name="l01825"></a>01825                         }
<a name="l01826"></a>01826                 }
<a name="l01827"></a>01827                 <span class="keywordflow">if</span> ($userContent['all']) {
<a name="l01828"></a>01828                         $userContent['<span class="keyword">final</span>'] .= strip_tags($this-&gt;cObj-&gt;substituteSubpart($userContent['all'], '###SUB_RECORD###', $userContent['accum']));
<a name="l01829"></a>01829                 }
<a name="l01830"></a>01830                 <span class="keywordflow">if</span> ($HTMLContent['all']) {
<a name="l01831"></a>01831                         $HTMLContent['<span class="keyword">final</span>'] .= $this-&gt;cObj-&gt;substituteSubpart($HTMLContent['all'], '###SUB_RECORD###', $this-&gt;pi_wrapInBaseClass($HTMLContent['accum']));
<a name="l01832"></a>01832                         $HTMLContent['<span class="keyword">final</span>'] = $this-&gt;cObj-&gt;substituteMarkerArray($HTMLContent['<span class="keyword">final</span>'], $markerArray);                         
<a name="l01833"></a>01833                 }
<a name="l01834"></a>01834                 <span class="keywordflow">if</span> ($adminContent['all']) {
<a name="l01835"></a>01835                         $adminContent['<span class="keyword">final</span>'] .= $this-&gt;cObj-&gt;substituteSubpart($adminContent['all'], '###SUB_RECORD###', $adminContent['accum']);
<a name="l01836"></a>01836                          
<a name="l01837"></a>01837                 }
<a name="l01838"></a>01838                  
<a name="l01839"></a>01839                 <span class="keywordflow">if</span> (t3lib_div::testInt($recipient)) {
<a name="l01840"></a>01840                         $fe_userRec = $GLOBALS['TSFE']-&gt;sys_page-&gt;getRawRecord('fe_users', $recipient);
<a name="l01841"></a>01841                         $recipient = $fe_userRec['email'];
<a name="l01842"></a>01842                 }
<a name="l01843"></a>01843                  
<a name="l01844"></a>01844                 <span class="comment">// Check if we need to add an attachment</span>
<a name="l01845"></a>01845                 <span class="keywordflow">if</span> ($this-&gt;conf['addAttachment'] &amp;&amp; $this-&gt;conf['addAttachment.']['cmd'] == $this-&gt;cmd &amp;&amp; $this-&gt;conf['addAttachment.']['sFK'] == $this-&gt;feUserData['sFK']) {
<a name="l01846"></a>01846                         $file = ($this-&gt;conf['addAttachment.']['file']) ? $GLOBALS['TSFE']-&gt;tmpl-&gt;getFileName($this-&gt;conf['addAttachment.']['file']):
<a name="l01847"></a>01847                         '';
<a name="l01848"></a>01848                 }
<a name="l01849"></a>01849                 $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a52">sendMail</a>($recipient, $this-&gt;conf['email.']['admin'], $userContent['<span class="keyword">final</span>'], $adminContent['<span class="keyword">final</span>'], $HTMLContent['<span class="keyword">final</span>'], $file);
<a name="l01850"></a>01850         }
<a name="l01851"></a>01851          
<a name="l01863"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a52">01863</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a52">sendMail</a>($recipient, $admin, $content = '', $adminContent = '', $HTMLContent = '', $fileAttachment = '') {
<a name="l01864"></a>01864                 <span class="comment">// Send mail to admin</span>
<a name="l01865"></a>01865                 <span class="keywordflow">if</span> ($admin &amp;&amp; $adminContent) {
<a name="l01866"></a>01866                         $this-&gt;cObj-&gt;sendNotifyEmail($adminContent, $admin, '', $this-&gt;conf['email.']['from'], $this-&gt;conf['email.']['fromName'], $recipient);
<a name="l01867"></a>01867                 }
<a name="l01868"></a>01868                 <span class="comment">// Send mail to front end user</span>
<a name="l01869"></a>01869                 <span class="keywordflow">if</span> ($this-&gt;HTMLMailEnabled &amp;&amp; $HTMLContent &amp;&amp; $this-&gt;dataArr['module_sys_dmail_html']) {
<a name="l01870"></a>01870                         $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a50">sendHTMLMail</a>($HTMLContent, $content, $recipient, '', $this-&gt;conf['email.']['from'], $this-&gt;conf['email.']['fromName'], '', $fileAttachment);
<a name="l01871"></a>01871                 } <span class="keywordflow">else</span> {
<a name="l01872"></a>01872                         $this-&gt;cObj-&gt;sendNotifyEmail($content, $recipient, '', $this-&gt;conf['email.']['from'], $this-&gt;conf['email.']['fromName']);
<a name="l01873"></a>01873                 }
<a name="l01874"></a>01874         }
<a name="l01875"></a>01875          
<a name="l01889"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a50">01889</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a50">sendHTMLMail</a>($HTMLContent, $PLAINContent, $recipient, $dummy, $fromEmail, $fromName, $replyTo = '', $fileAttachment = '') {
<a name="l01890"></a>01890                 <span class="comment">// HTML</span>
<a name="l01891"></a>01891                 <span class="keywordflow">if</span> (trim($recipient)) {
<a name="l01892"></a>01892                         $parts = spliti('&lt;title&gt;|&lt;/title&gt;', $HTMLContent, 3);
<a name="l01893"></a>01893                         $subject = trim($parts[1]) ? strip_tags(trim($parts[1])) :
<a name="l01894"></a>01894                         'Front end user registration message';
<a name="l01895"></a>01895                          
<a name="l01896"></a>01896                         $Typo3_htmlmail = t3lib_div::makeInstance('tx_srfeuserregister_pi1_t3lib_htmlmail');
<a name="l01897"></a>01897                         $Typo3_htmlmail-&gt;charset = 'iso-8859-1';
<a name="l01898"></a>01898                         $Typo3_htmlmail-&gt;start();
<a name="l01899"></a>01899                         $Typo3_htmlmail-&gt;messageid = md5(microtime());
<a name="l01900"></a>01900                         $Typo3_htmlmail-&gt;mailer = 'Typo3 HTMLMail';              
<a name="l01901"></a>01901                         $Typo3_htmlmail-&gt;subject = $Typo3_htmlmail-&gt;convertName($subject);
<a name="l01902"></a>01902                         $Typo3_htmlmail-&gt;from_email = $fromEmail;
<a name="l01903"></a>01903                         $Typo3_htmlmail-&gt;from_name = $fromName;
<a name="l01904"></a>01904                         $Typo3_htmlmail-&gt;from_name = implode(<span class="charliteral">' '</span> , t3lib_div::trimExplode(<span class="charliteral">','</span>, $Typo3_htmlmail-&gt;from_name));
<a name="l01905"></a>01905                         $Typo3_htmlmail-&gt;replyto_email = $replyTo ? $replyTo :$fromEmail;
<a name="l01906"></a>01906                         $Typo3_htmlmail-&gt;replyto_name = $replyTo ? '' : $fromName;
<a name="l01907"></a>01907                         $Typo3_htmlmail-&gt;replyto_name = implode(<span class="charliteral">' '</span> , t3lib_div::trimExplode(<span class="charliteral">','</span>, $Typo3_htmlmail-&gt;replyto_name));
<a name="l01908"></a>01908                         $Typo3_htmlmail-&gt;organisation = '';
<a name="l01909"></a>01909                         $Typo3_htmlmail-&gt;priority = 3;
<a name="l01910"></a>01910                          
<a name="l01911"></a>01911                         <span class="comment">// ATTACHMENT</span>
<a name="l01912"></a>01912                         <span class="keywordflow">if</span> ($fileAttachment &amp;&amp; file_exists($fileAttachment)) {
<a name="l01913"></a>01913                                 $Typo3_htmlmail-&gt;addAttachment($fileAttachment);
<a name="l01914"></a>01914                         }
<a name="l01915"></a>01915                          
<a name="l01916"></a>01916                         <span class="comment">// HTML</span>
<a name="l01917"></a>01917                         <span class="keywordflow">if</span> (trim($HTMLContent)) {
<a name="l01918"></a>01918                                 $Typo3_htmlmail-&gt;theParts['html']['content'] = $HTMLContent;
<a name="l01919"></a>01919                                 $Typo3_htmlmail-&gt;theParts['html']['path'] = '';
<a name="l01920"></a>01920                                 <span class="comment">// MLC don't include media in HTML emails</span>
<a name="l01921"></a>01921                                 <span class="comment">// $Typo3_htmlmail-&gt;extractMediaLinks();</span>
<a name="l01922"></a>01922                                 <span class="comment">// $Typo3_htmlmail-&gt;extractHyperLinks();</span>
<a name="l01923"></a>01923                                 <span class="comment">// $Typo3_htmlmail-&gt;fetchHTMLMedia();</span>
<a name="l01924"></a>01924                                 $Typo3_htmlmail-&gt;substMediaNamesInHTML(0); <span class="comment">// 0 = relative</span>
<a name="l01925"></a>01925                                 $Typo3_htmlmail-&gt;substHREFsInHTML();
<a name="l01926"></a>01926                                  
<a name="l01927"></a>01927                                 $Typo3_htmlmail-&gt;setHTML($Typo3_htmlmail-&gt;encodeMsg($Typo3_htmlmail-&gt;theParts['html']['content']));
<a name="l01928"></a>01928                         }
<a name="l01929"></a>01929                          
<a name="l01930"></a>01930                         <span class="comment">// PLAIN</span>
<a name="l01931"></a>01931                         $Typo3_htmlmail-&gt;addPlain($PLAINContent);
<a name="l01932"></a>01932                          
<a name="l01933"></a>01933                         <span class="comment">// SET Headers and Content</span>
<a name="l01934"></a>01934                         $Typo3_htmlmail-&gt;setHeaders();
<a name="l01935"></a>01935                         $Typo3_htmlmail-&gt;setContent();
<a name="l01936"></a>01936                         $Typo3_htmlmail-&gt;setRecipient($recipient);
<a name="l01937"></a>01937                         $Typo3_htmlmail-&gt;sendTheMail();
<a name="l01938"></a>01938                 }
<a name="l01939"></a>01939         }
<a name="l01940"></a>01940          
<a name="l01948"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a6">01948</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a6">authCode</a>($r, $extra = '') {
<a name="l01949"></a>01949                 $l = $this-&gt;codeLength;
<a name="l01950"></a>01950                 <span class="keywordflow">if</span> ($this-&gt;conf['authcodeFields']) {
<a name="l01951"></a>01951                         $fieldArr = t3lib_div::trimExplode(<span class="charliteral">','</span>, $this-&gt;conf['authcodeFields'], 1);
<a name="l01952"></a>01952                         $value = '';
<a name="l01953"></a>01953                          
<a name="l01954"></a>01954                         <span class="keywordflow">while</span> (list(, $field) = each($fieldArr)) {
<a name="l01955"></a>01955                                 $value .= $r[$field].<span class="charliteral">'|'</span>;
<a name="l01956"></a>01956                         }
<a name="l01957"></a>01957                         $value .= $extra.<span class="charliteral">'|'</span>.$this-&gt;conf['authcodeFields.']['addKey'];
<a name="l01958"></a>01958                         <span class="keywordflow">if</span> ($this-&gt;conf['authcodeFields.']['addDate']) {
<a name="l01959"></a>01959                                 $value .= <span class="charliteral">'|'</span>.date($this-&gt;conf['authcodeFields.']['addDate']);
<a name="l01960"></a>01960                         }
<a name="l01961"></a>01961                          
<a name="l01962"></a>01962                         $value .= $GLOBALS['TYPO3_CONF_VARS']['SYS']['encryptionKey'];
<a name="l01963"></a>01963                         <span class="keywordflow">return</span> substr(md5($value), 0, $l);
<a name="l01964"></a>01964                 }
<a name="l01965"></a>01965         }
<a name="l01966"></a>01966          
<a name="l01973"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a0">01973</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a0">aCAuth</a>($r) {
<a name="l01974"></a>01974                 <span class="keywordflow">if</span> ($this-&gt;authCode &amp;&amp; !strcmp($this-&gt;authCode, $this-&gt;authCode($r))) {
<a name="l01975"></a>01975                          
<a name="l01976"></a>01976                          
<a name="l01977"></a>01977                         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01978"></a>01978                 }
<a name="l01979"></a>01979         }
<a name="l01980"></a>01980          
<a name="l01989"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a54">01989</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a54">setfixed</a>($markerArray, $<a class="code" href="classtx__srfeuserregister__pi1.html#a54">setfixed</a>, $r) {
<a name="l01990"></a>01990                 <span class="keywordflow">if</span> ($this-&gt;setfixedEnabled &amp;&amp; is_array($<a class="code" href="classtx__srfeuserregister__pi1.html#a54">setfixed</a>) ) {
<a name="l01991"></a>01991                         $setfixedpiVars = array();
<a name="l01992"></a>01992                          
<a name="l01993"></a>01993                         reset($<a class="code" href="classtx__srfeuserregister__pi1.html#a54">setfixed</a>);
<a name="l01994"></a>01994                         <span class="keywordflow">while</span> (list($theKey, $data) = each($<a class="code" href="classtx__srfeuserregister__pi1.html#a54">setfixed</a>)) {
<a name="l01995"></a>01995                                 <span class="keywordflow">if</span> (strstr($theKey, <span class="charliteral">'.'</span>) ) {
<a name="l01996"></a>01996                                         $theKey = substr($theKey, 0, -1);
<a name="l01997"></a>01997                                 }
<a name="l01998"></a>01998                                 unset($setfixedpiVars);
<a name="l01999"></a>01999                                  
<a name="l02000"></a>02000                                 $recCopy = $r;
<a name="l02001"></a>02001                                 $setfixedpiVars[$this-&gt;prefixId.'[rU]'] = $r[uid];
<a name="l02002"></a>02002 
<a name="l02003"></a>02003                                 <span class="keywordflow">if</span> ( $this-&gt;theTable != 'fe_users' &amp;&amp; $theKey == 'EDIT' ) {
<a name="l02004"></a>02004                                         $setfixedpiVars[$this-&gt;prefixId.'[cmd]'] = 'edit';
<a name="l02005"></a>02005                                         <span class="keywordflow">if</span> (is_array($data) ) {
<a name="l02006"></a>02006                                                 reset($data);
<a name="l02007"></a>02007                                                 <span class="keywordflow">while</span> (list($fieldName, $fieldValue) = each($data)) {
<a name="l02008"></a>02008                                                         $setfixedpiVars['fD['.$fieldName.<span class="charliteral">']'</span>] = rawurlencode($fieldValue);
<a name="l02009"></a>02009                                                         $recCopy[$fieldName] = $fieldValue;
<a name="l02010"></a>02010                                                 }
<a name="l02011"></a>02011                                         }
<a name="l02012"></a>02012                                         <span class="keywordflow">if</span>( $this-&gt;conf['edit.']['<a class="code" href="classtx__srfeuserregister__pi1.html#a54">setfixed</a>']) {
<a name="l02013"></a>02013                                                 $setfixedpiVars[$this-&gt;prefixId.'[aC]'] = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a55">setfixedHash</a>($recCopy, $data['_FIELDLIST']);
<a name="l02014"></a>02014                                         } <span class="keywordflow">else</span> {
<a name="l02015"></a>02015                                                 $setfixedpiVars[$this-&gt;prefixId.'[aC]'] = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a6">authCode</a>($r);
<a name="l02016"></a>02016                                         }
<a name="l02017"></a>02017                                         $linkPID = $this-&gt;editPID;
<a name="l02018"></a>02018                                 } <span class="keywordflow">else</span> {
<a name="l02019"></a>02019                                         $setfixedpiVars[$this-&gt;prefixId.'[cmd]'] = '<a class="code" href="classtx__srfeuserregister__pi1.html#a54">setfixed</a>';
<a name="l02020"></a>02020                                         $setfixedpiVars[$this-&gt;prefixId.'[sFK]'] = $theKey;
<a name="l02021"></a>02021                                         <span class="keywordflow">if</span> (is_array($data) ) {
<a name="l02022"></a>02022                                                 reset($data);
<a name="l02023"></a>02023                                                 <span class="keywordflow">while</span> (list($fieldName, $fieldValue) = each($data)) {
<a name="l02024"></a>02024                                                         $setfixedpiVars['fD['.$fieldName.<span class="charliteral">']'</span>] = rawurlencode($fieldValue);
<a name="l02025"></a>02025                                                         $recCopy[$fieldName] = $fieldValue;
<a name="l02026"></a>02026                                                 }
<a name="l02027"></a>02027                                         }
<a name="l02028"></a>02028                                         $setfixedpiVars[$this-&gt;prefixId.'[aC]'] = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a55">setfixedHash</a>($recCopy, $data['_FIELDLIST']);
<a name="l02029"></a>02029                                         $linkPID = $this-&gt;confirmPID;
<a name="l02030"></a>02030                                 }
<a name="l02031"></a>02031 
<a name="l02032"></a>02032                                 <span class="keywordflow">if</span> (t3lib_div::GPvar(<span class="charliteral">'L'</span>) ) {
<a name="l02033"></a>02033                                         $setfixedpiVars[<span class="charliteral">'L'</span>] = t3lib_div::GPvar(<span class="charliteral">'L'</span>);
<a name="l02034"></a>02034                                 }
<a name="l02035"></a>02035 
<a name="l02036"></a>02036                                 <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a>['###SETFIXED_'.strtoupper($theKey).'_URL###'] = $this-&gt;site_url.$this-&gt;cObj-&gt;getTypoLink_URL($linkPID.<span class="charliteral">','</span>.$this-&gt;confirmType, $setfixedpiVars);
<a name="l02037"></a>02037 
<a name="l02038"></a>02038                         }
<a name="l02039"></a>02039                 }
<a name="l02040"></a>02040                 <span class="keywordflow">return</span> <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a>;
<a name="l02041"></a>02041         }
<a name="l02042"></a>02042          
<a name="l02051"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a55">02051</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a55">setfixedHash</a>($recCopy, $fields = '') {
<a name="l02052"></a>02052                 <span class="keywordflow">if</span> ($fields) {
<a name="l02053"></a>02053                         $fieldArr = t3lib_div::trimExplode(<span class="charliteral">','</span>, $fields, 1);
<a name="l02054"></a>02054                         reset($fieldArr);
<a name="l02055"></a>02055                         <span class="keywordflow">while</span> (list($k, $v) = each($fieldArr)) {
<a name="l02056"></a>02056                                 $recCopy_temp[$k] = $recCopy[$v];
<a name="l02057"></a>02057                                  
<a name="l02058"></a>02058                         }
<a name="l02059"></a>02059 
<a name="l02060"></a>02060                 } <span class="keywordflow">else</span> {
<a name="l02061"></a>02061                         $recCopy_temp = $recCopy;
<a name="l02062"></a>02062                 }
<a name="l02063"></a>02063                 $encStr = implode(<span class="charliteral">'|'</span>, $recCopy_temp).<span class="charliteral">'|'</span>.$this-&gt;conf['authcodeFields.']['addKey'].<span class="charliteral">'|'</span>.$GLOBALS['TYPO3_CONF_VARS']['SYS']['encryptionKey'];
<a name="l02064"></a>02064                 $hash = substr(md5($encStr), 0, $this-&gt;codeLength);
<a name="l02065"></a>02065                 <span class="keywordflow">return</span> $hash;
<a name="l02066"></a>02066         }
<a name="l02067"></a>02067          
<a name="l02075"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a33">02075</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a33">isPreview</a>() {
<a name="l02076"></a>02076                 <span class="keywordflow">return</span> ($this-&gt;conf[$this-&gt;cmdKey.<span class="charliteral">'.'</span>]['preview'] &amp;&amp; $this-&gt;feUserData['preview']);
<a name="l02077"></a>02077         }
<a name="l02078"></a>02078          
<a name="l02084"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a10">02084</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a10">createFileFuncObj</a>() {
<a name="l02085"></a>02085                 <span class="keywordflow">if</span> (!$this-&gt;fileFunc) {
<a name="l02086"></a>02086                         $this-&gt;fileFunc = t3lib_div::makeInstance('t3lib_basicFileFunctions');
<a name="l02087"></a>02087                          
<a name="l02088"></a>02088                 }
<a name="l02089"></a>02089                  
<a name="l02090"></a>02090         }
<a name="l02091"></a>02091          
<a name="l02099"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a3">02099</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a3">addLabelMarkers</a>($markerArray, $dataArray) {
<a name="l02100"></a>02100                  
<a name="l02101"></a>02101                 <span class="comment">// Data field labels</span>
<a name="l02102"></a>02102                 $infoFields = explode(<span class="charliteral">','</span>, $this-&gt;fieldList);
<a name="l02103"></a>02103                 <span class="keywordflow">while</span> (list(, $fName) = each($infoFields) ) {
<a name="l02104"></a>02104                         <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a>['###LABEL_'.strtoupper($fName).'###'] = $this-&gt;pi_getLL($fName);
<a name="l02105"></a>02105                         <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a>['###FIELD_'.$fName.'_CHECKED###'] = ($dataArray[$fName])?'checked':
<a name="l02106"></a>02106                         '';
<a name="l02107"></a>02107                         <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a>['###LABEL_'.$fName.'_CHECKED###'] = ($dataArray[$fName])?$this-&gt;pi_getLL('yes'):
<a name="l02108"></a>02108                         $this-&gt;pi_getLL('no');
<a name="l02109"></a>02109                         <span class="keywordflow">if</span> (in_array(trim($fName), $this-&gt;requiredArr) ) {
<a name="l02110"></a>02110                                 <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a>['###REQUIRED_'.strtoupper($fName).'###'] = <span class="charliteral">'*'</span>;
<a name="l02111"></a>02111                                 <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a>['###MISSING_'.strtoupper($fName).'###'] = $this-&gt;pi_getLL('missing_'.$fName);
<a name="l02112"></a>02112                                 <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a>['###MISSING_INVITATION_'.strtoupper($fName).'###'] = $this-&gt;pi_getLL('missing_invitation_'.$fName);
<a name="l02113"></a>02113                         } <span class="keywordflow">else</span> {
<a name="l02114"></a>02114                                 <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a>['###REQUIRED_'.strtoupper($fName).'###'] = '';
<a name="l02115"></a>02115                         }
<a name="l02116"></a>02116                 }
<a name="l02117"></a>02117                 <span class="comment">// Button labels</span>
<a name="l02118"></a>02118                 $buttonLabelsList = '<span class="keyword">register</span>,confirm_register,back_to_form,update,confirm_update,enter,confirm_delete,cancel_delete,cancel_update';
<a name="l02119"></a>02119                 $buttonLabels = t3lib_div::trimExplode(<span class="charliteral">','</span>, $buttonLabelsList);
<a name="l02120"></a>02120                 <span class="keywordflow">while</span> (list(, $labelName) = each($buttonLabels) ) {
<a name="l02121"></a>02121                         <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a>['###LABEL_BUTTON_'.strtoupper($labelName).'###'] = $this-&gt;pi_getLL('button_'.$labelName);
<a name="l02122"></a>02122                 }
<a name="l02123"></a>02123                 <span class="comment">// Labels possibly with variables</span>
<a name="l02124"></a>02124                 $otherLabelsList = 'yes,no,password_repeat,click_here_to_register,click_here_to_edit,click_here_to_delete,'. ',copy_paste_link,enter_account_info,enter_invitation_account_info,required_info_notice,excuse_us'. ',registration_problem,registration_sorry,registration_clicked_twice,registration_help,kind_regards'. ',v_verify_before_create,v_verify_invitation_before_create,v_verify_before_update,v_really_wish_to_delete,v_edit_your_account'. ',v_dear,v_now_enter_your_username,v_notification'. ',v_registration_created,v_registration_created_subject,v_registration_created_message1,v_registration_created_message2'. ',v_please_confirm,v_your_account_was_created,v_follow_instructions1,v_follow_instructions2'. ',v_invitation_confirm,v_invitation_account_was_created,v_invitation_instructions1'. ',v_registration_initiated,v_registration_initiated_subject,v_registration_initiated_message1,v_registration_initiated_message2'. ',v_registration_invited,v_registration_invited_subject,v_registration_invited_message1,v_registration_invited_message2'. ',v_registration_confirmed,v_registration_confirmed_subject,v_registration_confirmed_message1,v_registration_confirmed_message2'. ',v_registration_cancelled,v_registration_cancelled_subject,v_registration_cancelled_message1,v_registration_cancelled_message2'. ',v_registration_updated,v_registration_updated_subject,v_registration_updated_message1'. ',v_registration_deleted,v_registration_deleted_subject,v_registration_deleted_message1,v_registration_deleted_message2';
<a name="l02125"></a>02125                 $otherLabels = t3lib_div::trimExplode(<span class="charliteral">','</span>, $otherLabelsList);
<a name="l02126"></a>02126                 <span class="keywordflow">while</span> (list(, $labelName) = each($otherLabels) ) {
<a name="l02127"></a>02127                         <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a>['###LABEL_'.strtoupper($labelName).'###'] = sprintf($this-&gt;pi_getLL($labelName), $this-&gt;thePidTitle, $dataArray['username'], $dataArray['name'], $dataArray['email'], $dataArray['password']);
<a name="l02128"></a>02128                          
<a name="l02129"></a>02129                 }
<a name="l02130"></a>02130                 <span class="keywordflow">return</span> <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a>;
<a name="l02131"></a>02131         }
<a name="l02132"></a>02132          
<a name="l02139"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a5">02139</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a5">addURLMarkers</a>($markerArray) {
<a name="l02140"></a>02140                 $vars = array();
<a name="l02141"></a>02141                 $unsetVarsList = 'backURL,submit,rU,aC,sFK,doNotSave,preview';
<a name="l02142"></a>02142                 $unsetVars = t3lib_div::trimExplode(<span class="charliteral">','</span>, $unsetVarsList);
<a name="l02143"></a>02143 
<a name="l02144"></a>02144                 $unsetVars['cmd'] = 'cmd';
<a name="l02145"></a>02145                 <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a>['###FORM_URL###'] = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a27">get_url</a>('', $GLOBALS['TSFE']-&gt;<span class="keywordtype">id</span>.<span class="charliteral">','</span>.$GLOBALS['TSFE']-&gt;type, $vars, $unsetVars);
<a name="l02146"></a>02146                 <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a>['###FORM_NAME###'] = $this-&gt;conf['formName'];
<a name="l02147"></a>02147                 $unsetVars['cmd'] = '';
<a name="l02148"></a>02148 
<a name="l02149"></a>02149                 $vars['cmd'] = '<span class="keyword">delete</span>';
<a name="l02150"></a>02150                 $vars['backURL'] = rawurlencode($markerArray['###FORM_URL###']);
<a name="l02151"></a>02151                 $vars['rU'] = $this-&gt;recUid;
<a name="l02152"></a>02152                 $vars['preview'] = <span class="charliteral">'1'</span>;
<a name="l02153"></a>02153                 <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a>['###DELETE_URL###'] = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a27">get_url</a>('', $this-&gt;editPID.<span class="charliteral">','</span>.$GLOBALS['TSFE']-&gt;type, $vars);
<a name="l02154"></a>02154                  
<a name="l02155"></a>02155                 $vars['cmd'] = 'create';
<a name="l02156"></a>02156                 <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a>['###REGISTER_URL###'] = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a27">get_url</a>('', $this-&gt;registerPID.<span class="charliteral">','</span>.$GLOBALS['TSFE']-&gt;type, $vars, $unsetVars);
<a name="l02157"></a>02157                 $vars['cmd'] = 'edit';
<a name="l02158"></a>02158                 <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a>['###EDIT_URL###'] = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a27">get_url</a>('', $this-&gt;editPID.<span class="charliteral">','</span>.$GLOBALS['TSFE']-&gt;type, $vars, $unsetVars);
<a name="l02159"></a>02159                 $vars['cmd'] = 'login';
<a name="l02160"></a>02160                 <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a>['###LOGIN_FORM###'] = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a27">get_url</a>('', $this-&gt;loginPID.<span class="charliteral">','</span>.$GLOBALS['TSFE']-&gt;type, $vars, $unsetVars);
<a name="l02161"></a>02161                 $vars['cmd'] = 'infomail';
<a name="l02162"></a>02162                 <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a>['###INFOMAIL_URL###'] = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a27">get_url</a>('', $this-&gt;registerPID.<span class="charliteral">','</span>.$GLOBALS['TSFE']-&gt;type, $vars, $unsetVars);
<a name="l02163"></a>02163                  
<a name="l02164"></a>02164                 <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a>['###THE_PID###'] = $this-&gt;thePid;
<a name="l02165"></a>02165                 <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a>['###THE_PID_TITLE###'] = $this-&gt;thePidTitle;
<a name="l02166"></a>02166                 <span class="comment">// MLC check that referrer is on current site, otherwise leave alone</span>
<a name="l02167"></a>02167                 <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a>['###REDIRECT###'] = $this-&gt;dataArr[ 'referrer_uri' ];
<a name="l02168"></a>02168                 <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a>['###TEMPUSER###'] = $this-&gt;dataArr[ 'username' ];
<a name="l02169"></a>02169                 <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a>['###TEMPPASS###'] = $this-&gt;dataArr[ 'password' ];
<a name="l02170"></a>02170                 <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a>['###STARTTIME###'] = $this-&gt;dataArr[ 'starttime' ];
<a name="l02171"></a>02171                 <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a>['###ENDTIME###'] = $this-&gt;dataArr[ 'endtime' ];
<a name="l02172"></a>02172                 <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a>['###BACK_URL###'] = $this-&gt;backURL;
<a name="l02173"></a>02173                 <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a>['###SITE_NAME###'] = $this-&gt;conf['email.']['fromName'];
<a name="l02174"></a>02174                 <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a>['###SITE_URL###'] = $this-&gt;site_url;
<a name="l02175"></a>02175                 <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a>['###SITE_WWW###'] = t3lib_div::getIndpEnv('TYPO3_HOST_ONLY');
<a name="l02176"></a>02176                 <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a>['###SITE_EMAIL###'] = $this-&gt;conf['email.']['from'];
<a name="l02177"></a>02177 
<a name="l02178"></a>02178                 <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a>['###HIDDENFIELDS###'] = '';
<a name="l02179"></a>02179                 <span class="keywordflow">if</span>( $this-&gt;theTable == 'fe_users' ) <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a>['###HIDDENFIELDS###'] = ($this-&gt;cmd?'&lt;input type=<span class="stringliteral">"hidden"</span> name=<span class="stringliteral">"'.$this-&gt;prefixId.'[cmd]"</span> value=<span class="stringliteral">"'.$this-&gt;cmd.'"</span>&gt;<span class="charliteral">':'</span>'). ($this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a6">authCode</a>?'&lt;input type=<span class="stringliteral">"hidden"</span> name=<span class="stringliteral">"'.$this-&gt;prefixId.'[aC]"</span> value=<span class="stringliteral">"'.$this-&gt;authCode.'"</span>&gt;<span class="charliteral">':'</span>'). ($this-&gt;backURL?'&lt;input type=<span class="stringliteral">"hidden"</span> name=<span class="stringliteral">"'.$this-&gt;prefixId.'[backURL]"</span> value=<span class="stringliteral">"'.htmlspecialchars($this-&gt;backURL).'"</span>&gt;<span class="charliteral">':'</span>');
<a name="l02180"></a>02180                 <span class="keywordflow">return</span> <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a>;
<a name="l02181"></a>02181         }
<a name="l02182"></a>02182          
<a name="l02192"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a4">02192</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a4">addStaticInfoMarkers</a>($markerArray, $dataArray = '') {
<a name="l02193"></a>02193                  
<a name="l02194"></a>02194                  <span class="comment">// MLC always provide translation</span>
<a name="l02195"></a>02195                 <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a>['###FIELD_static_info_country###'] = $this-&gt;staticInfo-&gt;getStaticInfoName('COUNTRIES', is_array($dataArray)?$dataArray['static_info_country']:'');
<a name="l02196"></a>02196                 <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a>['###FIELD_zone###'] = $this-&gt;staticInfo-&gt;getStaticInfoName('SUBDIVISIONS', is_array($dataArray)?$dataArray['zone']:'', is_array($dataArray)?$dataArray['static_info_country']:'');
<a name="l02197"></a>02197                 <span class="keywordflow">if</span> (!$markerArray['###FIELD_zone###'] ) {
<a name="l02198"></a>02198                         <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a>['###FIELD_zone###'] = is_array($dataArray)?$dataArray['zone']:'';
<a name="l02199"></a>02199                 }
<a name="l02200"></a>02200                 <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a>['###FIELD_language###'] = $this-&gt;staticInfo-&gt;getStaticInfoName('LANGUAGES', is_array($dataArray)?$dataArray['language']:'');
<a name="l02201"></a>02201 
<a name="l02202"></a>02202                 <span class="keywordflow">if</span> (! $this-&gt;previewLabel ) {
<a name="l02203"></a>02203                         <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a>['###SELECTOR_STATIC_INFO_COUNTRY###'] = $this-&gt;staticInfo-&gt;buildStaticInfoSelector('COUNTRIES', 'FE['.$this-&gt;theTable.<span class="charliteral">']'</span>.'[static_info_country]', '', is_array($dataArray)?$dataArray['static_info_country']:'', '', $this-&gt;conf['onChangeCountryAttribute']);
<a name="l02204"></a>02204                         <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a>['###SELECTOR_ZONE###'] = $this-&gt;staticInfo-&gt;buildStaticInfoSelector('SUBDIVISIONS', 'FE['.$this-&gt;theTable.<span class="charliteral">']'</span>.'[zone]', '', is_array($dataArray)?$dataArray['zone']:'', is_array($dataArray)?$dataArray['static_info_country']:'');
<a name="l02205"></a>02205                         <span class="keywordflow">if</span> (!$markerArray['###SELECTOR_ZONE###'] ) {
<a name="l02206"></a>02206                                 <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a>['###SELECTOR_ZONE###'] = '&lt;input type=<span class="stringliteral">"text"</span> name=<span class="stringliteral">"FE['.$this-&gt;theTable.'][zone]"</span> size=<span class="stringliteral">"20"</span> /&gt;';
<a name="l02207"></a>02207                                 <span class="comment">// MLC offer blank instead</span>
<a name="l02208"></a>02208                                 <span class="comment">// $markerArray['###HIDDENFIELDS###'] .= '&lt;input type="hidden" name="FE['.$this-&gt;theTable.'][zone]" value=""&gt;';</span>
<a name="l02209"></a>02209                         }
<a name="l02210"></a>02210                         <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a>['###SELECTOR_LANGUAGE###'] = $this-&gt;staticInfo-&gt;buildStaticInfoSelector('LANGUAGES', 'FE['.$this-&gt;theTable.<span class="charliteral">']'</span>.'[language]', '', is_array($dataArray)?$dataArray['language']:'');
<a name="l02211"></a>02211                 }
<a name="l02212"></a>02212                 <span class="keywordflow">return</span> <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a>;
<a name="l02213"></a>02213         }
<a name="l02214"></a>02214          
<a name="l02222"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a48">02222</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a48">removeStaticInfoSubparts</a>($templateCode, $markerArray) {
<a name="l02223"></a>02223                  
<a name="l02224"></a>02224                 <span class="keywordflow">if</span> ($this-&gt;previewLabel ) {
<a name="l02225"></a>02225                         <span class="keywordflow">if</span> (!$markerArray['###FIELD_zone###'] ) {
<a name="l02226"></a>02226                                 <a class="code" href="classtx__srfeuserregister__pi1.html#o44">$templateCode</a> = $this-&gt;cObj-&gt;substituteSubpart($templateCode, '###SUB_INCLUDED_FIELD_'.zone.'###', '');
<a name="l02227"></a>02227                         }
<a name="l02228"></a>02228                 } <span class="keywordflow">else</span> {
<a name="l02229"></a>02229                         <span class="keywordflow">if</span> (!$markerArray['###SELECTOR_ZONE###'] ) {
<a name="l02230"></a>02230                                 <a class="code" href="classtx__srfeuserregister__pi1.html#o44">$templateCode</a> = $this-&gt;cObj-&gt;substituteSubpart($templateCode, '###SUB_INCLUDED_FIELD_'.zone.'###', '');
<a name="l02231"></a>02231                                  
<a name="l02232"></a>02232                         }
<a name="l02233"></a>02233                 }
<a name="l02234"></a>02234                 <span class="keywordflow">return</span> <a class="code" href="classtx__srfeuserregister__pi1.html#o44">$templateCode</a>;
<a name="l02235"></a>02235         }
<a name="l02236"></a>02236          
<a name="l02243"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a1">02243</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a1">addCSSStyleMarkers</a>($markerArray) {
<a name="l02244"></a>02244                  
<a name="l02245"></a>02245                 <span class="keywordflow">if</span> ($this-&gt;HTMLMailEnabled ) {
<a name="l02246"></a>02246                         <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a>['###CSS_STYLES###'] = $this-&gt;cObj-&gt;fileResource($this-&gt;conf['email.']['HTMLMailCSS']);
<a name="l02247"></a>02247                 }
<a name="l02248"></a>02248                 <span class="keywordflow">return</span> <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a>;
<a name="l02249"></a>02249         }
<a name="l02250"></a>02250          
<a name="l02257"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a23">02257</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a23">evalFileError</a>($error_code) {
<a name="l02258"></a>02258                 <span class="keywordflow">if</span> ($error_code == <span class="stringliteral">"0"</span>) {
<a name="l02259"></a>02259                         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02260"></a>02260                         <span class="comment">// File upload okay</span>
<a name="l02261"></a>02261                 } elseif ($error_code == <span class="charliteral">'1'</span>) {
<a name="l02262"></a>02262                         <span class="keywordflow">return</span> <span class="keyword">false</span>; <span class="comment">// filesize exceeds upload_max_filesize in php.ini</span>
<a name="l02263"></a>02263                 } elseif ($error_code == <span class="charliteral">'3'</span>) {
<a name="l02264"></a>02264                         <span class="keywordflow">return</span> <span class="keyword">false</span>; <span class="comment">// The file was uploaded partially</span>
<a name="l02265"></a>02265                 } elseif ($error_code == <span class="charliteral">'4'</span>) {
<a name="l02266"></a>02266                         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02267"></a>02267                         <span class="comment">// No file was uploaded</span>
<a name="l02268"></a>02268                 } <span class="keywordflow">else</span> {
<a name="l02269"></a>02269                         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02270"></a>02270                 }
<a name="l02271"></a>02271         }
<a name="l02272"></a>02272          
<a name="l02281"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a2">02281</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a2">addFileUploadMarkers</a>($theField, $markerArray, $dataArr = array()) {
<a name="l02282"></a>02282                 $filenames = array();
<a name="l02283"></a>02283                 <span class="keywordflow">if</span> ($dataArr[$theField]) {
<a name="l02284"></a>02284                         $filenames = explode(<span class="charliteral">','</span>, $dataArr[$theField]);
<a name="l02285"></a>02285                 }
<a name="l02286"></a>02286                 <span class="keywordflow">if</span> ($this-&gt;previewLabel ) {
<a name="l02287"></a>02287                         <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a>['###UPLOAD_PREVIEW_' . $theField . '###'] = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a7">buildFileUploader</a>($theField, $this-&gt;TCA['columns'][$theField]['config'], $filenames, 'FE['.$this-&gt;theTable.<span class="charliteral">']'</span>);
<a name="l02288"></a>02288                 } <span class="keywordflow">else</span> {
<a name="l02289"></a>02289                         <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a>['###UPLOAD_' . $theField . '###'] = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a7">buildFileUploader</a>($theField, $this-&gt;TCA['columns'][$theField]['config'], $filenames, 'FE['.$this-&gt;theTable.<span class="charliteral">']'</span>);
<a name="l02290"></a>02290                 }
<a name="l02291"></a>02291                 <span class="keywordflow">return</span> <a class="code" href="classtx__srfeuserregister__pi1.html#o28">$markerArray</a>;
<a name="l02292"></a>02292         }
<a name="l02293"></a>02293          
<a name="l02305"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a7">02305</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a7">buildFileUploader</a>($fName, $config, $filenames = array(), $prefix) {
<a name="l02306"></a>02306                 $HTMLContent = '';
<a name="l02307"></a>02307                 $size = $config['maxitems'];
<a name="l02308"></a>02308                 $number = $size - <span class="keyword">sizeof</span>($filenames);
<a name="l02309"></a>02309                 $dir = $config['uploadfolder'];
<a name="l02310"></a>02310                  
<a name="l02311"></a>02311                 <span class="keywordflow">if</span> ($this-&gt;previewLabel ) {
<a name="l02312"></a>02312                         <span class="keywordflow">for</span>($i = 0; $i &lt; <span class="keyword">sizeof</span>($filenames); $i++) {
<a name="l02313"></a>02313                                 $HTMLContent .= $filenames[$i] . '&amp;nbsp;&amp;nbsp;&lt;small&gt;&lt;a href=<span class="stringliteral">"' . $dir.'/' . $filenames[$i] . '"</span> target=<span class="stringliteral">"_blank"</span>&gt;' . $this-&gt;pi_getLL('file_view') . '&lt;/a&gt;&lt;/small&gt;&lt;br /&gt;';
<a name="l02314"></a>02314                         }
<a name="l02315"></a>02315                 } <span class="keywordflow">else</span> {
<a name="l02316"></a>02316                         <span class="keywordflow">for</span>($i = 0; $i &lt; <span class="keyword">sizeof</span>($filenames); $i++) {
<a name="l02317"></a>02317                                 $HTMLContent .= $filenames[$i] . '&amp;nbsp;&amp;nbsp;&lt;input type=<span class="stringliteral">"image"</span> src=<span class="stringliteral">"' . $GLOBALS['TSFE']-&gt;tmpl-&gt;getFileName($this-&gt;conf['icon_delete']) . '"</span> name=<span class="stringliteral">"'.$prefix.'['.$fName.']['.$i.'][submit_delete]"</span> value=<span class="stringliteral">"1"</span> title=<span class="stringliteral">"'.$this-&gt;pi_getLL('icon_delete').'"</span> alt=<span class="stringliteral">"'.$this-&gt;pi_getLL('icon_delete').'"</span>'.$this-&gt;pi_classParam('icon').' /&gt;&amp;nbsp;&amp;nbsp;&lt;small&gt;&lt;a href=<span class="stringliteral">"' . $dir.'/' . $filenames[$i] . '"</span> target=<span class="stringliteral">"_blank"</span>&gt;' . $this-&gt;pi_getLL('file_view') . '&lt;/a&gt;&lt;/small&gt;&lt;br /&gt;';
<a name="l02318"></a>02318                                 $HTMLContent .= '&lt;input type=<span class="stringliteral">"hidden"</span> name=<span class="stringliteral">"' . $prefix . '[' . $fName . '][' . $i . '][name]' . '"</span> value=<span class="stringliteral">"' . $filenames[$i] . '"</span> /&gt;';
<a name="l02319"></a>02319                         }
<a name="l02320"></a>02320                         <span class="keywordflow">for</span>($i = <span class="keyword">sizeof</span>($filenames); $i &lt; $number + <span class="keyword">sizeof</span>($filenames); $i++) {
<a name="l02321"></a>02321                                 $HTMLContent .= '&lt;input name=<span class="stringliteral">"'.$prefix.'['.$fName.']['.$i.']'.'"</span> type=<span class="stringliteral">"file"</span> '.$this-&gt;pi_classParam('uploader').' /&gt;&lt;br /&gt;';
<a name="l02322"></a>02322                         }
<a name="l02323"></a>02323                 }
<a name="l02324"></a>02324                  
<a name="l02325"></a>02325                 <span class="keywordflow">return</span> $HTMLContent;
<a name="l02326"></a>02326         }
<a name="l02327"></a>02327          
<a name="l02339"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a27">02339</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a27">get_url</a>($tag = '', $<span class="keywordtype">id</span>, $vars = array(), $unsetVars = array(), $usePiVars = <span class="keyword">true</span>) {
<a name="l02340"></a>02340                  
<a name="l02341"></a>02341                 $vars = (array) $vars;
<a name="l02342"></a>02342                 $unsetVars = (array) $unsetVars;
<a name="l02343"></a>02343                 <span class="keywordflow">if</span> ($usePiVars) {
<a name="l02344"></a>02344                         $vars = array_merge($this-&gt;piVars, $vars); <span class="comment">//vars override pivars</span>
<a name="l02345"></a>02345                         <span class="keywordflow">while</span> (list(, $key) = each($unsetVars)) {
<a name="l02346"></a>02346                                 <span class="comment">// unsetvars override anything</span>
<a name="l02347"></a>02347                                 unset($vars[$key]);
<a name="l02348"></a>02348                         }
<a name="l02349"></a>02349                 }
<a name="l02350"></a>02350                 <span class="keywordflow">while</span> (list($key, $val) = each($vars)) {
<a name="l02351"></a>02351                         $piVars[$this-&gt;prefixId . <span class="charliteral">'['</span>. $key . <span class="charliteral">']'</span>] = $val;
<a name="l02352"></a>02352                 }
<a name="l02353"></a>02353 
<a name="l02354"></a>02354                 <span class="comment">// MLC update to use typolink</span>
<a name="l02355"></a>02355                 $piVars[ 'parameter' ]  = $id;
<a name="l02356"></a>02356 
<a name="l02357"></a>02357                 <span class="comment">// if news item, use it</span>
<a name="l02358"></a>02358                 $newsVar                                = 'tx_ttnews';
<a name="l02359"></a>02359                 $newsArray                              = t3lib_div::_GP( $newsVar );
<a name="l02360"></a>02360 
<a name="l02361"></a>02361                 <span class="keywordflow">if</span> ( $newsArray )
<a name="l02362"></a>02362                 {
<a name="l02363"></a>02363                         $piVars[ 'additionalParams' ]   = <span class="stringliteral">"&amp;tx_ttnews[tt_news]={$newsArray[ 'tt_news' ]}"</span>;
<a name="l02364"></a>02364                         $piVars[ 'useCacheHash' ]       = 1;
<a name="l02365"></a>02365                 }
<a name="l02366"></a>02366 
<a name="l02367"></a>02367                 <span class="keywordflow">if</span> ($tag) {
<a name="l02368"></a>02368                         <span class="keywordflow">return</span> $this-&gt;site_url . $this-&gt;cObj-&gt;typolink( $tag, $piVars );
<a name="l02369"></a>02369                 } <span class="keywordflow">else</span> {
<a name="l02370"></a>02370                         $piVars[ 'returnLast' ] = 'url';
<a name="l02371"></a>02371                         <span class="keywordflow">return</span> $this-&gt;site_url . $this-&gt;cObj-&gt;typolink( $tag, $piVars );
<a name="l02372"></a>02372                 }
<a name="l02373"></a>02373         }
<a name="l02374"></a>02374 
<a name="l02375"></a>02375         <span class="comment">/* evalDate($value)</span>
<a name="l02376"></a>02376 <span class="comment">         *</span>
<a name="l02377"></a>02377 <span class="comment">         *  Check if the value is a correct date in format yyyy-mm-dd</span>
<a name="l02378"></a>02378 <span class="comment">        */</span>
<a name="l02379"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a21">02379</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a21">evalDate</a>($value) {
<a name="l02380"></a>02380                 <span class="keywordflow">if</span>( !$value) {  
<a name="l02381"></a>02381                         <span class="keywordflow">return</span> <span class="keyword">false</span>; 
<a name="l02382"></a>02382                 }
<a name="l02383"></a>02383                 $checkValue = trim($value);
<a name="l02384"></a>02384                 <span class="keywordflow">if</span>( strlen($checkValue) == 8 ) {
<a name="l02385"></a>02385                         $checkValue = substr($checkValue,0,4).<span class="charliteral">'-'</span>.substr($checkValue,4,2).<span class="charliteral">'-'</span>.substr($checkValue,6,2) ;
<a name="l02386"></a>02386 
<a name="l02387"></a>02387 
<a name="l02388"></a>02388                 }
<a name="l02389"></a>02389                 list($year,$month,$day) = split(<span class="charliteral">'-'</span>, $checkValue, 3);
<a name="l02390"></a>02390                 <span class="keywordflow">if</span>(is_numeric($year) &amp;&amp; is_numeric($month) &amp;&amp; is_numeric($day)) {
<a name="l02391"></a>02391                         <span class="keywordflow">return</span> checkdate($month, $day, $year);
<a name="l02392"></a>02392                 } <span class="keywordflow">else</span> {
<a name="l02393"></a>02393                         <span class="keywordflow">return</span> <span class="keyword">false</span>; 
<a name="l02394"></a>02394                 }
<a name="l02395"></a>02395         }
<a name="l02396"></a>02396 
<a name="l02405"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a24">02405</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a24">evalMonth</a>( $value )
<a name="l02406"></a>02406         {
<a name="l02407"></a>02407                 <span class="keywordflow">if</span>( !$value )
<a name="l02408"></a>02408                 {  
<a name="l02409"></a>02409                         <span class="keywordflow">return</span> <span class="keyword">false</span>; 
<a name="l02410"></a>02410                 }
<a name="l02411"></a>02411 
<a name="l02412"></a>02412                 $value                          = trim( $value );
<a name="l02413"></a>02413 
<a name="l02414"></a>02414                 <span class="keywordflow">if</span>( is_numeric( $value ) )
<a name="l02415"></a>02415                 {
<a name="l02416"></a>02416                         <span class="keywordflow">return</span> checkdate( $value, 1, 2004 );
<a name="l02417"></a>02417                 }
<a name="l02418"></a>02418                 
<a name="l02419"></a>02419                 <span class="keywordflow">else</span>
<a name="l02420"></a>02420                 {
<a name="l02421"></a>02421                         <span class="keywordflow">return</span> <span class="keyword">false</span>; 
<a name="l02422"></a>02422                 }
<a name="l02423"></a>02423         }
<a name="l02424"></a>02424 
<a name="l02433"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a26">02433</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a26">evalYear</a>( $value )
<a name="l02434"></a>02434         {
<a name="l02435"></a>02435                 <span class="keywordflow">if</span>( !$value )
<a name="l02436"></a>02436                 {  
<a name="l02437"></a>02437                         <span class="keywordflow">return</span> <span class="keyword">false</span>; 
<a name="l02438"></a>02438                 }
<a name="l02439"></a>02439 
<a name="l02440"></a>02440                 $value                          = trim( $value );
<a name="l02441"></a>02441 
<a name="l02442"></a>02442                 <span class="keywordflow">if</span>( is_numeric( $value ) )
<a name="l02443"></a>02443                 {
<a name="l02444"></a>02444                         <span class="keywordflow">return</span> checkdate( 1, 1, $value );
<a name="l02445"></a>02445                 }
<a name="l02446"></a>02446                 
<a name="l02447"></a>02447                 <span class="keywordflow">else</span>
<a name="l02448"></a>02448                 {
<a name="l02449"></a>02449                         <span class="keywordflow">return</span> <span class="keyword">false</span>; 
<a name="l02450"></a>02450                 }
<a name="l02451"></a>02451         }
<a name="l02452"></a>02452 
<a name="l02461"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a22">02461</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a22">evalExpiry</a>( $value )
<a name="l02462"></a>02462         {
<a name="l02463"></a>02463                 <span class="keywordflow">if</span>( !$value )
<a name="l02464"></a>02464                 {  
<a name="l02465"></a>02465                         <span class="keywordflow">return</span> <span class="keyword">false</span>; 
<a name="l02466"></a>02466                 }
<a name="l02467"></a>02467 
<a name="l02468"></a>02468                 $value                          = trim( $value );
<a name="l02469"></a>02469                 $value                          = explode( <span class="charliteral">'/'</span>, $value );
<a name="l02470"></a>02470                 $month                          = isset( $value[ 0 ] )
<a name="l02471"></a>02471                                                                 ? $value[ 0 ]
<a name="l02472"></a>02472                                                                 : <span class="keyword">false</span>;
<a name="l02473"></a>02473                 $year                           = isset( $value[ 1 ] )
<a name="l02474"></a>02474                                                                 ? $value[ 1 ]
<a name="l02475"></a>02475                                                                 : <span class="keyword">false</span>;
<a name="l02476"></a>02476 
<a name="l02477"></a>02477                 <span class="keywordflow">if</span>( is_numeric( $month ) &amp;&amp; is_numeric( $year) )
<a name="l02478"></a>02478                 {
<a name="l02479"></a>02479                         <span class="keywordflow">return</span> checkdate( $month, 1, $year );
<a name="l02480"></a>02480                 }
<a name="l02481"></a>02481                 
<a name="l02482"></a>02482                 <span class="keywordflow">else</span>
<a name="l02483"></a>02483                 {
<a name="l02484"></a>02484                         <span class="keywordflow">return</span> <span class="keyword">false</span>; 
<a name="l02485"></a>02485                 }
<a name="l02486"></a>02486         }
<a name="l02487"></a>02487 
<a name="l02496"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a20">02496</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a20">evalCreditcard</a>( $value )
<a name="l02497"></a>02497         {
<a name="l02498"></a>02498                 <span class="keywordflow">if</span>( !$value )
<a name="l02499"></a>02499                 {  
<a name="l02500"></a>02500                         <span class="keywordflow">return</span> <span class="keyword">false</span>; 
<a name="l02501"></a>02501                 }
<a name="l02502"></a>02502 
<a name="l02503"></a>02503                 $checkValue                     = trim( $value );
<a name="l02504"></a>02504                 $cc                                     = <span class="keyword">new</span> Cb_Validate_Credit_Card();
<a name="l02505"></a>02505 
<a name="l02506"></a>02506                 $ccTypes                        = explode( <span class="charliteral">','</span>
<a name="l02507"></a>02507                                                                 , $this-&gt;conf[ 'ccAllowedTypes' ]
<a name="l02508"></a>02508                                                         );
<a name="l02509"></a>02509                 $ccAllowedTypes         = array();
<a name="l02510"></a>02510 
<a name="l02511"></a>02511                 foreach ( $ccTypes as $key =&gt; $constant )
<a name="l02512"></a>02512                 {
<a name="l02513"></a>02513                         $ccAllowedTypes[]       = constant( $constant );
<a name="l02514"></a>02514                 }
<a name="l02515"></a>02515 
<a name="l02516"></a>02516                 $expiry                         = explode( <span class="charliteral">'/'</span>, $this-&gt;dataArr[ 'cc_expiry' ] );
<a name="l02517"></a>02517                 $result                         = $cc-&gt;is_valid_card( $value
<a name="l02518"></a>02518                                                                 , $expiry[ 0 ]
<a name="l02519"></a>02519                                                                 , $expiry[ 1 ]
<a name="l02520"></a>02520                                                                 , $ccAllowedTypes
<a name="l02521"></a>02521                                                         );
<a name="l02522"></a>02522                 $this-&gt;ccErrorText      = $cc-&gt;get_error_text( $result );
<a name="l02523"></a>02523 
<a name="l02524"></a>02524                 <span class="keywordflow">if</span>( ! $result )
<a name="l02525"></a>02525                 {
<a name="l02526"></a>02526                         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02527"></a>02527                 }
<a name="l02528"></a>02528                 
<a name="l02529"></a>02529                 <span class="keywordflow">else</span>
<a name="l02530"></a>02530                 {
<a name="l02531"></a>02531                         <span class="keywordflow">return</span> <span class="keyword">false</span>; 
<a name="l02532"></a>02532                 }
<a name="l02533"></a>02533         }
<a name="l02534"></a>02534 
<a name="l02546"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a8">02546</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a8">cbIsAba</a>($routing)
<a name="l02547"></a>02547         {
<a name="l02548"></a>02548                 <span class="comment">// run through each digit and calculate the total.</span>
<a name="l02549"></a>02549                 $n                                                      = 0;
<a name="l02550"></a>02550 
<a name="l02551"></a>02551                 $routingLength                          = strlen($routing);
<a name="l02552"></a>02552 
<a name="l02553"></a>02553                 <span class="comment">// ABA routing numbers are always 9 digits long</span>
<a name="l02554"></a>02554                 <span class="keywordflow">if</span> ( preg_match('/[^0-9]/', $routing) || 9 != $routingLength )
<a name="l02555"></a>02555                 {
<a name="l02556"></a>02556                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02557"></a>02557                 }
<a name="l02558"></a>02558 
<a name="l02559"></a>02559                 <span class="comment">// multiply the first digit by 3, the second by 7, the third by 1, the</span>
<a name="l02560"></a>02560                 <span class="comment">// fourth by 3, the fifth by 7, the sixth by 1, etc., and add them all up.</span>
<a name="l02561"></a>02561 
<a name="l02562"></a>02562                 <span class="keywordflow">for</span> ( $i = 0; $i &lt; $routingLength; $i += 3 ) 
<a name="l02563"></a>02563                 {
<a name="l02564"></a>02564                         $n                                              += $routing[$i] * 3;
<a name="l02565"></a>02565                         $n                                              += $routing[$i + 1] * 7;
<a name="l02566"></a>02566                         $n                                              += $routing[$i + 2];
<a name="l02567"></a>02567                 }
<a name="l02568"></a>02568 
<a name="l02569"></a>02569                 <span class="comment">// If this sum is an integer multiple of 10 (e.g., 10, 20, 30, 40, 50,...)</span>
<a name="l02570"></a>02570                 <span class="comment">// then the number is valid, as far as the checksum is concerned.</span>
<a name="l02571"></a>02571                 <span class="comment">// (but not zero),</span>
<a name="l02572"></a>02572                 <span class="keywordflow">if</span> ( 0 != $n &amp;&amp; 0 == ( $n % 10 ) )
<a name="l02573"></a>02573                 {
<a name="l02574"></a>02574                         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02575"></a>02575                 }
<a name="l02576"></a>02576 
<a name="l02577"></a>02577                 <span class="keywordflow">else</span>
<a name="l02578"></a>02578                 {
<a name="l02579"></a>02579                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02580"></a>02580                 }
<a name="l02581"></a>02581         }
<a name="l02582"></a>02582 
<a name="l02588"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a40">02588</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a40">parseIncomingTimestamps</a>($origArr = array()) {
<a name="l02589"></a>02589 
<a name="l02590"></a>02590                 $parsedArr = array();
<a name="l02591"></a>02591                 $parsedArr = $origArr;
<a name="l02592"></a>02592                 <span class="keywordflow">if</span> (is_array($this-&gt;conf['parseFromDBValues.'])) {
<a name="l02593"></a>02593                         reset($this-&gt;conf['parseFromDBValues.']);
<a name="l02594"></a>02594                         <span class="keywordflow">while</span> (list($theField, $theValue) = each($this-&gt;conf['parseFromDBValues.'])) {
<a name="l02595"></a>02595                                 $listOfCommands = t3lib_div::trimExplode(<span class="charliteral">','</span>, $theValue, 1);
<a name="l02596"></a>02596                                 <span class="keywordflow">while</span> (list(, $cmd) = each($listOfCommands)) {
<a name="l02597"></a>02597                                         $cmdParts = split(<span class="stringliteral">"\[|\]"</span>, $cmd); <span class="comment">// Point is to enable parameters after each command enclosed in brackets [..]. These will be in position 1 in the array.</span>
<a name="l02598"></a>02598                                         $theCmd = trim($cmdParts[0]);
<a name="l02599"></a>02599                                         <span class="keywordflow">switch</span>($theCmd) {
<a name="l02600"></a>02600                                                 <span class="keywordflow">case</span> 'date':
<a name="l02601"></a>02601                                                 <span class="keywordflow">if</span>($origArr[$theField]) {
<a name="l02602"></a>02602                                                         $parsedArr[$theField] = date( 'Y-m-d', $origArr[$theField]);
<a name="l02603"></a>02603                                                 }
<a name="l02604"></a>02604                                                 <span class="keywordflow">if</span> (!$parsedArr[$theField]) {
<a name="l02605"></a>02605                                                         unset($parsedArr[$theField]);
<a name="l02606"></a>02606                                                 }
<a name="l02607"></a>02607                                                 <span class="keywordflow">break</span>;
<a name="l02608"></a>02608                                                 <span class="keywordflow">case</span> 'adodb_date':
<a name="l02609"></a>02609                                                 <span class="keywordflow">if</span>($origArr[$theField]) {
<a name="l02610"></a>02610                                                         $parsedArr[$theField] = $this-&gt;adodbTime-&gt;adodb_date( 'Y-m-d', $origArr[$theField]);
<a name="l02611"></a>02611                                                 }
<a name="l02612"></a>02612                                                 <span class="keywordflow">if</span> (!$parsedArr[$theField]) {
<a name="l02613"></a>02613                                                         unset($parsedArr[$theField]);
<a name="l02614"></a>02614                                                 }
<a name="l02615"></a>02615                                                 <span class="keywordflow">break</span>;
<a name="l02616"></a>02616                                         }
<a name="l02617"></a>02617 
<a name="l02618"></a>02618                                 }
<a name="l02619"></a>02619                         }
<a name="l02620"></a>02620                 }
<a name="l02621"></a>02621                 <span class="keywordflow">return</span> $parsedArr;
<a name="l02622"></a>02622         }
<a name="l02623"></a>02623 
<a name="l02630"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a38">02630</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a38">noArrayArray</a>( &amp; $array )
<a name="l02631"></a>02631         {
<a name="l02632"></a>02632                 foreach ( $array as $key =&gt; $value )
<a name="l02633"></a>02633                 {
<a name="l02634"></a>02634                         <span class="keywordflow">if</span> ( is_array( $value ) )
<a name="l02635"></a>02635                         {
<a name="l02636"></a>02636                                 $array[ $key ]  = implode( '; ', $value );
<a name="l02637"></a>02637                         }
<a name="l02638"></a>02638                 }
<a name="l02639"></a>02639         }
<a name="l02640"></a>02640 
<a name="l02646"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a41">02646</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a41">parseOutgoingDates</a>($origArr = array()) {
<a name="l02647"></a>02647 
<a name="l02648"></a>02648                 $parsedArr = array();
<a name="l02649"></a>02649                 $parsedArr = $origArr;
<a name="l02650"></a>02650                 <span class="keywordflow">if</span> (is_array($this-&gt;conf['parseToDBValues.'])) {
<a name="l02651"></a>02651                         reset($this-&gt;conf['parseToDBValues.']);
<a name="l02652"></a>02652                         <span class="keywordflow">while</span> (list($theField, $theValue) = each($this-&gt;conf['parseToDBValues.'])) {
<a name="l02653"></a>02653                                 $listOfCommands = t3lib_div::trimExplode(<span class="charliteral">','</span>, $theValue, 1);
<a name="l02654"></a>02654 
<a name="l02655"></a>02655                                 <span class="keywordflow">while</span> (list(, $cmd) = each($listOfCommands)) {
<a name="l02656"></a>02656                                         $cmdParts = split(<span class="stringliteral">"\[|\]"</span>, $cmd); <span class="comment">// Point is to enable parameters after each command enclosed in brackets [..]. These will be in position 1 in the array.</span>
<a name="l02657"></a>02657                                         $theCmd = trim($cmdParts[0]);
<a name="l02658"></a>02658                                         <span class="keywordflow">switch</span>($theCmd) {
<a name="l02659"></a>02659                                                 <span class="keywordflow">case</span> 'date':
<a name="l02660"></a>02660                                                 <span class="keywordflow">if</span>($origArr[$theField]) {
<a name="l02661"></a>02661                                                         <span class="keywordflow">if</span>(strlen($origArr[$theField]) == 8) { 
<a name="l02662"></a>02662                                                                 $parsedArr[$theField] = substr($origArr[$theField],0,4).<span class="charliteral">'-'</span>.substr($origArr[$theField],4,2).<span class="charliteral">'-'</span>.substr($origArr[$theField],6,2);
<a name="l02663"></a>02663                                                         } <span class="keywordflow">else</span> {
<a name="l02664"></a>02664                                                                 $parsedArr[$theField] = $origArr[$theField];
<a name="l02665"></a>02665                                                         }
<a name="l02666"></a>02666                                                         list($year,$month,$day) = split(<span class="charliteral">'-'</span>, $parsedArr[$theField], 3);
<a name="l02667"></a>02667                                                         $parsedArr[$theField] = mktime(0,0,0,$month,$day,$year);
<a name="l02668"></a>02668                                                 }
<a name="l02669"></a>02669                                                 <span class="keywordflow">break</span>;
<a name="l02670"></a>02670                                                 <span class="keywordflow">case</span> 'adodb_date':
<a name="l02671"></a>02671                                                 <span class="keywordflow">if</span>($origArr[$theField]) {
<a name="l02672"></a>02672                                                         <span class="keywordflow">if</span>(strlen($origArr[$theField]) == 8) { 
<a name="l02673"></a>02673                                                                 $parsedArr[$theField] = substr($origArr[$theField],0,4).<span class="charliteral">'-'</span>.substr($origArr[$theField],4,2).<span class="charliteral">'-'</span>.substr($origArr[$theField],6,2);
<a name="l02674"></a>02674                                                         } <span class="keywordflow">else</span> {
<a name="l02675"></a>02675                                                                 $parsedArr[$theField] = $origArr[$theField];
<a name="l02676"></a>02676                                                         }
<a name="l02677"></a>02677                                                         list($year,$month,$day) = split(<span class="charliteral">'-'</span>, $parsedArr[$theField], 3);
<a name="l02678"></a>02678                                                         $parsedArr[$theField] = $this-&gt;adodbTime-&gt;adodb_mktime(0,0,0,$month,$day,$year);
<a name="l02679"></a>02679                                                 }
<a name="l02680"></a>02680                                                 <span class="keywordflow">break</span>;
<a name="l02681"></a>02681                                         }
<a name="l02682"></a>02682                                 }
<a name="l02683"></a>02683                         }
<a name="l02684"></a>02684                 }
<a name="l02685"></a>02685                 <span class="keywordflow">return</span> $parsedArr;
<a name="l02686"></a>02686         }
<a name="l02687"></a>02687 
<a name="l02703"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a31">02703</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a31">getUpdateJS</a>($dataArray, $formName, $arrPrefix, $fieldList) {
<a name="l02704"></a>02704                 $JSPart = '';
<a name="l02705"></a>02705                 $updateValues = t3lib_div::trimExplode(<span class="charliteral">','</span>, $fieldList);
<a name="l02706"></a>02706                 $mbstring_is_available = in_array('mbstring', get_loaded_extensions());
<a name="l02707"></a>02707                 <span class="keywordflow">while</span> (list(, $fKey) = each($updateValues)) {
<a name="l02708"></a>02708                         $value = $dataArray[$fKey];
<a name="l02709"></a>02709                         <span class="keywordflow">if</span> (is_array($value)) {
<a name="l02710"></a>02710 
<a name="l02711"></a>02711                                 reset($value);
<a name="l02712"></a>02712                                 <span class="keywordflow">while</span> (list(, $Nvalue) = each($value)) {
<a name="l02713"></a>02713                                         <span class="keywordflow">if</span> ($this-&gt;typoVersion &gt;= 3006000 ) {
<a name="l02714"></a>02714                                                 $convValue = $GLOBALS['TSFE']-&gt;csConvObj-&gt;conv($Nvalue, $this-&gt;charset, 'utf-8');
<a name="l02715"></a>02715                                         } elseif ($mbstring_is_available) {
<a name="l02716"></a>02716                                                 $convValue = mb_convert_encoding ( $Nvalue, 'utf-8', $this-&gt;charset);
<a name="l02717"></a>02717                                         } elseif ($this-&gt;charset == 'iso-8859-1') {
<a name="l02718"></a>02718                                                 $convValue = utf8_encode($Nvalue);
<a name="l02719"></a>02719                                         } <span class="keywordflow">else</span> {
<a name="l02720"></a>02720                                                 $convValue = $Nvalue;   <span class="comment">// giving up!</span>
<a name="l02721"></a>02721                                         }
<a name="l02722"></a>02722                                         $JSPart .= <span class="stringliteral">"</span>
<a name="l02723"></a>02723 <span class="stringliteral">                                                if (window.decodeURIComponent) { unesc = decodeURIComponent('"</span>.rawurlencode($convValue).<span class="stringliteral">"') } else { unesc = unescape('"</span>.rawurlencode($Nvalue).<span class="stringliteral">"') };</span>
<a name="l02724"></a>02724 <span class="stringliteral">                                                updateForm('"</span>.$formName.<span class="stringliteral">"','"</span>.$arrPrefix.<span class="stringliteral">"["</span>.$fKey.<span class="stringliteral">"][]',unesc);"</span>;
<a name="l02725"></a>02725                                 }
<a name="l02726"></a>02726                                  
<a name="l02727"></a>02727                         } <span class="keywordflow">else</span> {
<a name="l02728"></a>02728                                 <span class="keywordflow">if</span> ($this-&gt;typoVersion &gt;= 3006000 ) {
<a name="l02729"></a>02729                                         $convValue = $GLOBALS['TSFE']-&gt;csConvObj-&gt;conv($value, $this-&gt;charset, 'utf-8');
<a name="l02730"></a>02730                                 } elseif ($mbstring_is_available) {
<a name="l02731"></a>02731                                         $convValue = mb_convert_encoding ( $value, 'utf-8', $this-&gt;charset);
<a name="l02732"></a>02732                                 } elseif ($this-&gt;charset == 'iso-8859-1') {
<a name="l02733"></a>02733                                         $convValue = utf8_encode($value);
<a name="l02734"></a>02734                                 } <span class="keywordflow">else</span> {
<a name="l02735"></a>02735                                         $convValue = $value;  <span class="comment">// giving up!</span>
<a name="l02736"></a>02736                                 }
<a name="l02737"></a>02737                                 $JSPart .= <span class="stringliteral">"</span>
<a name="l02738"></a>02738 <span class="stringliteral">                                        if (window.decodeURIComponent) { unesc = decodeURIComponent('"</span>.rawurlencode($convValue).<span class="stringliteral">"') } else { unesc = unescape('"</span>.rawurlencode($value).<span class="stringliteral">"') };</span>
<a name="l02739"></a>02739 <span class="stringliteral">                                        updateForm('"</span>.$formName.<span class="stringliteral">"','"</span>.$arrPrefix.<span class="stringliteral">"["</span>.$fKey.<span class="stringliteral">"]',unesc);"</span>;
<a name="l02740"></a>02740                         }
<a name="l02741"></a>02741                 }
<a name="l02742"></a>02742                 $JSPart = '&lt;script type=<span class="stringliteral">"text/javascript"</span>&gt;
<a name="l02743"></a>02743                         <span class="comment">/*&lt;![CDATA[*/</span> '.$JSPart.'
<a name="l02744"></a>02744                         <span class="comment">/*]]&gt;*/</span>
<a name="l02745"></a>02745                         &lt;/script&gt;
<a name="l02746"></a>02746                         ';
<a name="l02747"></a>02747                 $GLOBALS['TSFE']-&gt;additionalHeaderData['JSincludeFormupdate'] = '&lt;script type=<span class="stringliteral">"text/javascript"</span> src=<span class="stringliteral">"'.$GLOBALS['TSFE']-&gt;absRefPrefix.'t3lib/jsfunc.updateform.js"</span>&gt;&lt;/script&gt;';
<a name="l02748"></a>02748                 <span class="keywordflow">return</span> $JSPart;
<a name="l02749"></a>02749         }
<a name="l02750"></a>02750                                         
<a name="l02759"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a11">02759</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a11">createTempuser</a>()
<a name="l02760"></a>02760         {
<a name="l02761"></a>02761                 <span class="comment">// check dataArr for current username, password, password_again</span>
<a name="l02762"></a>02762                 <span class="keywordflow">if</span> ( ! trim( $this-&gt;dataArr[ 'username' ] ) )
<a name="l02763"></a>02763                 {
<a name="l02764"></a>02764                         <span class="comment">// microsecond difference</span>
<a name="l02765"></a>02765                         $tempuser                       = uniqid( 'visitor_' );
<a name="l02766"></a>02766                         $temppass                       = uniqid( '' );
<a name="l02767"></a>02767 
<a name="l02768"></a>02768                         $this-&gt;dataArr[ 'username' ]            =  $tempuser;
<a name="l02769"></a>02769 
<a name="l02770"></a>02770                         <span class="comment">// create password from unique id, 6 char</span>
<a name="l02771"></a>02771                         <span class="comment">// create unique username from email</span>
<a name="l02772"></a>02772                         $this-&gt;dataArr[ 'password' ]            = $temppass;
<a name="l02773"></a>02773                         $this-&gt;dataArr[ 'password_again' ]      = $temppass;
<a name="l02774"></a>02774                 }
<a name="l02775"></a>02775 
<a name="l02776"></a>02776                 <span class="keywordflow">if</span> ( ! trim( $this-&gt;dataArr[ 'endtime' ] ) )
<a name="l02777"></a>02777                 {
<a name="l02778"></a>02778                         <span class="comment">// set endtime about x days later per</span>
<a name="l02779"></a>02779                         <span class="comment">// $this-&gt;conf[ 'tempuserTimelimit' ]</span>
<a name="l02780"></a>02780                         $now                            = time();
<a name="l02781"></a>02781                         $later                          = $now
<a name="l02782"></a>02782                                                                         + ( $this-&gt;conf[ 'tempuserTimelimit' ]
<a name="l02783"></a>02783                                                                                 * 24 * 60 * 60 
<a name="l02784"></a>02784                                                                         );
<a name="l02785"></a>02785 
<a name="l02786"></a>02786                         $this-&gt;dataArr[ 'endtime' ]     = $later;
<a name="l02787"></a>02787                 }
<a name="l02788"></a>02788         }
<a name="l02789"></a>02789 
<a name="l02798"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a46">02798</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a46">removeCreditcard</a>( $dataArr )
<a name="l02799"></a>02799         {
<a name="l02800"></a>02800                 <span class="comment">// Don't store credit card information as it's not encrypted or the like</span>
<a name="l02801"></a>02801                 $update                         = <span class="stringliteral">"</span>
<a name="l02802"></a>02802 <span class="stringliteral">                        UPDATE fe_users</span>
<a name="l02803"></a>02803 <span class="stringliteral">                        SET cc_number = ''</span>
<a name="l02804"></a>02804 <span class="stringliteral">                                , cc_type = ''</span>
<a name="l02805"></a>02805 <span class="stringliteral">                                , cc_name = ''</span>
<a name="l02806"></a>02806 <span class="stringliteral">                                , cc_expiry = ''</span>
<a name="l02807"></a>02807 <span class="stringliteral">                        WHERE uid = {$this-&gt;dataArr[ 'uid' ]}</span>
<a name="l02808"></a>02808 <span class="stringliteral">                "</span>;
<a name="l02809"></a>02809 
<a name="l02810"></a>02810                 $GLOBALS[ 'TYPO3_DB' ]-&gt;sql(TYPO3_db, $update);
<a name="l02811"></a>02811                 echo $GLOBALS[ 'TYPO3_DB' ]-&gt;sql_error();
<a name="l02812"></a>02812         }
<a name="l02813"></a>02813 
<a name="l02819"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a57">02819</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a57">setStartEndTime</a>()
<a name="l02820"></a>02820         {
<a name="l02821"></a>02821                 <span class="comment">// bail if note create/edit cmd</span>
<a name="l02822"></a>02822                 <span class="keywordflow">if</span> ( 'create' != $this-&gt;cmd &amp;&amp; 'edit' != $this-&gt;cmd )
<a name="l02823"></a>02823                 {
<a name="l02824"></a>02824                         <span class="keywordflow">return</span>;
<a name="l02825"></a>02825                 }
<a name="l02826"></a>02826 
<a name="l02827"></a>02827                 <span class="comment">// set default start and end time</span>
<a name="l02828"></a>02828                 $now                                            = time();
<a name="l02829"></a>02829 
<a name="l02830"></a>02830                 <span class="keywordflow">if</span> ( ! trim( $this-&gt;dataArr[ 'starttime' ] ) )
<a name="l02831"></a>02831                 {
<a name="l02832"></a>02832                         $this-&gt;dataArr[ 'starttime' ]   = $now;
<a name="l02833"></a>02833                 }
<a name="l02834"></a>02834 
<a name="l02835"></a>02835                 $start                                          = ( 'create' == $this-&gt;cmd )
<a name="l02836"></a>02836                                                                                 ? $now
<a name="l02837"></a>02837                                                                                 : $this-&gt;dataArr[ 'starttime' ];
<a name="l02838"></a>02838                 $end                                            = ( $this-&gt;dataArr[ 'endtime' ] )
<a name="l02839"></a>02839                                                                                 ? $this-&gt;dataArr[ 'endtime' ]
<a name="l02840"></a>02840                                                                                 : 0;
<a name="l02841"></a>02841         
<a name="l02842"></a>02842                                                                                 
<a name="l02843"></a>02843                 <span class="comment">// set a flag for complimentary professional group.</span>
<a name="l02844"></a>02844                 $complimentaryProfessionalGroupID = 4; <span class="comment">//from the fe_groups table.</span>
<a name="l02845"></a>02845                 $isComplimentaryProfessionalUserGroup = $this-&gt;dataArr['usergroup'] 
<a name="l02846"></a>02846                                                                         == $complimentaryProfessionalGroupID; 
<a name="l02847"></a>02847                 <span class="comment">// states</span>
<a name="l02848"></a>02848                 <span class="comment">// prof below includes complimentary professional group - js </span>
<a name="l02849"></a>02849                         <span class="comment">// create no - new start, no end</span>
<a name="l02850"></a>02850                         <span class="comment">// create prof - new start, new end</span>
<a name="l02851"></a>02851                         <span class="comment">// edit no - keep start, no end</span>
<a name="l02852"></a>02852                         <span class="comment">// edit prof - new start, extend end</span>
<a name="l02853"></a>02853                 <span class="comment">// check that there's a payment_method</span>
<a name="l02854"></a>02854                 <span class="keywordflow">if</span> (( preg_match( '#\b' .$this-&gt;conf[ 'paidUsergroup' ] . '\b#'
<a name="l02855"></a>02855                                 , $this-&gt;dataArr[ 'usergroup' ] )
<a name="l02856"></a>02856                         &amp;&amp; '' != $this-&gt;dataArr[ 'payment_method' ]
<a name="l02857"></a>02857                 ) || $isComplimentaryProfessionalUserGroup )
<a name="l02858"></a>02858                 {
<a name="l02859"></a>02859                         $year                                   = ( 365 * 24 * 60 * 60 );
<a name="l02860"></a>02860                         $end                                    = $now + $year;
<a name="l02861"></a>02861                         $start                                  = $now;
<a name="l02862"></a>02862                 }
<a name="l02863"></a>02863 
<a name="l02864"></a>02864                 $this-&gt;dataArr[ 'starttime' ]   = $start;
<a name="l02865"></a>02865                 $this-&gt;dataArr[ 'endtime' ]             = $end;
<a name="l02866"></a>02866         }
<a name="l02867"></a>02867 
<a name="l02875"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a12">02875</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a12">dataArrTranslate</a>( $origArr, $decode = <span class="keyword">true</span> )
<a name="l02876"></a>02876         {
<a name="l02877"></a>02877                 <a class="code" href="classtx__srfeuserregister__pi1.html#o13">$dataArr</a>                                = $origArr[ 0 ];
<a name="l02878"></a>02878 
<a name="l02879"></a>02879                 $yesNoArray                             = array(
<a name="l02880"></a>02880                                                                         <span class="charliteral">'0'</span>             =&gt; 'No'
<a name="l02881"></a>02881                                                                         , <span class="charliteral">'1'</span>   =&gt; 'Yes'
<a name="l02882"></a>02882                                                                 );
<a name="l02883"></a>02883 
<a name="l02884"></a>02884                 <span class="comment">// create assoc array of items to translate</span>
<a name="l02885"></a>02885                 $translator                             = array(
<a name="l02886"></a>02886                         'usergroup'                             =&gt; array(
<a name="l02887"></a>02887                                 <span class="charliteral">'1'</span>                                             =&gt; 'Member'
<a name="l02888"></a>02888                                 , <span class="charliteral">'2'</span>                                   =&gt; 'Professional Member'
<a name="l02889"></a>02889                                 , <span class="charliteral">'4'</span>                                   =&gt; 'Complimentary'
<a name="l02890"></a>02890                                 , <span class="charliteral">'5'</span>                                   =&gt; 'Visitor, White Paper'
<a name="l02891"></a>02891                                 , <span class="charliteral">'6'</span>                                   =&gt; 'Visitor, Round Table'
<a name="l02892"></a>02892                                 , <span class="charliteral">'7'</span>                                   =&gt; 'Visitor, Presentation'
<a name="l02893"></a>02893                                 , <span class="charliteral">'8'</span>                                   =&gt; 'Editor Preview'
<a name="l02894"></a>02894                                 , <span class="charliteral">'9'</span>                                   =&gt; 'BPM - Chicago 2005'
<a name="l02895"></a>02895                                 , '10'                                  =&gt; 'BPM - San Francisco 2005'
<a name="l02896"></a>02896                                 , '11'                                  =&gt; 'BPM - Washington 2005'
<a name="l02897"></a>02897                         )
<a name="l02898"></a>02898                         , 'payment_method'              =&gt; array(
<a name="l02899"></a>02899                                 'credit_card'                   =&gt; 'Credit card'
<a name="l02900"></a>02900                                 , 'phone'                               =&gt; 'Please call'
<a name="l02901"></a>02901                         )
<a name="l02902"></a>02902                         , 'module_sys_dmail_html'       =&gt; $yesNoArray
<a name="l02903"></a>02903                         , 'tx_bpmprofile_newsletter1'   =&gt; $yesNoArray
<a name="l02904"></a>02904                         , 'tx_bpmprofile_newsletter2'   =&gt; $yesNoArray
<a name="l02905"></a>02905                         , 'tx_bpmprofile_newsletter3'   =&gt; $yesNoArray
<a name="l02906"></a>02906                         , 'tx_bpmprofile_newsletter4'   =&gt; $yesNoArray
<a name="l02907"></a>02907                         , 'tx_bpmprofile_newsletter5'   =&gt; $yesNoArray
<a name="l02908"></a>02908                         , 'tx_bpmprofile_newsletter6'   =&gt; $yesNoArray
<a name="l02909"></a>02909                         , 'paid'                                =&gt; $yesNoArray
<a name="l02910"></a>02910                         , 'processed'                   =&gt; $yesNoArray
<a name="l02911"></a>02911                 );
<a name="l02912"></a>02912 
<a name="l02913"></a>02913                 $translatorKeys                 = array_values( array_keys( $translator ) );
<a name="l02914"></a>02914 
<a name="l02915"></a>02915                 <span class="comment">// decode</span>
<a name="l02916"></a>02916                 <span class="comment">// key to value</span>
<a name="l02917"></a>02917                 <span class="comment">// a [ 1 ] =&gt; yes</span>
<a name="l02918"></a>02918 
<a name="l02919"></a>02919                 <span class="comment">// encode</span>
<a name="l02920"></a>02920                 <span class="comment">// value to key</span>
<a name="l02921"></a>02921                 <span class="comment">// a [ yes ] =&gt; 1</span>
<a name="l02922"></a>02922 
<a name="l02923"></a>02923                 foreach ( $translatorKeys as $key )
<a name="l02924"></a>02924                 {
<a name="l02925"></a>02925                         $values                         = $translator[ $key ];
<a name="l02926"></a>02926                         $origValue                      = <a class="code" href="classtx__srfeuserregister__pi1.html#o13">$dataArr</a>[ $key ];
<a name="l02927"></a>02927 
<a name="l02928"></a>02928                         <span class="keywordflow">if</span> ( ! $decode )
<a name="l02929"></a>02929                         {
<a name="l02930"></a>02930                                 <span class="comment">// invert $values</span>
<a name="l02931"></a>02931                                 $values                 = array_flip( $values );
<a name="l02932"></a>02932                         }
<a name="l02933"></a>02933 
<a name="l02934"></a>02934                         <span class="keywordflow">switch</span>( $key )
<a name="l02935"></a>02935                         {
<a name="l02936"></a>02936                                 <span class="keywordflow">case</span> 'usergroup':
<a name="l02937"></a>02937                                         <span class="comment">// convert 2,9</span>
<a name="l02938"></a>02938                                         <span class="comment">// to Professional, BPM - Chicago</span>
<a name="l02939"></a>02939 
<a name="l02940"></a>02940                                         <span class="comment">// translate the newsletter code 1 to some, 2 thing, etc.</span>
<a name="l02941"></a>02941                                         foreach ( $values as $lkey =&gt; $value )
<a name="l02942"></a>02942                                         {
<a name="l02943"></a>02943                                                 $origValue      = preg_replace( <span class="stringliteral">"#\b$lkey\b#"</span>
<a name="l02944"></a>02944                                                                                 , $value
<a name="l02945"></a>02945                                                                                 , $origValue
<a name="l02946"></a>02946                                                                         );
<a name="l02947"></a>02947                                         }
<a name="l02948"></a>02948 
<a name="l02949"></a>02949                                         <span class="comment">// save as string instead of original array</span>
<a name="l02950"></a>02950                                         <a class="code" href="classtx__srfeuserregister__pi1.html#o13">$dataArr</a>[ $key ]        = $origValue;
<a name="l02951"></a>02951                                         <span class="keywordflow">break</span>;
<a name="l02952"></a>02952 
<a name="l02953"></a>02953                                 <span class="keywordflow">default</span>:
<a name="l02954"></a>02954                                         <a class="code" href="classtx__srfeuserregister__pi1.html#o13">$dataArr</a>[ $key ]        = $values[ $origValue ];
<a name="l02955"></a>02955                                         <span class="keywordflow">break</span>;
<a name="l02956"></a>02956                         }
<a name="l02957"></a>02957                 }
<a name="l02958"></a>02958 
<a name="l02959"></a>02959                 $origArr[ 0 ]                   = <a class="code" href="classtx__srfeuserregister__pi1.html#o13">$dataArr</a>;
<a name="l02960"></a>02960 
<a name="l02961"></a>02961                 <span class="keywordflow">return</span> $origArr;
<a name="l02962"></a>02962         }
<a name="l02963"></a>02963 
<a name="l02964"></a>02964 
<a name="l02974"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a60">02974</a>          function <a class="code" href="classtx__srfeuserregister__pi1.html#a60">upgradeMemberAccess</a>( $uid )
<a name="l02975"></a>02975          {
<a name="l02976"></a>02976                  <span class="keywordflow">if</span> ($this-&gt;debug) echo <span class="stringliteral">"upgradeMemberAccess( $uid )"</span>;
<a name="l02977"></a>02977                  
<a name="l02978"></a>02978                  <span class="keywordflow">if</span> (1 == $this-&gt;memberAccessProcessing) {
<a name="l02979"></a>02979                          
<a name="l02980"></a>02980                          <span class="keywordflow">if</span> ($this-&gt;debug) echo <span class="stringliteral">"Upgrading access"</span>;
<a name="l02981"></a>02981                          
<a name="l02982"></a>02982                          $memberaccess = <span class="keyword">new</span> <a class="code" href="classtx__memberaccess__modfunc1.html">tx_memberaccess_modfunc1</a>; 
<a name="l02983"></a>02983                          $memberaccess-&gt;db = $GLOBALS['TYPO3_DB'];
<a name="l02984"></a>02984                          <span class="keywordflow">if</span> ($this-&gt;debug) {
<a name="l02985"></a>02985                                  $memberaccess-&gt;debug = <span class="keyword">true</span>;
<a name="l02986"></a>02986                                  
<a name="l02987"></a>02987                          }
<a name="l02988"></a>02988                          $memberaccess-&gt;updateFeUserGroups($uid);
<a name="l02989"></a>02989                          
<a name="l02990"></a>02990                  }
<a name="l02991"></a>02991          }
<a name="l02992"></a>02992 
<a name="l03002"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a59">03002</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a59">unsetExpiredField</a>( $uid )
<a name="l03003"></a>03003         {
<a name="l03004"></a>03004                 <span class="comment">// set a flag for complimentary professional group.</span>
<a name="l03005"></a>03005                 $complimentaryProfessionalGroupID = 4; <span class="comment">//from the fe_groups table.</span>
<a name="l03006"></a>03006                 $isComplimentaryProfessionalUserGroup = $this-&gt;dataArr['usergroup'] 
<a name="l03007"></a>03007                                                                         == $complimentaryProfessionalGroupID; 
<a name="l03008"></a>03008 
<a name="l03009"></a>03009                 <span class="comment">//if memberexpiry processing is set on</span>
<a name="l03010"></a>03010                 <span class="comment">//and if the member is renewing a professional or complimentary</span>
<a name="l03011"></a>03011                 <span class="comment">//professional group membership,</span>
<a name="l03012"></a>03012                 <span class="keywordflow">if</span> ((1==$this-&gt;memberExpiryProcessing)
<a name="l03013"></a>03013                         &amp;&amp; (isset($uid))
<a name="l03014"></a>03014                         &amp;&amp; (( preg_match( '#\b' .$this-&gt;conf[ 'paidUsergroup' ] . '\b#'
<a name="l03015"></a>03015                                         , $this-&gt;dataArr[ 'usergroup' ] )
<a name="l03016"></a>03016                                 &amp;&amp; '' != $this-&gt;dataArr[ 'payment_method' ]
<a name="l03017"></a>03017                         ) || $isComplimentaryProfessionalUserGroup )
<a name="l03018"></a>03018                         ) {
<a name="l03019"></a>03019 
<a name="l03020"></a>03020                         $update                         = <span class="stringliteral">"</span>
<a name="l03021"></a>03021 <span class="stringliteral">                                UPDATE fe_users</span>
<a name="l03022"></a>03022 <span class="stringliteral">                                SET tx_memberexpiry_expired = 0</span>
<a name="l03023"></a>03023 <span class="stringliteral">                                WHERE uid = $uid</span>
<a name="l03024"></a>03024 <span class="stringliteral">                        "</span>;
<a name="l03025"></a>03025                         $GLOBALS[ 'TYPO3_DB' ]-&gt;sql(TYPO3_db, $update);
<a name="l03026"></a>03026                         <span class="keywordflow">if</span> ($this-&gt;debug) { 
<a name="l03027"></a>03027                                 echo $GLOBALS[ 'TYPO3_DB' ]-&gt;sql_error();
<a name="l03028"></a>03028                                 echo <span class="stringliteral">"unsetExpiredField( $uid )"</span>;
<a name="l03029"></a>03029                                 echo $update;
<a name="l03030"></a>03030                                 echo '&lt;br&gt;';
<a name="l03031"></a>03031                         }
<a name="l03032"></a>03032                 }
<a name="l03033"></a>03033                 
<a name="l03034"></a>03034         }
<a name="l03035"></a>03035                 
<a name="l03043"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a34">03043</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a34">logRegistrationErrors</a>()
<a name="l03044"></a>03044         {
<a name="l03045"></a>03045 
<a name="l03046"></a>03046                 <span class="comment">/* Query looks like this:</span>
<a name="l03047"></a>03047 <span class="comment">                INSERT INTO tx_memberaccess_registrationerrors( userid, errortime, email, errors )</span>
<a name="l03048"></a>03048 <span class="comment">                VALUES (6464, 1121928502, 'asf@qwerty.com', 'Email, First Name, Last Name, Question1' );</span>
<a name="l03049"></a>03049 <span class="comment">                */</span>
<a name="l03050"></a>03050                 <span class="keywordflow">if</span> ($this-&gt;debug) echo <span class="stringliteral">"logRegistrationErrors()"</span>;
<a name="l03051"></a>03051                 
<a name="l03052"></a>03052                 <span class="comment">//if logging is set on</span>
<a name="l03053"></a>03053                 <span class="keywordflow">if</span> (1==$this-&gt;registrationErrorLogging){
<a name="l03054"></a>03054                         <span class="keywordflow">if</span> ($this-&gt;debug)  <span class="stringliteral">"logging RegistrationErrors"</span>;
<a name="l03055"></a>03055                         
<a name="l03056"></a>03056                         $uid = is_null($this-&gt;dataArr[uid]) || ''==$this-&gt;dataArr[uid] ? <span class="charliteral">'0'</span> : $this-&gt;dataArr[uid] ;
<a name="l03057"></a>03057                         $email = is_null($this-&gt;dataArr[email]) ? '' : $this-&gt;dataArr[email] ;
<a name="l03058"></a>03058                         $errortime = time();
<a name="l03059"></a>03059                         $errors = preg_replace( <span class="stringliteral">"/,/"</span>, ', ', $this-&gt;failure); <span class="comment">//add spaces between the commas</span>
<a name="l03060"></a>03060 
<a name="l03061"></a>03061                         $query                          = <span class="stringliteral">"</span>
<a name="l03062"></a>03062 <span class="stringliteral">                                INSERT INTO tx_memberaccess_registrationerrors( userid, errortime, email, errors )</span>
<a name="l03063"></a>03063 <span class="stringliteral">                                VALUES ('$uid', $errortime, '$email', '$errors' )</span>
<a name="l03064"></a>03064 <span class="stringliteral">                        "</span>;
<a name="l03065"></a>03065                         
<a name="l03066"></a>03066                         <span class="keywordflow">if</span> ($this-&gt;debug) echo $query;
<a name="l03067"></a>03067                         
<a name="l03068"></a>03068                         $GLOBALS[ 'TYPO3_DB' ]-&gt;sql(TYPO3_db, $query);
<a name="l03069"></a>03069                         echo $GLOBALS[ 'TYPO3_DB' ]-&gt;sql_error();
<a name="l03070"></a>03070                 }
<a name="l03071"></a>03071 
<a name="l03072"></a>03072         }
<a name="l03073"></a>03073 
<a name="l03088"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a45">03088</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a45">rectifyUserGroup</a>()
<a name="l03089"></a>03089         {
<a name="l03090"></a>03090                 $currentUserGroupString = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a28">getCurrentUserGroupString</a>();
<a name="l03091"></a>03091                 
<a name="l03092"></a>03092                 $memberaccess = <span class="keyword">new</span> <a class="code" href="classtx__memberaccess__modfunc1.html">tx_memberaccess_modfunc1</a>; 
<a name="l03093"></a>03093                 $memberaccess-&gt;db = $GLOBALS['TYPO3_DB'];
<a name="l03094"></a>03094                 <span class="keywordflow">if</span> ($this-&gt;debug) {
<a name="l03095"></a>03095                         $memberaccess-&gt;debug = <span class="keyword">true</span>;
<a name="l03096"></a>03096                 }
<a name="l03097"></a>03097                 <span class="comment">//Ignore the free/professional/complimentary groups because those are the </span>
<a name="l03098"></a>03098                 <span class="comment">//groups that we want to change, not ones that we want to keep.</span>
<a name="l03099"></a>03099                 $ignoredLevels = '1,2,3,4';
<a name="l03100"></a>03100 
<a name="l03101"></a>03101                 $desiredAccessLevel = $this-&gt;dataArr['usergroup']; 
<a name="l03102"></a>03102                 $newUserGroupString = $memberaccess-&gt;appendAccessLevel($currentUserGroupString, $desiredAccessLevel, $ignoredLevels);
<a name="l03103"></a>03103 
<a name="l03104"></a>03104                 <span class="keywordflow">if</span>($this-&gt;debug) {
<a name="l03105"></a>03105                         echo <span class="stringliteral">"\$currentUserGroupString = $currentUserGroupString \n&lt;br&gt;"</span>;
<a name="l03106"></a>03106                         echo <span class="stringliteral">"\$newUserGroupString = $newUserGroupString \n&lt;br&gt;"</span>;
<a name="l03107"></a>03107                 }
<a name="l03108"></a>03108                 
<a name="l03109"></a>03109                 $this-&gt;dataArr['usergroup'] = $newUserGroupString;
<a name="l03110"></a>03110 
<a name="l03111"></a>03111         }
<a name="l03112"></a>03112 
<a name="l03125"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a58">03125</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a58">testRectifyUserGroup</a>()
<a name="l03126"></a>03126         {
<a name="l03127"></a>03127                 $currentUserGroupString = $this-&gt;<a class="code" href="classtx__srfeuserregister__pi1.html#a28">getCurrentUserGroupString</a>();
<a name="l03128"></a>03128                 
<a name="l03129"></a>03129                 <span class="comment">//function appendAccessLevel($currentAccessLevel, $desiredAccessLevel)</span>
<a name="l03130"></a>03130                 $memberaccess = <span class="keyword">new</span> <a class="code" href="classtx__memberaccess__modfunc1.html">tx_memberaccess_modfunc1</a>; 
<a name="l03131"></a>03131                 $memberaccess-&gt;db = $GLOBALS['TYPO3_DB'];
<a name="l03132"></a>03132                 <span class="keywordflow">if</span> ($this-&gt;debug) {
<a name="l03133"></a>03133                         $memberaccess-&gt;debug = <span class="keyword">true</span>;
<a name="l03134"></a>03134                 }
<a name="l03135"></a>03135                 $desiredAccessLevel = $this-&gt;dataArr['usergroup']; 
<a name="l03136"></a>03136                 $newUserGroupString = $memberaccess-&gt;appendAccessLevel($currentUserGroupString, $desiredAccessLevel);
<a name="l03137"></a>03137 
<a name="l03138"></a>03138                 <span class="keywordflow">if</span>($this-&gt;debug) {
<a name="l03139"></a>03139                         echo <span class="stringliteral">"\$currentUserGroupString = $currentUserGroupString \n&lt;br&gt;"</span>;
<a name="l03140"></a>03140                         echo <span class="stringliteral">"\$newUserGroupString = $newUserGroupString \n&lt;br&gt;"</span>;
<a name="l03141"></a>03141                 }
<a name="l03142"></a>03142                 
<a name="l03143"></a>03143                 $ignoredLevels = '1,2,3,4';
<a name="l03144"></a>03144                 $newUserGroupString = $memberaccess-&gt;appendAccessLevel('1,9,10', $desiredAccessLevel, $ignoredLevels);
<a name="l03145"></a>03145 
<a name="l03146"></a>03146                 <span class="keywordflow">if</span>($this-&gt;debug) {
<a name="l03147"></a>03147                         echo <span class="stringliteral">"\$currentUserGroupString = $currentUserGroupString \n&lt;br&gt;"</span>;
<a name="l03148"></a>03148                         echo <span class="stringliteral">"\$newUserGroupString = $newUserGroupString \n&lt;br&gt;"</span>;
<a name="l03149"></a>03149                 }
<a name="l03150"></a>03150         }
<a name="l03151"></a>03151 
<a name="l03160"></a><a class="code" href="classtx__srfeuserregister__pi1.html#a28">03160</a>         function <a class="code" href="classtx__srfeuserregister__pi1.html#a28">getCurrentUserGroupString</a>()
<a name="l03161"></a>03161         {
<a name="l03162"></a>03162                 <span class="keywordflow">if</span> ($this-&gt;debug) { echo <span class="stringliteral">"getCurrentUserGroupString();\n&lt;br&gt;"</span>; }
<a name="l03163"></a>03163                 
<a name="l03164"></a>03164                 $uid = $this-&gt;dataArr['uid'];
<a name="l03165"></a>03165                 $usergroup = null;
<a name="l03166"></a>03166                 
<a name="l03167"></a>03167                 <span class="keywordflow">if</span> (isset($uid) &amp;&amp; $uid!='') {
<a name="l03168"></a>03168                         $columns = 'usergroup';
<a name="l03169"></a>03169                         $from = 'fe_users';
<a name="l03170"></a>03170                         $where = <span class="stringliteral">"uid = $uid"</span>;
<a name="l03171"></a>03171                         $rows = $this-&gt;db-&gt;exec_SELECTgetRows($columns, $from, $where );
<a name="l03172"></a>03172 
<a name="l03173"></a>03173                         <span class="keywordflow">if</span> (!is_array($rows)) {
<a name="l03174"></a>03174                                 <span class="keywordflow">if</span> ($this-&gt;debug) {
<a name="l03175"></a>03175                                         echo ' $rows not an array';
<a name="l03176"></a>03176                                 }
<a name="l03177"></a>03177                                 $rows=array();
<a name="l03178"></a>03178                         }
<a name="l03179"></a>03179                         
<a name="l03180"></a>03180                         $usergroup = $rows[0]['usergroup'];
<a name="l03181"></a>03181                 }
<a name="l03182"></a>03182                 
<a name="l03183"></a>03183                 <span class="keywordflow">return</span> $usergroup;
<a name="l03184"></a>03184         }
<a name="l03185"></a>03185 
<a name="l03186"></a>03186 
<a name="l03187"></a>03187 
<a name="l03188"></a>03188 }
<a name="l03189"></a>03189  
<a name="l03190"></a>03190 <span class="keywordflow">if</span> (defined(<span class="stringliteral">"TYPO3_MODE"</span>) &amp;&amp; $TYPO3_CONF_VARS[TYPO3_MODE][<span class="stringliteral">"XCLASS"</span>][<span class="stringliteral">"ext/sr_feuser_register/pi1/class.tx_srfeuserregister_pi1.php"</span>]) {
<a name="l03191"></a>03191         include_once($TYPO3_CONF_VARS[TYPO3_MODE][<span class="stringliteral">"XCLASS"</span>][<span class="stringliteral">"ext/sr_feuser_register/pi1/class.tx_srfeuserregister_pi1.php"</span>]);
<a name="l03192"></a>03192 }
<a name="l03193"></a>03193 ?&gt;
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Mon Sep 19 21:00:13 2005 for BPM Membership Access by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.4 </small></address>
</body>
</html>
